<!DOCTYPE html>
<html lang="es-AR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TecniYa - Configuraci√≥n Inicial</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif; }
        body { background: #f8f9fa; color: #333; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        h1 { color: #0a4fd8; margin-bottom: 20px; }
        .btn { background: #0a4fd8; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 1rem; cursor: pointer; transition: background 0.3s; }
        .btn:hover { background: #083bb5; }
        .btn-success { background: #1db954; }
        .btn-success:hover { background: #17a344; }
        .btn-warning { background: #ffc107; color: #333; }
        .btn-warning:hover { background: #e0a800; }
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #c82333; }
        .btn-group { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
        .log { margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px; max-height: 400px; overflow-y: auto; font-family: monospace; }
        .log-entry { margin-bottom: 5px; padding: 5px; border-bottom: 1px solid #eaeaea; }
        .log-success { color: #155724; background: #d4edda; }
        .log-error { color: #721c24; background: #f8d7da; }
        .log-info { color: #0c5460; background: #d1ecf1; }
        .progress-bar { height: 10px; background: #e9ecef; border-radius: 5px; margin: 10px 0; overflow: hidden; }
        .progress-fill { height: 100%; background: #0a4fd8; transition: width 0.3s; }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚öôÔ∏è Configuraci√≥n Inicial de TecniYa</h1>
        <p>Esta p√°gina inicializa la base de datos con datos de ejemplo y configura el sistema de ranking.</p>
        
        <div class="btn-group">
            <button id="initBtn" class="btn">üöÄ Inicializar Base de Datos</button>
            <button id="calcRankingsBtn" class="btn btn-warning">üìä Calcular Rankings</button>
            <button id="setupRankingBtn" class="btn btn-success">üèÜ Configurar Sistema de Ranking</button>
            <button id="clearBtn" class="btn btn-danger">üóëÔ∏è Borrar Datos de Prueba</button>
        </div>
        
        <div id="progressContainer" style="display: none; margin-top: 20px;">
            <div id="progressText" style="margin-bottom: 5px;"></div>
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill" style="width: 0%"></div>
            </div>
        </div>
        
        <div id="log" class="log"></div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyBzDfYDdzmN9J_Y8gG06aqH0OtlzFhafFY",
            authDomain: "tecniya-b4206.firebaseapp.com",
            projectId: "tecniya-b4206",
            storageBucket: "tecniya-b4206.firebasestorage.app",
            messagingSenderId: "166424133304",
            appId: "1:166424133304:web:d1ad23bd4ea1af10437e4d"
        };

        // Initialize
        let db;
        let isInitializing = false;

        document.addEventListener('DOMContentLoaded', async () => {
            await initFirebase();
            
            document.getElementById('initBtn').addEventListener('click', initializeDatabase);
            document.getElementById('calcRankingsBtn').addEventListener('click', calculateAllRankings);
            document.getElementById('setupRankingBtn').addEventListener('click', setupRankingSystem);
            document.getElementById('clearBtn').addEventListener('click', clearTestData);
        });

        async function initFirebase() {
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                db = firebase.firestore();
                log('Firebase inicializado correctamente', 'success');
            } catch (error) {
                log('Error inicializando Firebase: ' + error.message, 'error');
            }
        }

        async function initializeDatabase() {
            if (isInitializing) return;
            isInitializing = true;
            
            showProgress('Iniciando configuraci√≥n...', 0);
            
            try {
                // 1. Create admin user
                showProgress('Creando usuario administrador...', 10);
                await createAdminUser();
                
                // 2. Create system configuration
                showProgress('Configurando sistema...', 20);
                await createSystemConfig();
                
                // 3. Create sample professionals
                showProgress('Creando profesionales de ejemplo...', 30);
                await createSampleProfessionals();
                
                // 4. Create sample ratings
                showProgress('Creando calificaciones de ejemplo...', 60);
                await createSampleRatings();
                
                // 5. Calculate initial rankings
                showProgress('Calculando rankings iniciales...', 80);
                await calculateAllRankings();
                
                showProgress('‚úÖ Configuraci√≥n completada', 100);
                log('‚úÖ Base de datos inicializada correctamente', 'success');
                
            } catch (error) {
                log('‚ùå Error durante la inicializaci√≥n: ' + error.message, 'error');
            } finally {
                isInitializing = false;
                setTimeout(() => {
                    hideProgress();
                }, 2000);
            }
        }

        async function setupRankingSystem() {
            showProgress('Configurando sistema de ranking...', 0);
            
            try {
                // 1. Configuraci√≥n b√°sica del ranking
                showProgress('Configurando par√°metros del ranking...', 20);
                await db.collection('admin_config').doc('ranking').set({
                    minScore: 30,
                    autoFeaturedScore: 85,
                    activeDays: 30,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                
                // 2. Configuraci√≥n de precios
                showProgress('Configurando precios...', 40);
                await db.collection('admin_config').doc('pricing').set({
                    featuredPrice: 9000,
                    certificationPrice: 5000,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                
                // 3. Configuraci√≥n del sistema
                showProgress('Configurando sistema...', 60);
                await db.collection('admin_config').doc('system').set({
                    bannersEnabled: true,
                    newCitiesEnabled: true,
                    autoApproveRatings: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                
                // 4. Recalcular rankings
                showProgress('Recalculando todos los rankings...', 80);
                await calculateAllRankings();
                
                showProgress('‚úÖ Sistema de ranking configurado', 100);
                log('‚úÖ Sistema de ranking configurado correctamente', 'success');
                
            } catch (error) {
                log('‚ùå Error configurando sistema de ranking: ' + error.message, 'error');
            } finally {
                setTimeout(() => {
                    hideProgress();
                }, 2000);
            }
        }

        async function createAdminUser() {
            try {
                const adminData = {
                    email: "admin@tecniya.com",
                    name: "Administrador",
                    role: "superadmin",
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('admin_users').doc('admin').set(adminData);
                log('Usuario administrador creado', 'success');
            } catch (error) {
                log('Error creando admin: ' + error.message, 'error');
            }
        }

        async function createSystemConfig() {
            try {
                const config = {
                    siteName: "TecniYa",
                    siteDescription: "Encontr√° t√©cnicos certificados en toda Argentina",
                    contactEmail: "info@tecniya.com",
                    contactPhone: "3417558966",
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('system_config').doc('general').set(config);
                log('Configuraci√≥n del sistema creada', 'success');
            } catch (error) {
                log('Error creando configuraci√≥n: ' + error.message, 'error');
            }
        }

        async function createSampleProfessionals() {
            const sampleProfessionals = [
                {
                    name: "Juan P√©rez",
                    phone: "3415551234",
                    email: "juan.perez@ejemplo.com",
                    provincia: "Santa Fe",
                    ciudad: "Rosario",
                    rubros: ["plomeria", "gas"],
                    bio: "Plomero matriculado con 15 a√±os de experiencia en instalaciones domiciliarias y comerciales. Especialista en reparaci√≥n de calderas y sistemas de gas.",
                    photoUrl: "https://randomuser.me/api/portraits/men/32.jpg",
                    active: true,
                    profileCompleted: true,
                    isFeatured: true,
                    featuredUntil: new Date(new Date().setMonth(new Date().getMonth() + 3)),
                    certifications: ["Gasista Matriculado", "Plomero Profesional"],
                    completedJobs: 45,
                    avgResponseTime: 4,
                    experienceYears: 15,
                    zonas: ["Centro", "Norte", "Fisherton"],
                    rankingScore: 92,
                    rankingLevel: "Platino",
                    averageRating: 4.8,
                    totalRatings: 12,
                    lastActive: firebase.firestore.FieldValue.serverTimestamp(),
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                },
                {
                    name: "Mar√≠a Garc√≠a",
                    phone: "3415555678",
                    email: "maria.garcia@ejemplo.com",
                    provincia: "Santa Fe",
                    ciudad: "Rosario",
                    rubros: ["electricidad"],
                    bio: "Electricista certificada con 10 a√±os de experiencia. Especialista en instalaciones el√©ctricas domiciliarias y reparaci√≥n de tableros.",
                    photoUrl: "https://randomuser.me/api/portraits/women/44.jpg",
                    active: true,
                    profileCompleted: true,
                    isFeatured: true,
                    featuredUntil: new Date(new Date().setMonth(new Date().getMonth() + 2)),
                    certifications: ["Electricista Certificada"],
                    completedJobs: 32,
                    avgResponseTime: 2,
                    experienceYears: 10,
                    zonas: ["Centro", "Sur", "Alberdi"],
                    rankingScore: 88,
                    rankingLevel: "Oro",
                    averageRating: 4.9,
                    totalRatings: 8,
                    lastActive: firebase.firestore.FieldValue.serverTimestamp(),
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                },
                {
                    name: "Carlos L√≥pez",
                    phone: "3415559012",
                    email: "carlos.lopez@ejemplo.com",
                    provincia: "Buenos Aires",
                    ciudad: "La Plata",
                    rubros: ["aire", "electricidad"],
                    bio: "T√©cnico especializado en aire acondicionado y refrigeraci√≥n. Servicio t√©cnico de todas las marcas.",
                    photoUrl: "https://randomuser.me/api/portraits/men/67.jpg",
                    active: true,
                    profileCompleted: true,
                    isFeatured: false,
                    certifications: ["T√©cnico en Refrigeraci√≥n"],
                    completedJobs: 28,
                    avgResponseTime: 6,
                    experienceYears: 8,
                    zonas: ["Centro", "Este", "Oeste"],
                    rankingScore: 78,
                    rankingLevel: "Plata",
                    averageRating: 4.3,
                    totalRatings: 5,
                    lastActive: firebase.firestore.FieldValue.serverTimestamp(),
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                },
                {
                    name: "Ana Mart√≠nez",
                    phone: "3415553456",
                    email: "ana.martinez@ejemplo.com",
                    provincia: "C√≥rdoba",
                    ciudad: "C√≥rdoba",
                    rubros: ["plomeria", "jardineria"],
                    bio: "Fontanera y jardinera con amplia experiencia. Trabajos de plomer√≠a general y dise√±o de jardines.",
                    photoUrl: "https://randomuser.me/api/portraits/women/68.jpg",
                    active: true,
                    profileCompleted: true,
                    isFeatured: true,
                    featuredUntil: new Date(new Date().setMonth(new Date().getMonth() + 1)),
                    certifications: ["Jardiner√≠a Profesional"],
                    completedJobs: 19,
                    avgResponseTime: 8,
                    experienceYears: 6,
                    zonas: ["Nueva C√≥rdoba", "Centro", "General Paz"],
                    rankingScore: 82,
                    rankingLevel: "Oro",
                    averageRating: 4.7,
                    totalRatings: 6,
                    lastActive: firebase.firestore.FieldValue.serverTimestamp(),
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                },
                {
                    name: "Roberto D√≠az",
                    phone: "3415557890",
                    email: "roberto.diaz@ejemplo.com",
                    provincia: "Mendoza",
                    ciudad: "Mendoza",
                    rubros: ["albanileria", "pintura"],
                    bio: "Alba√±il y pintor con 12 a√±os de experiencia. Trabajos de construcci√≥n en seco y terminaciones.",
                    photoUrl: "https://randomuser.me/api/portraits/men/22.jpg",
                    active: true,
                    profileCompleted: false,
                    isFeatured: false,
                    certifications: [],
                    completedJobs: 15,
                    avgResponseTime: 12,
                    experienceYears: 12,
                    zonas: ["Centro", "Este"],
                    rankingScore: 65,
                    rankingLevel: "Bronce",
                    averageRating: 4.0,
                    totalRatings: 3,
                    lastActive: firebase.firestore.FieldValue.serverTimestamp(),
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                }
            ];
            
            try {
                let count = 0;
                for (const pro of sampleProfessionals) {
                    await db.collection('professionals').add(pro);
                    count++;
                    showProgress(`Creando profesional ${count}/${sampleProfessionals.length}...`, 
                                30 + (count / sampleProfessionals.length * 30));
                }
                log(`${sampleProfessionals.length} profesionales de ejemplo creados`, 'success');
            } catch (error) {
                log('Error creando profesionales: ' + error.message, 'error');
            }
        }

        async function createSampleRatings() {
            try {
                // Obtener profesionales para asignar calificaciones
                const professionalsSnapshot = await db.collection('professionals').limit(5).get();
                const professionals = [];
                professionalsSnapshot.forEach(doc => {
                    professionals.push({ id: doc.id, ...doc.data() });
                });
                
                if (professionals.length === 0) {
                    log('No hay profesionales para asignar calificaciones', 'error');
                    return;
                }
                
                const sampleRatings = [
                    { professionalId: professionals[0].id, rating: 5, comment: "Excelente servicio, muy profesional y puntual", clientPhone: "3415551111" },
                    { professionalId: professionals[0].id, rating: 5, comment: "Resolvi√≥ mi problema de plomer√≠a r√°pidamente", clientPhone: "3415552222" },
                    { professionalId: professionals[0].id, rating: 4, comment: "Buen trabajo, aunque un poco caro", clientPhone: "3415553333" },
                    { professionalId: professionals[0].id, rating: 5, comment: "Muy recomendable, trabajo impecable", clientPhone: "3415554444" },
                    { professionalId: professionals[1].id, rating: 5, comment: "Excelente electricista, muy detallista", clientPhone: "3415555555" },
                    { professionalId: professionals[1].id, rating: 5, comment: "Solucion√≥ un problema complejo de electricidad", clientPhone: "3415556666" },
                    { professionalId: professionals[1].id, rating: 4, comment: "Buen precio y calidad de trabajo", clientPhone: "3415557777" },
                    { professionalId: professionals[2].id, rating: 4, comment: "Instal√≥ mi aire acondicionado perfectamente", clientPhone: "3415558888" },
                    { professionalId: professionals[2].id, rating: 3, comment: "Trabajo aceptable, pero demor√≥ un poco", clientPhone: "3415559999" },
                    { professionalId: professionals[3].id, rating: 5, comment: "Transform√≥ mi jard√≠n, qued√≥ incre√≠ble", clientPhone: "3415550000" },
                    { professionalId: professionals[3].id, rating: 5, comment: "Excelente jardinera, muy creativa", clientPhone: "3415551112" },
                    { professionalId: professionals[4].id, rating: 4, comment: "Buen trabajo de alba√±iler√≠a", clientPhone: "3415551113" },
                    { professionalId: professionals[4].id, rating: 4, comment: "Pint√≥ mi casa, qued√≥ perfecto", clientPhone: "3415551114" }
                ];
                
                let count = 0;
                for (const rating of sampleRatings) {
                    // Crear fecha aleatoria en los √∫ltimos 3 meses
                    const randomDate = new Date();
                    randomDate.setDate(randomDate.getDate() - Math.floor(Math.random() * 90));
                    
                    await db.collection('ratings').add({
                        ...rating,
                        status: 'approved',
                        ipAddress: '127.0.0.1',
                        createdAt: randomDate,
                        approvedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    count++;
                    
                    showProgress(`Creando calificaci√≥n ${count}/${sampleRatings.length}...`, 
                                60 + (count / sampleRatings.length * 20));
                }
                log(`${sampleRatings.length} calificaciones de ejemplo creadas`, 'success');
            } catch (error) {
                log('Error creando calificaciones: ' + error.message, 'error');
            }
        }

        async function calculateAllRankings() {
            log('Calculando rankings de todos los profesionales...', 'info');
            
            try {
                const professionalsSnapshot = await db.collection('professionals').get();
                let count = 0;
                let total = professionalsSnapshot.size;
                
                showProgress('Calculando rankings...', 0);
                
                for (const doc of professionalsSnapshot.docs) {
                    await calculateProfessionalRanking(doc.id);
                    count++;
                    
                    showProgress(`Calculando ranking ${count}/${total}...`, 
                                (count / total * 100));
                }
                
                log(`‚úÖ Rankings calculados para ${count} profesionales`, 'success');
                
            } catch (error) {
                log('‚ùå Error calculando rankings: ' + error.message, 'error');
            } finally {
                setTimeout(() => {
                    hideProgress();
                }, 1000);
            }
        }

        async function calculateProfessionalRanking(professionalId) {
            try {
                // Get professional data
                const professionalDoc = await db.collection('professionals').doc(professionalId).get();
                if (!professionalDoc.exists) return;
                
                const professional = professionalDoc.data();
                
                // Get approved ratings for this professional (last 3 months)
                const threeMonthsAgo = new Date();
                threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
                
                const ratingsSnapshot = await db.collection('ratings')
                    .where('professionalId', '==', professionalId)
                    .where('status', '==', 'approved')
                    .where('createdAt', '>=', threeMonthsAgo)
                    .get();
                
                let totalRatings = 0;
                let sumRatings = 0;
                
                ratingsSnapshot.forEach(doc => {
                    totalRatings++;
                    sumRatings += doc.data().rating;
                });
                
                // Calculate average rating
                const averageRating = totalRatings > 0 ? (sumRatings / totalRatings) : 0;
                
                // ============================================
                // C√ÅLCULO DE PUNTAJE DE RANKING (0-100)
                // ============================================
                let score = 0;
                
                // 1. CALIDAD DE CALIFICACIONES (25 puntos m√°ximo)
                score += averageRating * 5;
                
                // 2. CANTIDAD DE CALIFICACIONES (20 puntos m√°ximo)
                const ratingQuantity = Math.min(totalRatings, 100);
                score += ratingQuantity * 0.2;
                
                // 3. TIEMPO DE RESPUESTA (15 puntos)
                if (professional.avgResponseTime) {
                    if (professional.avgResponseTime < 4) score += 15;
                    else if (professional.avgResponseTime < 8) score += 12;
                    else if (professional.avgResponseTime < 24) score += 8;
                    else if (professional.avgResponseTime < 48) score += 4;
                }
                
                // 4. TRABAJOS COMPLETADOS (10 puntos)
                if (professional.completedJobs) {
                    score += Math.min(professional.completedJobs * 0.1, 10);
                }
                
                // 5. CERTIFICACIONES (10 puntos)
                if (professional.certifications && professional.certifications.length > 0) {
                    score += Math.min(professional.certifications.length * 2, 10);
                }
                
                // 6. COMPLETITUD DEL PERFIL (20 puntos)
                let profileScore = 0;
                if (professional.photoUrl) profileScore += 5;
                if (professional.bio && professional.bio.length > 50) profileScore += 5;
                if (professional.zonas && professional.zonas.length > 0) profileScore += 5;
                if (professional.rubros && professional.rubros.length > 0) profileScore += 5;
                score += profileScore;
                
                // 7. EXPERIENCIA (10 puntos)
                if (professional.experienceYears) {
                    score += Math.min(professional.experienceYears, 10);
                }
                
                // 8. ACTIVIDAD RECIENTE (10 puntos)
                if (professional.lastActive) {
                    const lastActiveDate = professional.lastActive.toDate();
                    const daysSince = (new Date() - lastActiveDate) / (1000 * 60 * 60 * 24);
                    if (daysSince < 7) score += 10;
                    else if (daysSince < 30) score += 7;
                    else if (daysSince < 90) score += 4;
                }
                
                // 9. PERFIL DESTACADO (5 puntos)
                if (professional.isFeatured) {
                    score += 5;
                }
                
                // Asegurar que el score est√© entre 0 y 100
                score = Math.min(Math.max(score, 0), 100);
                const rankingScore = Math.round(score);
                
                // Determinar nivel de ranking
                let rankingLevel = 'Bronce';
                if (rankingScore >= 90) rankingLevel = 'Platino';
                else if (rankingScore >= 80) rankingLevel = 'Oro';
                else if (rankingScore >= 70) rankingLevel = 'Plata';
                else if (rankingScore >= 60) rankingLevel = 'Bronce';
                else rankingLevel = 'Principiante';
                
                // Update professional
                await db.collection('professionals').doc(professionalId).update({
                    averageRating: averageRating,
                    totalRatings: totalRatings,
                    rankingScore: rankingScore,
                    rankingLevel: rankingLevel,
                    rankingUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                return { success: true };
                
            } catch (error) {
                console.error("Error calculating ranking for professional", professionalId, error);
                return { success: false, error: error.message };
            }
        }

        async function clearTestData() {
            if (!confirm('‚ö†Ô∏è ¬øEst√°s seguro de borrar todos los datos de prueba?\n\nEsta acci√≥n NO se puede deshacer.')) return;
            
            showProgress('Eliminando datos de prueba...', 0);
            
            try {
                // Delete all professionals
                const professionalsSnapshot = await db.collection('professionals').get();
                let deleted = 0;
                
                for (const doc of professionalsSnapshot.docs) {
                    await doc.ref.delete();
                    deleted++;
                    showProgress(`Eliminando profesionales... ${deleted}`, 
                                (deleted / professionalsSnapshot.size * 50));
                }
                
                // Delete all ratings
                const ratingsSnapshot = await db.collection('ratings').get();
                deleted = 0;
                
                for (const doc of ratingsSnapshot.docs) {
                    await doc.ref.delete();
                    deleted++;
                    showProgress(`Eliminando calificaciones... ${deleted}`, 
                                50 + (deleted / ratingsSnapshot.size * 50));
                }
                
                showProgress('‚úÖ Todos los datos de prueba eliminados', 100);
                log('‚úÖ Todos los datos de prueba eliminados', 'success');
                
            } catch (error) {
                log('‚ùå Error eliminando datos: ' + error.message, 'error');
            } finally {
                setTimeout(() => {
                    hideProgress();
                }, 2000);
            }
        }

        function showProgress(text, percentage) {
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('progressText').textContent = text;
            document.getElementById('progressFill').style.width = percentage + '%';
        }

        function hideProgress() {
            document.getElementById('progressContainer').style.display = 'none';
        }

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
    </script>
</body>
</html>

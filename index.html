<!DOCTYPE html>
<html lang="es-AR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TecniYa - Encontr√° t√©cnicos en Rosario</title>
    <link rel="manifest" href="manifest.json">
    <!-- Favicon inline para evitar error 404 -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üîß</text></svg>">
    
    <style>
        /* RESET & BASE */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif; }
        body { background-color: #f8f9fa; color: #333; line-height: 1.6; max-width: 100vw; overflow-x: hidden; }
        a { text-decoration: none; color: #0a4fd8; }
        ul { list-style: none; }
        .container { width: 100%; padding: 20px 15px; }

        /* HEADER */
        .header { background: linear-gradient(135deg, #0a4fd8 0%, #1a60f0 100%); color: white; padding: 25px 20px; text-align: center; box-shadow: 0 4px 12px rgba(10, 79, 216, 0.2); }
        .header h1 { font-size: 2.2rem; margin-bottom: 8px; font-weight: 800; }
        .header p { font-size: 1.1rem; opacity: 0.95; }

        /* BANNER */
        .banner-container { margin: 20px auto; max-width: 800px; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        .banner-link { display: block; }
        .banner-img { width: 100%; height: auto; display: block; }

        /* SEARCH */
        .search-card { background: white; border-radius: 16px; padding: 25px; margin: 25px auto; max-width: 800px; box-shadow: 0 6px 20px rgba(0,0,0,0.06); }
        .search-title { font-size: 1.6rem; margin-bottom: 20px; color: #0a4fd8; text-align: center; font-weight: 700; }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-weight: 600; margin-bottom: 8px; color: #444; }
        .form-select { width: 100%; padding: 15px; border: 2px solid #e1e5e9; border-radius: 10px; font-size: 1rem; background-color: white; transition: border 0.3s; }
        .form-select:focus { border-color: #0a4fd8; outline: none; }
        .btn-primary { background-color: #0a4fd8; color: white; border: none; padding: 16px 30px; border-radius: 10px; font-size: 1.1rem; font-weight: 700; width: 100%; cursor: pointer; transition: background 0.3s; }
        .btn-primary:hover { background-color: #083bb5; }
        .btn-secondary { background-color: #1db954; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: background 0.3s; }
        .btn-secondary:hover { background-color: #17a344; }

        /* LOADER */
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid #0a4fd8; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 40px auto; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* PROFESSIONAL LIST */
        .list-container { max-width: 1000px; margin: 0 auto; }
        .professional-card { background: white; border-radius: 16px; padding: 25px; margin-bottom: 25px; box-shadow: 0 6px 18px rgba(0,0,0,0.05); display: flex; flex-direction: column; gap: 20px; }
        @media (min-width: 768px) { .professional-card { flex-direction: row; align-items: center; } }
        .professional-photo { width: 140px; height: 140px; border-radius: 12px; object-fit: cover; flex-shrink: 0; align-self: center; }
        .professional-info { flex-grow: 1; }
        .professional-name { font-size: 1.5rem; color: #0a4fd8; margin-bottom: 6px; font-weight: 700; }
        .professional-badge { display: inline-block; background: linear-gradient(90deg, #ffc107, #ff9800); color: #333; font-size: 0.85rem; font-weight: 700; padding: 5px 12px; border-radius: 20px; margin-left: 10px; }
        .professional-details { margin: 12px 0; color: #555; }
        .professional-details span { background: #f1f6ff; padding: 5px 10px; border-radius: 6px; margin-right: 8px; font-size: 0.9rem; }
        .professional-stats { color: #666; font-size: 0.95rem; }
        .professional-contact { display: flex; justify-content: space-between; align-items: center; }
        .professional-whatsapp { background-color: #1db954; color: white; padding: 12px 24px; border-radius: 8px; font-weight: 700; display: flex; align-items: center; gap: 10px; }
        .professional-whatsapp:hover { background-color: #17a344; }

        /* MESSAGES */
        .message { padding: 20px; border-radius: 12px; margin: 20px 0; text-align: center; font-weight: 600; }
        .message-success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .message-error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .message-info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }

        /* FOOTER */
        .footer { background-color: #333; color: #aaa; text-align: center; padding: 30px 20px; margin-top: 50px; }
        .footer a { color: #aaa; }
        .footer-links { display: flex; justify-content: center; gap: 25px; margin-bottom: 20px; }
    </style>
</head>
<body>
    <!-- HEADER -->
    <header class="header">
        <h1>üë®‚Äçüîß TecniYa</h1>
        <p>Encontr√° t√©cnicos certificados en Rosario. Contacto directo por WhatsApp.</p>
    </header>

    <!-- BANNER -->
    <div id="bannerContainer" class="container banner-container"></div>

    <!-- SEARCH -->
    <section class="container search-card">
        <h2 class="search-title">¬øQu√© servicio necesit√°s?</h2>
        <div class="form-group">
            <label class="form-label">Rubro</label>
            <select id="rubroSelect" class="form-select">
                <option value="">Seleccion√° un rubro</option>
                <option value="plomeria">Plomer√≠a</option>
                <option value="gas">Gas</option>
                <option value="electricidad">Electricidad</option>
                <option value="aire">Aire acondicionado</option>
                <option value="albanileria">Alba√±iler√≠a</option>
                <option value="pintura">Pintura</option>
                <option value="cerrajeria">Cerrajer√≠a</option>
                <option value="otros">Otros</option>
            </select>
        </div>
        <div class="form-group">
            <label class="form-label">Zona de Rosario</label>
            <select id="zonaSelect" class="form-select">
                <option value="">Seleccion√° una zona</option>
                <option value="centro">Centro</option>
                <option value="norte">Norte</option>
                <option value="sur">Sur</option>
                <option value="oeste">Oeste</option>
                <option value="nor_oeste">NorOeste</option>
                <option value="toda">Toda la ciudad</option>
            </select>
        </div>
        <button id="searchBtn" class="btn-primary">üîç Buscar t√©cnico</button>
    </section>

    <!-- LOADER -->
    <div id="loader" class="loader"></div>

    <!-- RESULTS -->
    <section id="resultsContainer" class="container list-container"></section>

    <!-- FOOTER -->
    <footer class="footer">
        <div class="footer-links">
            <a href="profesional.html">Soy Profesional</a>
            <a href="admin.html">Admin</a>
            <a href="#legal">Aviso Legal</a>
        </div>
        <p>¬© 2023 TecniYa - Rosario, Argentina. Contacto directo v√≠a WhatsApp.</p>
        <p><small>No realizamos trabajos. Conectamos clientes con profesionales.</small></p>
    </footer>

    <!-- SCRIPTS DE FIREBASE (IMPORTANTE: NO ELIMINAR) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

    <!-- SCRIPT PRINCIPAL -->
    <script>
        // ============================================
        // CONFIGURACI√ìN FIREBASE - ¬°REEMPLAZAR CON TUS DATOS!
        // ============================================
        const firebaseConfig = {
          apiKey: "AIzaSyBzDfYDdzmN9J_Y8gG06aqH0OtlzFhafFY",
          authDomain: "tecniya-b4206.firebaseapp.com",
          projectId: "tecniya-b4206",
          storageBucket: "tecniya-b4206.firebasestorage.app",
          messagingSenderId: "166424133304",
          appId: "1:166424133304:web:d1ad23bd4ea1af10437e4d"
        };

        // ============================================
        // INICIALIZACI√ìN DE FIREBASE
        // ============================================
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // ============================================
        // ELEMENTOS DOM
        // ============================================
        const bannerContainer = document.getElementById('bannerContainer');
        const rubroSelect = document.getElementById('rubroSelect');
        const zonaSelect = document.getElementById('zonaSelect');
        const searchBtn = document.getElementById('searchBtn');
        const loader = document.getElementById('loader');
        const resultsContainer = document.getElementById('resultsContainer');

        // ============================================
        // FUNCIONES PRINCIPALES - VERSI√ìN CORREGIDA
        // ============================================

        // CARGAR BANNER ACTIVO - VERSI√ìN CORREGIDA (sin error de desigualdades m√∫ltiples)
        async function loadBanner() {
            try {
                const now = new Date();
                const nowTimestamp = firebase.firestore.Timestamp.fromDate(now);
                
                // Consulta corregida: solo una desigualdad
                const bannersSnapshot = await db.collection('banners')
                    .where('active', '==', true)
                    .where('city', '==', 'Rosario')
                    .where('endDate', '>=', nowTimestamp)
                    .orderBy('endDate', 'asc')
                    .limit(5)
                    .get();
                
                if (bannersSnapshot.empty) {
                    bannerContainer.innerHTML = '';
                    return;
                }

                // Filtrar los que tambi√©n tienen startDate <= now
                let activeBanner = null;
                let bannerDocId = null;
                
                bannersSnapshot.forEach(doc => {
                    const banner = doc.data();
                    const startDate = banner.startDate ? banner.startDate.toDate() : null;
                    
                    // Verificar startDate manualmente
                    if (!startDate || startDate <= now) {
                        activeBanner = banner;
                        bannerDocId = doc.id;
                        return;
                    }
                });

                if (activeBanner) {
                    bannerContainer.innerHTML = `
                        <a href="${activeBanner.link}" target="_blank" class="banner-link" onclick="trackClick('${bannerDocId}')">
                            <img src="${activeBanner.imageUrl}" alt="${activeBanner.title}" class="banner-img">
                        </a>
                    `;
                } else {
                    bannerContainer.innerHTML = '';
                }
            } catch (error) {
                console.error("Error cargando banner:", error);
                bannerContainer.innerHTML = '';
            }
        }

        // RASTREAR CLICK EN BANNER
        async function trackClick(bannerId) {
            try {
                await fetch('/.netlify/functions/api/trackClick', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ bannerId, city: 'Rosario' })
                });
            } catch (error) {
                console.error("Error registrando click:", error);
            }
        }

        // BUSCAR PROFESIONALES
        async function searchProfessionals() {
            const rubro = rubroSelect.value;
            const zona = zonaSelect.value;
            
            if (!rubro || !zona) {
                showMessage('Por favor seleccion√° rubro y zona.', 'error');
                return;
            }

            loader.style.display = 'block';
            resultsContainer.innerHTML = '';

            try {
                // CONSULTA BASE: ACTIVOS, CON FOTO, NO BLOQUEADOS, ZONA COINCIDE
                let query = db.collection('professionals')
                    .where('profileCompleted', '==', true)
                    .where('blocked', '==', false)
                    .where('photoUrl', '!=', '')
                    .where('rubros', 'array-contains', rubro);

                if (zona !== 'toda') {
                    query = query.where('zonas', 'array-contains', zona);
                }

                const snapshot = await query.get();
                
                if (snapshot.empty) {
                    showMessage('No se encontraron profesionales para tu b√∫squeda.', 'info');
                    loader.style.display = 'none';
                    return;
                }

                // PROCESAR Y ORDENAR
                const professionals = [];
                const now = new Date();
                
                snapshot.forEach(doc => {
                    const prof = { id: doc.id, ...doc.data() };
                    
                    // CALCULAR PUNTAJE DE RANKING
                    let rankingScore = 0;
                    
                    // RATING
                    rankingScore += (prof.rating || 0) * 5;
                    
                    // TRABAJOS COMPLETADOS
                    rankingScore += (prof.jobsCompleted || 0) * 2;
                    
                    // ACTIVIDAD RECIENTE
                    if (prof.lastActive) {
                        const lastActiveDate = prof.lastActive.toDate();
                        const daysDiff = Math.floor((now - lastActiveDate) / (1000 * 60 * 60 * 24));
                        if (daysDiff <= 7) rankingScore += 3;
                        else if (daysDiff <= 15) rankingScore += 2;
                    }
                    
                    // PERFIL COMPLETO
                    if (prof.profileCompleted) rankingScore += 5;
                    
                    // DESTACADO ACTIVO
                    if (prof.isFeatured && prof.featuredUntil && prof.featuredUntil.toDate() > now) {
                        rankingScore += 1000; // PRIORIDAD M√ÅXIMA
                        prof.isFeaturedActive = true;
                    }
                    
                    prof.rankingScore = rankingScore;
                    professionals.push(prof);
                });

                // ORDENAR: PRIMERO DESTACADOS ACTIVOS, LUEGO POR SCORE
                professionals.sort((a, b) => {
                    if (a.isFeaturedActive && !b.isFeaturedActive) return -1;
                    if (!a.isFeaturedActive && b.isFeaturedActive) return 1;
                    return b.rankingScore - a.rankingScore;
                });

                // MOSTRAR RESULTADOS
                displayProfessionals(professionals);
                
            } catch (error) {
                console.error("Error buscando profesionales:", error);
                showMessage('Error en la b√∫squeda. Intent√° nuevamente.', 'error');
            } finally {
                loader.style.display = 'none';
            }
        }

        // MOSTRAR PROFESIONALES
        function displayProfessionals(professionals) {
            resultsContainer.innerHTML = '';
            
            if (professionals.length === 0) {
                showMessage('No se encontraron profesionales.', 'info');
                return;
            }

            professionals.forEach(prof => {
                const now = new Date();
                const featuredActive = prof.isFeatured && prof.featuredUntil && prof.featuredUntil.toDate() > now;
                
                const card = document.createElement('div');
                card.className = 'professional-card';
                
                card.innerHTML = `
                    <img src="${prof.photoUrl}" alt="${prof.name}" class="professional-photo" onerror="this.src='https://via.placeholder.com/140x140?text=SIN+FOTO'">
                    <div class="professional-info">
                        <h3 class="professional-name">
                            ${prof.name}
                            ${featuredActive ? '<span class="professional-badge">‚≠ê DESTACADO</span>' : ''}
                        </h3>
                        <div class="professional-details">
                            <span>${prof.rubros[0]}</span>
                            <span>${prof.zonas.join(', ')}</span>
                        </div>
                        <div class="professional-stats">
                            ‚≠ê ${prof.rating ? prof.rating.toFixed(1) : 'Nuevo'} 
                            | ‚úÖ ${prof.jobsCompleted || 0} trabajos 
                            | üìÖ ${prof.lastActive ? 'Activo recientemente' : 'Sin actividad'}
                        </div>
                    </div>
                    <div class="professional-contact">
                        <a href="https://wa.me/${prof.phone}?text=Hola ${prof.name.split(' ')[0]}, te contacto desde TecniYa por el servicio de ${rubroSelect.options[rubroSelect.selectedIndex].text}" 
                           target="_blank" class="professional-whatsapp">
                            üì± Contactar por WhatsApp
                        </a>
                    </div>
                `;
                
                resultsContainer.appendChild(card);
            });
        }

        // MOSTRAR MENSAJES
        function showMessage(text, type) {
            const message = document.createElement('div');
            message.className = `message message-${type}`;
            message.textContent = text;
            resultsContainer.innerHTML = '';
            resultsContainer.appendChild(message);
            
            setTimeout(() => {
                message.remove();
            }, 5000);
        }

        // ============================================
        // INICIALIZACI√ìN
        // ============================================
        document.addEventListener('DOMContentLoaded', loadBanner);
        searchBtn.addEventListener('click', searchProfessionals);
        
        // DETECTAR ENTER EN SELECTS
        [rubroSelect, zonaSelect].forEach(select => {
            select.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') searchProfessionals();
            });
        });
    </script>
</body>
</html>

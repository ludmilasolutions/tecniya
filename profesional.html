<!DOCTYPE html>
<html lang="es-AR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TecniYa - Panel del Profesional</title>
    <meta name="description" content="Panel de control para t√©cnicos profesionales. Gestion√° tu perfil, destacados, presupuestos y ranking.">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%230a4fd8'/><text x='50' y='70' text-anchor='middle' font-size='60' fill='white'>üîß</text></svg>">
    
    <!-- Preconnect -->
    <link rel="preconnect" href="https://www.gstatic.com">
    
    <!-- jsPDF para PDFs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- CSS -->
    <style>
        /* ===== VARIABLES & RESET ===== */
        :root {
            --primary: #0a4fd8;
            --primary-dark: #083bb5;
            --secondary: #1db954;
            --secondary-dark: #17a344;
            --accent: #ff9800;
            --danger: #dc3545;
            --warning: #ffc107;
            --info: #17a2b8;
            --light: #f8f9fa;
            --dark: #333;
            --gray: #666;
            --light-gray: #e1e5e9;
            --shadow: 0 4px 12px rgba(10, 79, 216, 0.15);
            --radius: 12px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            color: var(--dark);
            line-height: 1.6;
            min-height: 100vh;
        }
        
        /* ===== LAYOUT ===== */
        .container {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        /* ===== HEADER ===== */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, #1a60f0 100%);
            color: white;
            padding: 1.5rem 1rem;
            position: relative;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .logo-icon {
            font-size: 2rem;
            background: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            box-shadow: var(--shadow);
        }
        
        .logo-text {
            font-size: 1.5rem;
            font-weight: 800;
        }
        
        .user-info {
            text-align: right;
        }
        
        .user-email {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        /* ===== TABS ===== */
        .tabs-container {
            background: white;
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            margin: 2rem auto;
        }
        
        .tabs-header {
            display: flex;
            background: white;
            border-bottom: 2px solid var(--light-gray);
            overflow-x: auto;
            padding: 0 20px;
        }
        
        .tab {
            padding: 1.2rem 1.5rem;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .tab.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
            background-color: #f1f6ff;
        }
        
        .logout-btn {
            margin-left: auto;
            color: var(--danger);
            border-bottom-color: var(--danger) !important;
        }
        
        /* ===== PANELS ===== */
        .panel {
            display: none;
            padding: 2.5rem;
        }
        
        .panel.active {
            display: block;
        }
        
        /* ===== LOGIN ===== */
        .login-container {
            max-width: 500px;
            margin: 4rem auto;
            padding: 2.5rem;
            background: white;
            border-radius: 16px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .login-title {
            font-size: 2rem;
            color: var(--primary);
            margin-bottom: 1.5rem;
            font-weight: 700;
        }
        
        .login-subtitle {
            color: var(--gray);
            margin-bottom: 2rem;
            font-size: 1.1rem;
        }
        
        /* ===== FORMS ===== */
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--dark);
            font-size: 0.95rem;
        }
        
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 1rem;
            border: 2px solid var(--light-gray);
            border-radius: 10px;
            font-size: 1rem;
            background: white;
        }
        
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(10, 79, 216, 0.1);
        }
        
        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }
        
        /* ===== CHECKBOX GROUPS ===== */
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 10px;
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #f8f9fa;
            padding: 14px 18px;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
        }
        
        .checkbox-label input {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        /* ===== PHOTO UPLOAD ===== */
        .photo-section {
            border: 3px dashed var(--light-gray);
            padding: 2.5rem;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .photo-preview {
            width: 200px;
            height: 200px;
            object-fit: cover;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            border: 3px solid white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .photo-url-input {
            max-width: 500px;
            margin: 0 auto;
        }
        
        .photo-info {
            margin-top: 1.5rem;
            padding: 1rem;
            background: #e9f7fe;
            border-radius: 8px;
            border-left: 4px solid var(--primary);
        }
        
        /* ===== BUTTONS ===== */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 1rem 2rem;
            border-radius: 10px;
            font-weight: 600;
            font-size: 1rem;
            border: none;
            cursor: pointer;
            text-decoration: none;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-success {
            background: var(--secondary);
            color: white;
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-warning {
            background: var(--warning);
            color: #333;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }
        
        .btn-group {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            flex-wrap: wrap;
        }
        
        /* ===== STATUS CARDS ===== */
        .status-card {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border-left: 4px solid var(--accent);
        }
        
        .status-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .status-badge {
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 0.9rem;
        }
        
        .status-complete {
            background: #d4edda;
            color: #155724;
        }
        
        .status-incomplete {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-featured {
            background: #ffd700;
            color: #333;
        }
        
        .status-expired {
            background: #f8d7da;
            color: #721c24;
        }
        
        .progress-indicator {
            margin-top: 1rem;
        }
        
        .progress-bar {
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--primary);
            border-radius: 4px;
        }
        
        /* ===== RANKING SECTION ===== */
        .ranking-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .ranking-score {
            font-size: 3rem;
            font-weight: 800;
            color: var(--primary);
        }
        
        .ranking-level {
            font-size: 1.2rem;
            color: var(--gray);
        }
        
        .ranking-badge {
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 0.9rem;
        }
        
        .ranking-platinum {
            background: #e5e4e2;
            color: #333;
        }
        
        .ranking-gold {
            background: #ffd700;
            color: #333;
        }
        
        .ranking-silver {
            background: #c0c0c0;
            color: #333;
        }
        
        .ranking-bronze {
            background: #cd7f32;
            color: white;
        }
        
        .ranking-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .ranking-factor {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .factor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .factor-score {
            font-weight: 700;
            font-size: 1.2rem;
        }
        
        /* ===== STATS SECTION ===== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }
        
        .stat-card {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            color: var(--gray);
            font-size: 0.9rem;
        }
        
        /* ===== RATINGS SECTION ===== */
        .ratings-container {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            margin-bottom: 2rem;
        }
        
        .rating-card {
            padding: 1.5rem;
            border: 1px solid var(--light-gray);
            border-radius: 8px;
            margin-bottom: 1rem;
            background: #f8f9fa;
        }
        
        .rating-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .rating-stars {
            color: var(--warning);
            font-size: 1.2rem;
        }
        
        .rating-date {
            color: var(--gray);
            font-size: 0.9rem;
        }
        
        /* ===== PROFILE FORM ===== */
        .profile-form-section {
            background: white;
            padding: 2.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            margin-bottom: 2rem;
        }
        
        /* ===== FEATURED SECTION ===== */
        .featured-plans {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 2rem 0;
        }
        
        .featured-plan {
            background: white;
            border: 2px solid var(--light-gray);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
        }
        
        .featured-plan.selected {
            border-color: var(--primary);
            background: #f1f6ff;
        }
        
        .featured-plan-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 1rem;
        }
        
        .featured-plan-price {
            font-size: 2.5rem;
            font-weight: 800;
            margin: 1rem 0;
        }
        
        .featured-plan-features {
            list-style: none;
            text-align: left;
            margin: 1.5rem 0;
        }
        
        .featured-plan-features li {
            padding: 0.5rem 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* ===== BUDGETS SECTION ===== */
        .budget-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border-left: 4px solid var(--info);
        }
        
        .budget-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .budget-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .status-draft {
            background: #e2e3e5;
            color: #383d41;
        }
        
        .status-sent {
            background: #cce5ff;
            color: #004085;
        }
        
        .status-accepted {
            background: #d4edda;
            color: #155724;
        }
        
        .status-rejected {
            background: #f8d7da;
            color: #721c24;
        }
        
        .budget-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            border-radius: 16px;
            overflow-y: auto;
            padding: 2rem;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray);
        }
        
        .item-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr auto;
            gap: 1rem;
            align-items: center;
            margin-bottom: 1rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .total-row {
            display: flex;
            justify-content: flex-end;
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 2px solid var(--light-gray);
            font-size: 1.2rem;
            font-weight: 700;
        }
        
        /* ===== MESSAGES ===== */
        .message {
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            font-weight: 600;
        }
        
        .message-success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }
        
        .message-error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }
        
        .message-info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }
        
        /* ===== TABLES ===== */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .data-table th {
            background: #f8f9fa;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid var(--light-gray);
        }
        
        .data-table td {
            padding: 1rem;
            border-bottom: 1px solid var(--light-gray);
        }
        
        /* ===== FILTERS ===== */
        .filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }
        
        .filter-group {
            flex: 1;
            min-width: 200px;
        }
        
        /* ===== LOADER ===== */
        .loader {
            display: none;
            justify-content: center;
            align-items: center;
            padding: 3rem;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
                gap: 1rem;
            }
            
            .tabs-header {
                flex-direction: column;
            }
            
            .tab {
                justify-content: center;
                padding: 1rem;
            }
            
            .logout-btn {
                margin-left: 0;
                margin-top: 1rem;
            }
            
            .panel {
                padding: 1.5rem;
            }
            
            .btn-group {
                flex-direction: column;
            }
            
            .ranking-header {
                flex-direction: column;
                text-align: center;
            }
            
            .photo-preview {
                width: 150px;
                height: 150px;
            }
            
            .item-row {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
            
            .modal-content {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- LOGIN CONTAINER -->
    <div id="loginContainer" class="container login-container">
        <div class="logo" style="justify-content: center; margin-bottom: 1.5rem;">
            <div class="logo-icon">üîß</div>
            <h1 class="logo-text">TecniYa Pro</h1>
        </div>
        
        <h2 class="login-title">Panel del Profesional</h2>
        <p class="login-subtitle">Acced√© a tu cuenta para gestionar tu perfil y servicios</p>
        
        <form id="loginForm">
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" id="loginEmail" class="form-input" 
                       placeholder="tu@email.com" required>
            </div>
            <div class="form-group">
                <label class="form-label">Contrase√±a</label>
                <input type="password" id="loginPassword" class="form-input" 
                       placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required minlength="6">
            </div>
            <button type="submit" class="btn btn-primary btn-block" style="width: 100%; margin-top: 1rem;">
                üîê Ingresar
            </button>
        </form>
        
        <div style="margin-top: 2rem; text-align: center;">
            <p style="color: var(--gray); margin-bottom: 1rem;">¬øNo ten√©s cuenta?</p>
            <button id="toggleRegisterBtn" class="btn btn-secondary">
                üìù Registrarme como Profesional
            </button>
        </div>
        
        <!-- REGISTRO -->
        <div id="registerSection" style="display: none; margin-top: 2rem; padding-top: 2rem; border-top: 2px solid var(--light-gray);">
            <h3 style="color: var(--primary); margin-bottom: 1.5rem; font-size: 1.3rem;">Registro de Profesional</h3>
            
            <form id="registerForm">
                <div class="form-group">
                    <label class="form-label">Nombre completo *</label>
                    <input type="text" id="registerName" class="form-input" 
                           placeholder="Juan P√©rez" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Tel√©fono WhatsApp *</label>
                    <input type="tel" id="registerPhone" class="form-input" 
                           placeholder="5493411234567 (sin +)" required pattern="[0-9]{10,13}">
                    <small style="color: var(--gray); display: block; margin-top: 0.5rem;">
                        Sin +, comenz√° con el c√≥digo de pa√≠s (54 para Argentina)
                    </small>
                </div>
                <div class="form-group">
                    <label class="form-label">Email *</label>
                    <input type="email" id="registerEmail" class="form-input" 
                           placeholder="tu@email.com" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Contrase√±a *</label>
                    <input type="password" id="registerPassword" class="form-input" 
                       placeholder="M√≠nimo 6 caracteres" required minlength="6">
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn btn-success">
                        ‚úÖ Registrarme
                    </button>
                    <button type="button" id="cancelRegisterBtn" class="btn btn-secondary">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
        
        <div id="loginMessage" class="message" style="display: none; margin-top: 1.5rem;"></div>
    </div>
    
    <!-- MAIN PANEL -->
    <div id="mainPanel" style="display: none;">
        <!-- HEADER -->
        <header class="header">
            <div class="container header-content">
                <div class="logo">
                    <div class="logo-icon">üîß</div>
                    <div>
                        <h1 class="logo-text">TecniYa Pro</h1>
                        <div class="user-info">
                            <div class="user-email" id="userEmail"></div>
                            <div id="userStatus" style="font-size: 0.8rem; opacity: 0.8;"></div>
                        </div>
                    </div>
                </div>
                <div>
                    <button id="mainLogoutBtn" class="btn btn-danger">
                        üö™ Cerrar Sesi√≥n
                    </button>
                </div>
            </div>
        </header>
        
        <!-- TABS -->
        <div class="container tabs-container">
            <div class="tabs-header">
                <div class="tab active" data-tab="ranking">
                    üèÜ Ranking
                </div>
                <div class="tab" data-tab="profile">
                    üë§ Perfil
                </div>
                <div class="tab" data-tab="featured">
                    ‚≠ê Destacados
                </div>
                <div class="tab" data-tab="budgets">
                    üí∞ Presupuestos
                </div>
                <div class="tab" data-tab="ratings">
                    ‚≠ê Calificaciones
                </div>
                <div class="tab" data-tab="stats">
                    üìä Estad√≠sticas
                </div>
                <div class="tab logout-btn" id="logoutBtn">
                    üö™ Cerrar Sesi√≥n
                </div>
            </div>
            
            <!-- PANELS -->
            <div class="panels">
                <!-- RANKING PANEL -->
                <div id="rankingPanel" class="panel active">
                    <div class="status-card">
                        <div class="status-header">
                            <h2>üèÜ Mi Ranking Personal</h2>
                            <span id="rankingLevelBadge" class="ranking-badge ranking-bronze">
                                BRONCE
                            </span>
                        </div>
                        
                        <div class="ranking-header">
                            <div>
                                <div class="ranking-score" id="rankingScore">0</div>
                                <div class="ranking-level" id="rankingLevel">Puntaje de 0 a 100</div>
                            </div>
                            <div>
                                <div style="font-size: 1.1rem; color: var(--dark); margin-bottom: 0.5rem;">
                                    üìç <strong id="cityRank">#0</strong> en <span id="rankingCity">Tu Ciudad</span>
                                </div>
                                <div style="font-size: 1.1rem; color: var(--dark);">
                                    ‚≠ê <strong id="rubroRank">#0</strong> en <span id="rankingRubro">Tu Rubro</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="progress-indicator">
                            <div class="progress-bar">
                                <div class="progress-fill" id="rankingProgress" style="width: 0%"></div>
                            </div>
                            <small id="rankingProgressText">0% completado</small>
                        </div>
                    </div>
                    
                    <div class="ranking-details">
                        <div class="ranking-factor">
                            <div class="factor-header">
                                <h4>‚≠ê Calificaciones</h4>
                                <span class="factor-score" id="ratingScore">0/25</span>
                            </div>
                            <p style="color: var(--gray); margin-bottom: 10px;">Basado en promedio y cantidad de calificaciones</p>
                            <div class="progress-bar">
                                <div id="ratingProgress" class="progress-fill" style="width: 0%; background: #ffc107;"></div>
                            </div>
                        </div>
                        
                        <div class="ranking-factor">
                            <div class="factor-header">
                                <h4>üöÄ Respuesta R√°pida</h4>
                                <span class="factor-score" id="responseScore">0/15</span>
                            </div>
                            <p style="color: var(--gray); margin-bottom: 10px;">Tiempo promedio de respuesta a clientes</p>
                            <div class="progress-bar">
                                <div id="responseProgress" class="progress-fill" style="width: 0%; background: #17a2b8;"></div>
                            </div>
                        </div>
                        
                        <div class="ranking-factor">
                            <div class="factor-header">
                                <h4>üìù Perfil Completo</h4>
                                <span class="factor-score" id="profileScore">0/20</span>
                            </div>
                            <p style="color: var(--gray); margin-bottom: 10px;">Foto, descripci√≥n, certificaciones, etc.</p>
                            <div class="progress-bar">
                                <div id="profileProgress" class="progress-fill" style="width: 0%; background: #28a745;"></div>
                            </div>
                        </div>
                        
                        <div class="ranking-factor">
                            <div class="factor-header">
                                <h4>üíº Experiencia</h4>
                                <span class="factor-score" id="experienceScore">0/15</span>
                            </div>
                            <p style="color: var(--gray); margin-bottom: 10px;">A√±os de experiencia y trabajos completados</p>
                            <div class="progress-bar">
                                <div id="experienceProgress" class="progress-fill" style="width: 0%; background: #6f42c1;"></div>
                            </div>
                        </div>
                        
                        <div class="ranking-factor">
                            <div class="factor-header">
                                <h4>‚úÖ Actividad</h4>
                                <span class="factor-score" id="activityScore">0/10</span>
                            </div>
                            <p style="color: var(--gray); margin-bottom: 10px;">√öltima actividad y constancia</p>
                            <div class="progress-bar">
                                <div id="activityProgress" class="progress-fill" style="width: 0%; background: #fd7e14;"></div>
                            </div>
                        </div>
                        
                        <div class="ranking-factor">
                            <div class="factor-header">
                                <h4>üåü Destacado</h4>
                                <span class="factor-score" id="featuredScore">0/5</span>
                            </div>
                            <p style="color: var(--gray); margin-bottom: 10px;">Perfil destacado en la plataforma</p>
                            <div class="progress-bar">
                                <div id="featuredProgress" class="progress-fill" style="width: 0%; background: #ffc107;"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="profile-form-section">
                        <h3>üìà ¬øC√≥mo mejorar mi ranking?</h3>
                        <ul style="margin: 1.5rem 0; padding-left: 1.5rem; color: var(--dark);">
                            <li style="margin-bottom: 0.8rem;"><strong>‚úÖ Complet√° tu perfil:</strong> Foto profesional, descripci√≥n detallada, certificaciones</li>
                            <li style="margin-bottom: 0.8rem;"><strong>üöÄ Responde r√°pido:</strong> Atend√© las consultas en menos de 24 horas</li>
                            <li style="margin-bottom: 0.8rem;"><strong>‚≠ê Ped√≠ calificaciones:</strong> Solicit√° a tus clientes que te califiquen</li>
                            <li style="margin-bottom: 0.8rem;"><strong>üìù Actualiz√° tu experiencia:</strong> Agreg√° a√±os de experiencia y trabajos completados</li>
                            <li style="margin-bottom: 0.8rem;"><strong>üíº Mantenete activo:</strong> Actualiz√° tu perfil regularmente</li>
                            <li style="margin-bottom: 0.8rem;"><strong>üåü Consider√° ser destacado:</strong> Los perfiles destacados tienen +5 puntos</li>
                        </ul>
                        
                        <div class="btn-group">
                            <button onclick="switchTab('profile')" class="btn btn-primary">
                                ‚úèÔ∏è Completar mi perfil
                            </button>
                            <button onclick="recalculateRanking()" class="btn btn-warning">
                                üîÑ Recalcular mi ranking
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- PROFILE PANEL -->
                <div id="profilePanel" class="panel">
                    <div class="status-card">
                        <div class="status-header">
                            <h3>Estado del Perfil</h3>
                            <span id="profileStatus" class="status-badge status-incomplete">
                                INCOMPLETO
                            </span>
                        </div>
                        <p id="statusText">Complet√° tu perfil para aparecer en las b√∫squedas.</p>
                        
                        <div class="progress-indicator">
                            <div class="progress-bar">
                                <div class="progress-fill" id="profileCompleteProgress" style="width: 0%"></div>
                            </div>
                            <small id="completeProgressText">0% completado</small>
                        </div>
                    </div>
                    
                    <form id="profileForm">
                        <div class="form-group">
                            <label class="form-label">Nombre completo *</label>
                            <input type="text" id="profileName" class="form-input" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Tel√©fono WhatsApp *</label>
                            <input type="tel" id="profilePhone" class="form-input" 
                                   placeholder="5493411234567 (sin +)" required pattern="[0-9]{10,13}">
                            <small style="color: var(--gray); display: block; margin-top: 0.5rem;">
                                Los clientes te contactar√°n por este n√∫mero
                            </small>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Provincia *</label>
                            <select id="profileProvincia" class="form-select" required>
                                <option value="">Seleccion√° una provincia</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Ciudad *</label>
                            <select id="profileCiudad" class="form-select" required disabled>
                                <option value="">Seleccion√° una ciudad</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Zonas/Barrios donde trabaj√°s *</label>
                            <input type="text" id="profileZonas" class="form-input" 
                                   placeholder="Ej: Centro, Norte, Oeste (separ√° con comas)" required>
                            <small style="color: var(--gray); display: block; margin-top: 0.5rem;">
                                Escrib√≠ las zonas donde trabaj√°s, separadas por comas
                            </small>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Rubros *</label>
                            <div class="checkbox-group" id="rubrosCheckbox">
                                <label class="checkbox-label">
                                    <input type="checkbox" value="plomeria">
                                    <span>Plomer√≠a</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="gas">
                                    <span>Gas</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="electricidad">
                                    <span>Electricidad</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="aire">
                                    <span>Aire Acondicionado</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="albanileria">
                                    <span>Alba√±iler√≠a</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="pintura">
                                    <span>Pintura</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="cerrajeria">
                                    <span>Cerrajer√≠a</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="jardineria">
                                    <span>Jardiner√≠a</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="herreria">
                                    <span>Herrer√≠a</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="carpinteria">
                                    <span>Carpinter√≠a</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="limpieza">
                                    <span>Limpieza</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="mudanzas">
                                    <span>Mudanzas</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="otros">
                                    <span>Otros servicios</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="photo-section">
                            <img id="photoPreview" class="photo-preview" 
                                 src="https://via.placeholder.com/200x200/0a4fd8/ffffff?text=SIN+FOTO"
                                 alt="Vista previa de foto" 
                                 onerror="this.src='https://via.placeholder.com/200x200/0a4fd8/ffffff?text=ERROR+CARGANDO'">
                            
                            <div class="photo-url-input">
                                <label class="form-label">URL de tu foto profesional *</label>
                                <input type="url" id="photoUrl" class="form-input" 
                                       placeholder="https://ejemplo.com/foto-profesional.jpg" 
                                       pattern="https?://.+" required>
                                <small style="color: var(--gray); display: block; margin-top: 0.5rem;">
                                    La foto debe ser clara y profesional (preferentemente con fondo blanco)
                                </small>
                            </div>
                            
                            <div class="photo-info">
                                <h4>üåü ¬øC√≥mo subir mi foto?</h4>
                                <p style="margin-bottom: 0.5rem;">Servicios gratuitos recomendados:</p>
                                <ul>
                                    <li><a href="https://imgur.com" target="_blank">Imgur.com</a> - Sub√≠ y copia el enlace directo</li>
                                    <li><a href="https://postimages.org" target="_blank">Postimages.org</a> - Simple y r√°pido</li>
                                    <li><a href="https://imgbb.com" target="_blank">ImgBB.com</a> - Sin registro necesario</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Descripci√≥n breve *</label>
                            <textarea id="profileBio" class="form-textarea" 
                                      placeholder="Ej: Especialista en instalaciones el√©ctricas con 10 a√±os de experiencia..."
                                      maxlength="200" required></textarea>
                            <small style="color: var(--gray); display: block; margin-top: 0.5rem;">
                                M√°ximo 200 caracteres. Describ√≠ tu experiencia y especialidades.
                            </small>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">A√±os de experiencia *</label>
                            <input type="number" id="profileExperience" class="form-input" 
                                   min="0" max="50" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Certificaciones (separar con comas)</label>
                            <input type="text" id="profileCertifications" class="form-input" 
                                   placeholder="Ej: Gasista Matriculado, Electricista Certificado">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Trabajos completados (aproximado)</label>
                            <input type="number" id="profileCompletedJobs" class="form-input" 
                                   min="0" value="0">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Tiempo promedio de respuesta (en horas)</label>
                            <input type="number" id="profileResponseTime" class="form-input" 
                                   min="0" placeholder="Ej: 4 (para menos de 4 horas)">
                        </div>
                        
                        <div class="btn-group">
                            <button type="submit" class="btn btn-primary">
                                üíæ Guardar perfil
                            </button>
                            <button type="button" id="updateActivityBtn" class="btn btn-secondary">
                                üîÑ Marcar como activo
                            </button>
                        </div>
                    </form>
                    
                    <div id="profileMessage" class="message" style="display: none; margin-top: 1.5rem;"></div>
                </div>
                
                <!-- FEATURED PANEL -->
                <div id="featuredPanel" class="panel">
                    <div class="status-card">
                        <div class="status-header">
                            <h3>Estado del Destacado</h3>
                            <span id="featuredStatusBadge" class="status-badge status-incomplete">
                                NO DESTACADO
                            </span>
                        </div>
                        
                        <div id="featuredInfo">
                            <p style="color: var(--gray); margin-bottom: 1rem;">
                                Tu perfil no est√° destacado actualmente. Los perfiles destacados aparecen primero en las b√∫squedas.
                            </p>
                        </div>
                        
                        <div class="progress-indicator" id="featuredProgressContainer" style="display: none;">
                            <div class="progress-bar">
                                <div class="progress-fill" id="featuredDaysProgress" style="width: 0%"></div>
                            </div>
                            <small id="featuredDaysText">0 d√≠as restantes</small>
                        </div>
                    </div>
                    
                    <div class="profile-form-section">
                        <h3>üåü Planes de Destacado</h3>
                        <p style="color: var(--gray); margin-bottom: 2rem;">
                            Seleccion√° un plan para destacar tu perfil y aparecer primero en las b√∫squedas.
                        </p>
                        
                        <div class="featured-plans" id="featuredPlansContainer">
                            <!-- Los planes se cargar√°n din√°micamente -->
                        </div>
                        
                        <div class="form-group" style="margin-top: 2rem;">
                            <label class="form-label">M√©todo de Pago *</label>
                            <select id="paymentMethod" class="form-select" required>
                                <option value="">Seleccion√° m√©todo de pago</option>
                                <option value="transferencia">Transferencia Bancaria</option>
                                <option value="mercadopago">Mercado Pago</option>
                                <option value="efectivo">Efectivo</option>
                                <option value="gratis">Gratis (Promoci√≥n/Admin)</option>
                            </select>
                        </div>
                        
                        <div id="paymentDetails" style="display: none; margin-top: 1.5rem; padding: 1.5rem; background: #f8f9fa; border-radius: 8px;">
                            <h4>Detalles del Pago</h4>
                            <div id="transferenciaDetails" style="display: none;">
                                <p><strong>CBU:</strong> 1234567890123456789012</p>
                                <p><strong>Alias:</strong> TECNIYA.DESTACADOS</p>
                                <p><strong>Titular:</strong> TecniYa S.R.L.</p>
                                <p><strong>CUIT:</strong> 30-12345678-9</p>
                                <p>Enviar comprobante a: comprobantes@tecniya.com</p>
                            </div>
                            <div id="mercadopagoDetails" style="display: none;">
                                <p>Ser√°s redirigido a Mercado Pago para completar el pago.</p>
                            </div>
                        </div>
                        
                        <div class="btn-group">
                            <button id="activateFeaturedBtn" class="btn btn-primary" disabled>
                                ‚úÖ Activar Destacado
                            </button>
                            <button id="extendFeaturedBtn" class="btn btn-warning" style="display: none;">
                                üîÑ Extender Destacado
                            </button>
                        </div>
                    </div>
                    
                    <div class="profile-form-section">
                        <h3>üìã Historial de Destacados</h3>
                        <div class="filters">
                            <div class="filter-group">
                                <label class="form-label">Estado</label>
                                <select id="featuredFilterStatus" class="form-select">
                                    <option value="">Todos</option>
                                    <option value="activo">Activos</option>
                                    <option value="expirado">Expirados</option>
                                    <option value="pendiente">Pendientes</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label class="form-label">Desde</label>
                                <input type="date" id="featuredFilterFrom" class="form-input">
                            </div>
                            <div class="filter-group">
                                <label class="form-label">Hasta</label>
                                <input type="date" id="featuredFilterTo" class="form-input">
                            </div>
                            <div class="filter-group">
                                <button id="applyFeaturedFilters" class="btn btn-secondary" style="margin-top: 1.5rem;">
                                    üîç Filtrar
                                </button>
                            </div>
                        </div>
                        
                        <div style="overflow-x: auto;">
                            <table class="data-table" id="featuredHistoryTable">
                                <thead>
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Duraci√≥n</th>
                                        <th>M√©todo</th>
                                        <th>Monto</th>
                                        <th>Estado</th>
                                        <th>Vence</th>
                                    </tr>
                                </thead>
                                <tbody id="featuredHistoryBody">
                                    <!-- Historial se cargar√° aqu√≠ -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- BUDGETS PANEL -->
                <div id="budgetsPanel" class="panel">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h3>üí∞ Mis Presupuestos</h3>
                        <div class="btn-group" style="margin: 0;">
                            <button id="newBudgetBtn" class="btn btn-primary">
                                üìù Nuevo Presupuesto
                            </button>
                            <button id="exportBudgetsBtn" class="btn btn-secondary">
                                üì§ Exportar JSON
                            </button>
                        </div>
                    </div>
                    
                    <div class="profile-form-section">
                        <div class="filters">
                            <div class="filter-group">
                                <label class="form-label">Estado</label>
                                <select id="budgetFilterStatus" class="form-select">
                                    <option value="">Todos</option>
                                    <option value="borrador">Borrador</option>
                                    <option value="enviado">Enviado</option>
                                    <option value="aceptado">Aceptado</option>
                                    <option value="rechazado">Rechazado</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label class="form-label">Cliente</label>
                                <input type="text" id="budgetFilterClient" class="form-input" placeholder="Buscar por cliente">
                            </div>
                            <div class="filter-group">
                                <label class="form-label">Desde</label>
                                <input type="date" id="budgetFilterFrom" class="form-input">
                            </div>
                            <div class="filter-group">
                                <label class="form-label">Hasta</label>
                                <input type="date" id="budgetFilterTo" class="form-input">
                            </div>
                            <div class="filter-group">
                                <button id="applyBudgetFilters" class="btn btn-secondary" style="margin-top: 1.5rem;">
                                    üîç Filtrar
                                </button>
                                <button id="resetBudgetFilters" class="btn btn-danger" style="margin-top: 1.5rem;">
                                    üîÑ Limpiar
                                </button>
                            </div>
                        </div>
                        
                        <div id="budgetsList">
                            <!-- Lista de presupuestos se cargar√° aqu√≠ -->
                        </div>
                    </div>
                </div>
                
                <!-- RATINGS PANEL -->
                <div id="ratingsPanel" class="panel">
                    <div class="ratings-container">
                        <h3>‚≠ê Mis Calificaciones</h3>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin: 1.5rem 0;">
                            <div>
                                <div style="font-size: 2rem; font-weight: 700; color: var(--primary);" id="averageRating">0.0</div>
                                <div style="color: var(--gray);">Rating promedio</div>
                            </div>
                            <div>
                                <div style="font-size: 2rem; font-weight: 700; color: var(--secondary);" id="totalRatingsCount">0</div>
                                <div style="color: var(--gray);">Total de calificaciones</div>
                            </div>
                        </div>
                        
                        <div id="ratingsList">
                            <div style="text-align: center; padding: 2rem; color: var(--gray);">
                                üìù No hay calificaciones a√∫n
                            </div>
                        </div>
                    </div>
                    
                    <div class="profile-form-section">
                        <h3>üìä Distribuci√≥n de Calificaciones</h3>
                        <div id="ratingsDistribution" style="margin-top: 1.5rem;">
                            <!-- Se generar√° din√°micamente -->
                        </div>
                    </div>
                </div>
                
                <!-- STATS PANEL -->
                <div id="statsPanel" class="panel">
                    <h3 style="margin-bottom: 1.5rem; color: var(--primary);">Estad√≠sticas Detalladas</h3>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="statsRanking">0</div>
                            <div class="stat-label">üèÜ Puntaje de ranking</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statsAverageRating">0.0</div>
                            <div class="stat-label">‚≠ê Rating promedio</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statsTotalRatings">0</div>
                            <div class="stat-label">üìù Calificaciones</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statsCompletedJobs">0</div>
                            <div class="stat-label">‚úÖ Trabajos completados</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statsExperience">0</div>
                            <div class="stat-label">üìÖ A√±os de experiencia</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statsResponseTime">0h</div>
                            <div class="stat-label">üöÄ Tiempo de respuesta</div>
                        </div>
                    </div>
                    
                    <div class="profile-form-section">
                        <h3>üìà Historial del Ranking</h3>
                        <div id="rankingHistory" style="margin-top: 1.5rem;">
                            <div style="text-align: center; padding: 2rem; color: var(--gray);">
                                No hay historial de ranking disponible
                            </div>
                        </div>
                    </div>
                    
                    <div class="profile-form-section">
                        <h3>üéØ Comparativa con Promedios</h3>
                        <div id="comparisonStats" style="margin-top: 1.5rem;">
                            <!-- Se generar√° din√°micamente -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- MODAL PARA PRESUPUESTOS -->
    <div id="budgetModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="budgetModalTitle">Nuevo Presupuesto</h3>
                <button class="modal-close" onclick="closeBudgetModal()">&times;</button>
            </div>
            
            <form id="budgetForm">
                <input type="hidden" id="budgetId">
                
                <div class="form-group">
                    <label class="form-label">Cliente (Nombre y Tel√©fono) *</label>
                    <input type="text" id="budgetClient" class="form-input" 
                           placeholder="Ej: Juan P√©rez - 3411234567" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Descripci√≥n del Trabajo *</label>
                    <textarea id="budgetDescription" class="form-textarea" 
                              placeholder="Describ√≠ el trabajo a realizar..." required></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Items del Presupuesto</label>
                    <div id="budgetItems">
                        <!-- Items din√°micos se agregar√°n aqu√≠ -->
                    </div>
                    <button type="button" id="addItemBtn" class="btn btn-secondary">
                        ‚ûï Agregar Item
                    </button>
                </div>
                
                <div id="budgetTotal" class="total-row">
                    Total: $<span id="budgetTotalAmount">0.00</span>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Notas Adicionales</label>
                    <textarea id="budgetNotes" class="form-textarea" 
                              placeholder="Notas adicionales, condiciones de pago, garant√≠a..."></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Estado *</label>
                    <select id="budgetStatus" class="form-select" required>
                        <option value="borrador">Borrador</option>
                        <option value="enviado">Enviado</option>
                        <option value="aceptado">Aceptado</option>
                        <option value="rechazado">Rechazado</option>
                    </select>
                </div>
                
                <div class="btn-group">
                    <button type="submit" class="btn btn-primary">
                        üíæ Guardar Presupuesto
                    </button>
                    <button type="button" id="generatePdfBtn" class="btn btn-success">
                        üìÑ Generar PDF
                    </button>
                    <button type="button" id="sendWhatsAppBtn" class="btn btn-secondary">
                        üí¨ Enviar por WhatsApp
                    </button>
                    <button type="button" onclick="closeBudgetModal()" class="btn btn-danger">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- MODAL PARA VISTA PREVIA PDF -->
    <div id="pdfPreviewModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>Vista Previa del PDF</h3>
                <button class="modal-close" onclick="closePdfPreview()">&times;</button>
            </div>
            <div id="pdfPreviewContent" style="padding: 1rem; background: white; border-radius: 8px;">
                <!-- Vista previa del PDF se generar√° aqu√≠ -->
            </div>
            <div class="btn-group" style="margin-top: 2rem;">
                <button id="downloadPdfBtn" class="btn btn-primary">
                    ‚¨áÔ∏è Descargar PDF
                </button>
                <button id="printPdfBtn" class="btn btn-secondary">
                    üñ®Ô∏è Imprimir
                </button>
                <button onclick="closePdfPreview()" class="btn btn-danger">
                    Cerrar
                </button>
            </div>
        </div>
    </div>
    
    <!-- LOADER GLOBAL -->
    <div id="globalLoader" class="loader">
        <div class="spinner"></div>
    </div>
    
    <!-- FIREBASE -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        // ============================================
        // CONFIGURACI√ìN FIREBASE
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyBzDfYDdzmN9J_Y8gG06aqH0OtlzFhafFY",
            authDomain: "tecniya-b4206.firebaseapp.com",
            projectId: "tecniya-b4206",
            storageBucket: "tecniya-b4206.firebasestorage.app",
            messagingSenderId: "166424133304",
            appId: "1:166424133304:web:d1ad23bd4ea1af10437e4d"
        };

        // ============================================
        // VARIABLES GLOBALES
        // ============================================
        let auth, db, currentUser, professionalId = null, professionalData = null;
        let budgets = [];
        let featuredHistory = [];
        
        // Precios configurados para destacados
        const FEATURED_PRICES = {
            1: { price: 1000, label: "1 mes" },
            3: { price: 2500, label: "3 meses" },
            6: { price: 4500, label: "6 meses" },
            12: { price: 8000, label: "12 meses" }
        };
        
        let selectedFeaturedPlan = null;

        // ============================================
        // INICIALIZACI√ìN
        // ============================================
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Inicializar Firebase solo si no est√° ya inicializado
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                auth = firebase.auth();
                db = firebase.firestore();
                
                // Configurar event listeners
                setupEventListeners();
                
                // Cargar provincias
                loadProvincias();
                
                // Cargar planes destacados
                loadFeaturedPlans();
                
                // Verificar estado de autenticaci√≥n
                checkAuthState();
                
            } catch (error) {
                console.error('Error inicializando:', error);
                showMessage('loginMessage', 'Error al inicializar la aplicaci√≥n', 'error');
            }
        });

        // ============================================
        // SETUP DE EVENT LISTENERS
        // ============================================
        function setupEventListeners() {
            // Login
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('toggleRegisterBtn').addEventListener('click', toggleRegister);
            document.getElementById('cancelRegisterBtn').addEventListener('click', toggleRegister);
            document.getElementById('registerForm').addEventListener('submit', handleRegister);
            
            // Logout
            document.getElementById('mainLogoutBtn')?.addEventListener('click', handleLogout);
            document.getElementById('logoutBtn')?.addEventListener('click', handleLogout);
            
            // Tabs
            document.querySelectorAll('.tab[data-tab]').forEach(tab => {
                tab.addEventListener('click', () => switchTab(tab.dataset.tab));
            });
            
            // Profile form
            document.getElementById('profileForm')?.addEventListener('submit', saveProfile);
            document.getElementById('updateActivityBtn')?.addEventListener('click', updateActivity);
            document.getElementById('photoUrl')?.addEventListener('input', updatePhotoPreview);
            document.getElementById('profileProvincia')?.addEventListener('change', handleProvinciaChange);
            
            // Featured system
            document.getElementById('activateFeaturedBtn')?.addEventListener('click', activateFeatured);
            document.getElementById('extendFeaturedBtn')?.addEventListener('click', extendFeatured);
            document.getElementById('paymentMethod')?.addEventListener('change', showPaymentDetails);
            document.getElementById('applyFeaturedFilters')?.addEventListener('click', loadFeaturedHistory);
            
            // Budgets system
            document.getElementById('newBudgetBtn')?.addEventListener('click', () => openBudgetModal());
            document.getElementById('exportBudgetsBtn')?.addEventListener('click', exportBudgetsToJson);
            document.getElementById('applyBudgetFilters')?.addEventListener('click', loadBudgets);
            document.getElementById('resetBudgetFilters')?.addEventListener('click', resetBudgetFilters);
            document.getElementById('addItemBtn')?.addEventListener('click', addBudgetItem);
            document.getElementById('budgetForm')?.addEventListener('submit', saveBudget);
            document.getElementById('generatePdfBtn')?.addEventListener('click', generateBudgetPdf);
            document.getElementById('sendWhatsAppBtn')?.addEventListener('click', sendBudgetViaWhatsApp);
            document.getElementById('downloadPdfBtn')?.addEventListener('click', downloadBudgetPdf);
            document.getElementById('printPdfBtn')?.addEventListener('click', printBudgetPdf);
        }

        // ============================================
        // AUTENTICACI√ìN
        // ============================================
        function checkAuthState() {
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    currentUser = user;
                    await loadProfessionalProfile();
                    showMainPanel();
                } else {
                    showLoginPanel();
                }
            });
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showMessage('loginMessage', 'Ingres√° email y contrase√±a', 'error');
                return;
            }
            
            showGlobalLoader(true);
            
            try {
                await auth.signInWithEmailAndPassword(email, password);
                showMessage('loginMessage', '‚úÖ Ingreso exitoso', 'success');
            } catch (error) {
                console.error('Error de login:', error);
                let message = 'Error al iniciar sesi√≥n';
                if (error.code === 'auth/user-not-found') message = 'Usuario no encontrado';
                else if (error.code === 'auth/wrong-password') message = 'Contrase√±a incorrecta';
                else if (error.code === 'auth/invalid-email') message = 'Email inv√°lido';
                showMessage('loginMessage', '‚ùå ' + message, 'error');
            } finally {
                showGlobalLoader(false);
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            
            const name = document.getElementById('registerName').value;
            const phone = document.getElementById('registerPhone').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            
            // Validaciones
            if (!name || !phone || !email || !password) {
                showMessage('loginMessage', 'Complet√° todos los campos', 'error');
                return;
            }
            
            if (password.length < 6) {
                showMessage('loginMessage', 'La contrase√±a debe tener al menos 6 caracteres', 'error');
                return;
            }
            
            if (!/^\d{10,13}$/.test(phone)) {
                showMessage('loginMessage', 'Tel√©fono inv√°lido. Ejemplo: 5493411234567', 'error');
                return;
            }
            
            showGlobalLoader(true);
            
            try {
                // Crear usuario
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                
                // Actualizar perfil
                await userCredential.user.updateProfile({ displayName: name });
                
                // Crear documento profesional
                const professionalRef = await db.collection('professionals').add({
                    userId: userCredential.user.uid,
                    email,
                    name,
                    phone,
                    photoUrl: '',
                    bio: '',
                    provincia: '',
                    ciudad: '',
                    zonas: [],
                    rubros: [],
                    certifications: [],
                    experienceYears: 0,
                    completedJobs: 0,
                    avgResponseTime: null,
                    active: true,
                    profileCompleted: false,
                    isFeatured: false,
                    featuredUntil: null,
                    rankingScore: 0,
                    averageRating: 0,
                    totalRatings: 0,
                    lastActive: firebase.firestore.FieldValue.serverTimestamp(),
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                professionalId = professionalRef.id;
                
                showMessage('loginMessage', '‚úÖ Registro exitoso. Ya pod√©s iniciar sesi√≥n.', 'success');
                toggleRegister();
                document.getElementById('registerForm').reset();
                
            } catch (error) {
                console.error('Error en registro:', error);
                let message = 'Error en el registro';
                if (error.code === 'auth/email-already-in-use') message = 'El email ya est√° registrado';
                else if (error.code === 'auth/invalid-email') message = 'Email inv√°lido';
                else if (error.code === 'auth/weak-password') message = 'Contrase√±a demasiado d√©bil';
                showMessage('loginMessage', '‚ùå ' + message, 'error');
            } finally {
                showGlobalLoader(false);
            }
        }

        function handleLogout() {
            if (confirm('¬øEst√°s seguro de querer cerrar sesi√≥n?')) {
                auth.signOut();
            }
        }

        // ============================================
        // INTERFAZ DE USUARIO
        // ============================================
        function showLoginPanel() {
            document.getElementById('loginContainer').style.display = 'block';
            document.getElementById('mainPanel').style.display = 'none';
        }

        function showMainPanel() {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('mainPanel').style.display = 'block';
        }

        function toggleRegister() {
            const registerSection = document.getElementById('registerSection');
            const isVisible = registerSection.style.display === 'block';
            registerSection.style.display = isVisible ? 'none' : 'block';
        }

        function switchTab(tabId) {
            // Remover clase active de todas las pesta√±as
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remover clase active de todos los paneles
            document.querySelectorAll('.panel').forEach(panel => {
                panel.classList.remove('active');
            });
            
            // Activar pesta√±a seleccionada
            const tabElement = document.querySelector(`.tab[data-tab="${tabId}"]`);
            const panelElement = document.getElementById(`${tabId}Panel`);
            
            if (tabElement) tabElement.classList.add('active');
            if (panelElement) panelElement.classList.add('active');
            
            // Cargar datos espec√≠ficos de la pesta√±a
            if (tabId === 'ranking') {
                loadRankingData();
            } else if (tabId === 'featured') {
                loadFeaturedStatus();
                loadFeaturedHistory();
            } else if (tabId === 'budgets') {
                loadBudgets();
            } else if (tabId === 'ratings') {
                loadRatings();
            } else if (tabId === 'stats') {
                loadDetailedStats();
            }
        }

        // ============================================
        // CARGA DE DATOS DEL PROFESIONAL
        // ============================================
        async function loadProfessionalProfile() {
            showGlobalLoader(true);
            
            try {
                // Buscar profesional por userId
                const snapshot = await db.collection('professionals')
                    .where('userId', '==', currentUser.uid)
                    .limit(1)
                    .get();
                
                if (snapshot.empty) {
                    showMessage('loginMessage', 'No se encontr√≥ tu perfil profesional', 'error');
                    return;
                }
                
                const doc = snapshot.docs[0];
                professionalId = doc.id;
                professionalData = { id: doc.id, ...doc.data() };
                
                // Actualizar UI
                updateProfileUI();
                updateUserInfo();
                
                // Cargar datos de ranking
                await loadRankingData();
                
            } catch (error) {
                console.error('Error cargando perfil:', error);
                showMessage('profileMessage', 'Error cargando perfil', 'error');
            } finally {
                showGlobalLoader(false);
            }
        }

        function updateUserInfo() {
            if (!professionalData) return;
            
            document.getElementById('userEmail').textContent = currentUser.email;
            
            const statusEl = document.getElementById('userStatus');
            if (professionalData.profileCompleted) {
                statusEl.textContent = '‚úÖ Perfil completo';
                statusEl.style.color = '#28a745';
            } else {
                statusEl.textContent = '‚ö† Perfil incompleto';
                statusEl.style.color = '#ffc107';
            }
        }

        function updateProfileUI() {
            if (!professionalData) return;
            
            // Datos b√°sicos
            document.getElementById('profileName').value = professionalData.name || '';
            document.getElementById('profilePhone').value = professionalData.phone || '';
            document.getElementById('profileBio').value = professionalData.bio || '';
            document.getElementById('photoUrl').value = professionalData.photoUrl || '';
            document.getElementById('profileExperience').value = professionalData.experienceYears || 0;
            document.getElementById('profileCompletedJobs').value = professionalData.completedJobs || 0;
            document.getElementById('profileResponseTime').value = professionalData.avgResponseTime || '';
            document.getElementById('profileCertifications').value = professionalData.certifications ? professionalData.certifications.join(', ') : '';
            document.getElementById('profileZonas').value = professionalData.zonas ? professionalData.zonas.join(', ') : '';
            
            // Ubicaci√≥n
            if (professionalData.provincia) {
                document.getElementById('profileProvincia').value = professionalData.provincia;
                
                // Cargar ciudades de la provincia
                const ciudades = getCiudadesByProvincia(professionalData.provincia);
                const ciudadSelect = document.getElementById('profileCiudad');
                ciudadSelect.innerHTML = '<option value="">Seleccion√° una ciudad</option>';
                ciudades.forEach(ciudad => {
                    const option = document.createElement('option');
                    option.value = ciudad;
                    option.textContent = ciudad;
                    if (ciudad === professionalData.ciudad) option.selected = true;
                    ciudadSelect.appendChild(option);
                });
                ciudadSelect.disabled = false;
            }
            
            // Rubros seleccionados
            document.querySelectorAll('#rubrosCheckbox input').forEach(checkbox => {
                checkbox.checked = professionalData.rubros && 
                    professionalData.rubros.includes(checkbox.value);
            });
            
            // Actualizar preview de foto
            updatePhotoPreview();
            
            // Estado del perfil
            updateProfileStatus();
        }

        function updateProfileStatus() {
            if (!professionalData) return;
            
            const requiredFields = [
                professionalData.name,
                professionalData.phone,
                professionalData.photoUrl,
                professionalData.provincia,
                professionalData.ciudad,
                professionalData.zonas?.length > 0,
                professionalData.rubros?.length > 0,
                professionalData.bio,
                professionalData.experienceYears
            ];
            
            const completedCount = requiredFields.filter(Boolean).length;
            const totalCount = requiredFields.length;
            const percentage = Math.round((completedCount / totalCount) * 100);
            
            // Actualizar progreso
            document.getElementById('profileCompleteProgress').style.width = `${percentage}%`;
            document.getElementById('completeProgressText').textContent = `${percentage}% completado`;
            
            // Actualizar badge
            const statusEl = document.getElementById('profileStatus');
            const statusText = document.getElementById('statusText');
            
            if (percentage === 100 && professionalData.profileCompleted) {
                statusEl.textContent = 'COMPLETO';
                statusEl.className = 'status-badge status-complete';
                statusText.textContent = 'Tu perfil est√° completo y visible en las b√∫squedas.';
            } else {
                statusEl.textContent = 'INCOMPLETO';
                statusEl.className = 'status-badge status-incomplete';
                const missing = totalCount - completedCount;
                statusText.textContent = `Complet√° ${missing} campo${missing !== 1 ? 's' : ''} m√°s para aparecer en b√∫squedas.`;
            }
        }

        // ============================================
        // SISTEMA DE RANKING - CORREGIDO
        // ============================================
        async function loadRankingData() {
            if (!professionalId) return;
            
            showGlobalLoader(true);
            
            try {
                const doc = await db.collection('professionals').doc(professionalId).get();
                if (!doc.exists) return;
                
                professionalData = { id: doc.id, ...doc.data() };
                
                // Calcular ranking actual
                await calculateRanking();
                updateRankingUI();
                
                // Actualizar estad√≠sticas
                updateUserInfo();
                updateProfileStatus();
                
            } catch (error) {
                console.error('Error cargando ranking:', error);
                showMessage('profileMessage', 'Error cargando datos de ranking', 'error');
            } finally {
                showGlobalLoader(false);
            }
        }

        async function calculateRanking() {
            if (!professionalData) return;
            
            try {
                // Obtener calificaciones aprobadas (√∫ltimos 3 meses)
                const threeMonthsAgo = new Date();
                threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
                
                let totalRatings = 0;
                let sumRatings = 0;
                
                try {
                    const ratingsSnapshot = await db.collection('ratings')
                        .where('professionalId', '==', professionalId)
                        .where('status', '==', 'approved')
                        .where('createdAt', '>=', threeMonthsAgo)
                        .get();
                    
                    ratingsSnapshot.forEach(doc => {
                        totalRatings++;
                        sumRatings += doc.data().rating || 0;
                    });
                } catch (error) {
                    console.log('No se encontraron calificaciones:', error);
                }
                
                // Calcular rating promedio
                const averageRating = totalRatings > 0 ? (sumRatings / totalRatings) : 0;
                
                // ============================================
                // C√ÅLCULO DE PUNTAJE DE RANKING (0-100)
                // ============================================
                let score = 0;
                
                // 1. CALIDAD DE CALIFICACIONES (25 puntos)
                score += averageRating * 5;
                
                // 2. CANTIDAD DE CALIFICACIONES (20 puntos)
                const ratingQuantity = Math.min(totalRatings, 100);
                score += ratingQuantity * 0.2;
                
                // 3. TIEMPO DE RESPUESTA (15 puntos)
                if (professionalData.avgResponseTime) {
                    if (professionalData.avgResponseTime < 4) score += 15;
                    else if (professionalData.avgResponseTime < 8) score += 12;
                    else if (professionalData.avgResponseTime < 24) score += 8;
                    else if (professionalData.avgResponseTime < 48) score += 4;
                }
                
                // 4. TRABAJOS COMPLETADOS (10 puntos)
                if (professionalData.completedJobs) {
                    score += Math.min(professionalData.completedJobs * 0.1, 10);
                }
                
                // 5. CERTIFICACIONES (10 puntos)
                if (professionalData.certifications && professionalData.certifications.length > 0) {
                    score += Math.min(professionalData.certifications.length * 2, 10);
                }
                
                // 6. COMPLETITUD DEL PERFIL (20 puntos)
                let profileScore = 0;
                if (professionalData.photoUrl) profileScore += 5;
                if (professionalData.bio && professionalData.bio.length > 50) profileScore += 5;
                if (professionalData.zonas && professionalData.zonas.length > 0) profileScore += 5;
                if (professionalData.rubros && professionalData.rubros.length > 0) profileScore += 5;
                score += profileScore;
                
                // 7. EXPERIENCIA (10 puntos)
                if (professionalData.experienceYears) {
                    score += Math.min(professionalData.experienceYears, 10);
                }
                
                // 8. ACTIVIDAD RECIENTE (10 puntos)
                if (professionalData.lastActive) {
                    try {
                        const lastActiveDate = professionalData.lastActive.toDate
                            ? professionalData.lastActive.toDate()
                            : new Date(professionalData.lastActive);
                        const daysSince = (new Date() - lastActiveDate) / (1000 * 60 * 60 * 24);
                        if (daysSince < 7) score += 10;
                        else if (daysSince < 30) score += 7;
                        else if (daysSince < 90) score += 4;
                    } catch (error) {
                        console.log('Error calculando actividad:', error);
                    }
                }
                
                // 9. PERFIL DESTACADO (5 puntos)
                if (professionalData.isFeatured) {
                    if (professionalData.featuredUntil) {
                        try {
                            const featuredUntil = professionalData.featuredUntil.toDate
                                ? professionalData.featuredUntil.toDate()
                                : new Date(professionalData.featuredUntil);
                            if (featuredUntil > new Date()) {
                                score += 5;
                            }
                        } catch (error) {
                            console.log('Error verificando destacado:', error);
                        }
                    }
                }
                
                // Asegurar que el score est√© entre 0 y 100
                score = Math.min(Math.max(score, 0), 100);
                const rankingScore = Math.round(score);
                
                // Determinar nivel de ranking
                let rankingLevel = 'Bronce';
                if (rankingScore >= 90) rankingLevel = 'Platino';
                else if (rankingScore >= 80) rankingLevel = 'Oro';
                else if (rankingScore >= 70) rankingLevel = 'Plata';
                else if (rankingScore >= 60) rankingLevel = 'Bronce';
                else rankingLevel = 'Principiante';
                
                // Actualizar professionalData con los nuevos c√°lculos
                professionalData.averageRating = averageRating;
                professionalData.totalRatings = totalRatings;
                professionalData.rankingScore = rankingScore;
                professionalData.rankingLevel = rankingLevel;
                
                // Actualizar en la base de datos
                await db.collection('professionals').doc(professionalId).update({
                    averageRating: averageRating,
                    totalRatings: totalRatings,
                    rankingScore: rankingScore,
                    rankingLevel: rankingLevel,
                    rankingUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                return { averageRating, totalRatings, rankingScore, rankingLevel };
                
            } catch (error) {
                console.error('Error calculando ranking:', error);
                return {
                    averageRating: professionalData.averageRating || 0,
                    totalRatings: professionalData.totalRatings || 0,
                    rankingScore: professionalData.rankingScore || 0,
                    rankingLevel: professionalData.rankingLevel || 'Principiante'
                };
            }
        }

        function updateRankingUI() {
            if (!professionalData) return;
            
            // Actualizar el puntaje total
            document.getElementById('rankingScore').textContent = professionalData.rankingScore || 0;
            document.getElementById('rankingProgress').style.width = `${professionalData.rankingScore || 0}%`;
            document.getElementById('rankingProgressText').textContent = `${professionalData.rankingScore || 0}% completado`;
            
            // Actualizar el nivel
            const levelBadge = document.getElementById('rankingLevelBadge');
            if (levelBadge) {
                levelBadge.textContent = professionalData.rankingLevel ? professionalData.rankingLevel.toUpperCase() : 'BRONCE';
                levelBadge.className = 'ranking-badge ranking-' + (professionalData.rankingLevel ? professionalData.rankingLevel.toLowerCase() : 'bronce');
            }
            
            // Actualizar factores individuales
            // Factor de calificaciones (max 25)
            let ratingFactor = (professionalData.averageRating || 0) * 5;
            if (document.getElementById('ratingScore')) {
                document.getElementById('ratingScore').textContent = `${Math.round(ratingFactor)}/25`;
                document.getElementById('ratingProgress').style.width = `${(ratingFactor / 25) * 100}%`;
            }
            
            // Factor de respuesta (max 15)
            let responseFactor = 0;
            if (professionalData.avgResponseTime) {
                if (professionalData.avgResponseTime < 4) responseFactor = 15;
                else if (professionalData.avgResponseTime < 8) responseFactor = 12;
                else if (professionalData.avgResponseTime < 24) responseFactor = 8;
                else if (professionalData.avgResponseTime < 48) responseFactor = 4;
            }
            if (document.getElementById('responseScore')) {
                document.getElementById('responseScore').textContent = `${responseFactor}/15`;
                document.getElementById('responseProgress').style.width = `${(responseFactor / 15) * 100}%`;
            }
            
            // Factor de perfil (max 20)
            let profileFactor = 0;
            if (professionalData.photoUrl) profileFactor += 5;
            if (professionalData.bio && professionalData.bio.length > 50) profileFactor += 5;
            if (professionalData.zonas && professionalData.zonas.length > 0) profileFactor += 5;
            if (professionalData.rubros && professionalData.rubros.length > 0) profileFactor += 5;
            if (document.getElementById('profileScore')) {
                document.getElementById('profileScore').textContent = `${profileFactor}/20`;
                document.getElementById('profileProgress').style.width = `${(profileFactor / 20) * 100}%`;
            }
            
            // Factor de experiencia (max 15)
            let experienceFactor = Math.min(professionalData.experienceYears || 0, 15);
            if (document.getElementById('experienceScore')) {
                document.getElementById('experienceScore').textContent = `${experienceFactor}/15`;
                document.getElementById('experienceProgress').style.width = `${(experienceFactor / 15) * 100}%`;
            }
            
            // Factor de actividad (max 10)
            let activityFactor = 0;
            if (professionalData.lastActive) {
                try {
                    const lastActiveDate = professionalData.lastActive.toDate
                        ? professionalData.lastActive.toDate()
                        : new Date(professionalData.lastActive);
                    const daysSince = (new Date() - lastActiveDate) / (1000 * 60 * 60 * 24);
                    if (daysSince < 7) activityFactor = 10;
                    else if (daysSince < 30) activityFactor = 7;
                    else if (daysSince < 90) activityFactor = 4;
                } catch (error) {
                    console.log('Error calculando actividad para UI:', error);
                }
            }
            if (document.getElementById('activityScore')) {
                document.getElementById('activityScore').textContent = `${activityFactor}/10`;
                document.getElementById('activityProgress').style.width = `${(activityFactor / 10) * 100}%`;
            }
            
            // Factor de destacado (max 5)
            let featuredFactor = 0;
            if (professionalData.isFeatured && professionalData.featuredUntil) {
                try {
                    const featuredUntil = professionalData.featuredUntil.toDate
                        ? professionalData.featuredUntil.toDate()
                        : new Date(professionalData.featuredUntil);
                    if (featuredUntil > new Date()) {
                        featuredFactor = 5;
                    }
                } catch (error) {
                    console.log('Error verificando destacado para UI:', error);
                }
            }
            if (document.getElementById('featuredScore')) {
                document.getElementById('featuredScore').textContent = `${featuredFactor}/5`;
                document.getElementById('featuredProgress').style.width = `${(featuredFactor / 5) * 100}%`;
            }
            
            // Actualizar ranking en ciudad y rubro (placeholder por ahora)
            if (document.getElementById('cityRank')) {
                document.getElementById('cityRank').textContent = '#0';
                document.getElementById('rankingCity').textContent = professionalData.ciudad || 'Tu Ciudad';
            }
            if (document.getElementById('rubroRank')) {
                document.getElementById('rubroRank').textContent = '#0';
                document.getElementById('rankingRubro').textContent = professionalData.rubros && professionalData.rubros.length > 0 
                    ? professionalData.rubros[0] 
                    : 'Tu Rubro';
            }
        }

        async function recalculateRanking() {
            showGlobalLoader(true);
            
            try {
                await calculateRanking();
                updateRankingUI();
                showMessage('profileMessage', '‚úÖ Ranking recalculado correctamente', 'success');
            } catch (error) {
                console.error('Error recalculando ranking:', error);
                showMessage('profileMessage', 'Error recalculando ranking', 'error');
            } finally {
                showGlobalLoader(false);
            }
        }

        // ============================================
        // SISTEMA DE DESTACADOS
        // ============================================
        function loadFeaturedPlans() {
            const container = document.getElementById('featuredPlansContainer');
            if (!container) return;
            
            let html = '';
            
            Object.entries(FEATURED_PRICES).forEach(([months, data]) => {
                html += `
                    <div class="featured-plan" data-months="${months}" onclick="selectFeaturedPlan(${months})">
                        <div class="featured-plan-title">${data.label}</div>
                        <div class="featured-plan-price">$${data.price}</div>
                        <ul class="featured-plan-features">
                            <li>‚úÖ Aparec√© primero en b√∫squedas</li>
                            <li>‚úÖ Badge especial en tu perfil</li>
                            <li>‚úÖ +5 puntos en el ranking</li>
                            <li>‚úÖ Mayor visibilidad</li>
                            <li>‚úÖ M√°s clientes potenciales</li>
                        </ul>
                        <button class="btn btn-primary btn-sm">
                            Seleccionar
                        </button>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function selectFeaturedPlan(months) {
            // Remover selecci√≥n anterior
            document.querySelectorAll('.featured-plan').forEach(plan => {
                plan.classList.remove('selected');
            });
            
            // Agregar selecci√≥n actual
            const selectedPlan = document.querySelector(`.featured-plan[data-months="${months}"]`);
            if (selectedPlan) {
                selectedPlan.classList.add('selected');
                selectedFeaturedPlan = months;
                document.getElementById('activateFeaturedBtn').disabled = false;
            }
        }

        async function loadFeaturedStatus() {
            if (!professionalId) return;
            
            try {
                const doc = await db.collection('professionals').doc(professionalId).get();
                professionalData = { id: doc.id, ...doc.data() };
                
                const featuredInfo = document.getElementById('featuredInfo');
                const statusBadge = document.getElementById('featuredStatusBadge');
                const progressContainer = document.getElementById('featuredProgressContainer');
                const activateBtn = document.getElementById('activateFeaturedBtn');
                const extendBtn = document.getElementById('extendFeaturedBtn');
                
                if (professionalData.isFeatured && professionalData.featuredUntil) {
                    const now = new Date();
                    const featuredUntil = professionalData.featuredUntil.toDate
                        ? professionalData.featuredUntil.toDate()
                        : new Date(professionalData.featuredUntil);
                    const daysRemaining = Math.ceil((featuredUntil - now) / (1000 * 60 * 60 * 24));
                    
                    if (daysRemaining > 0) {
                        // Destacado activo
                        statusBadge.textContent = 'DESTACADO';
                        statusBadge.className = 'status-badge status-featured';
                        
                        const totalDays = Math.ceil((featuredUntil - (professionalData.featuredSince?.toDate() || featuredUntil)) / (1000 * 60 * 60 * 24));
                        const percentage = Math.round((daysRemaining / totalDays) * 100);
                        
                        featuredInfo.innerHTML = `
                            <p style="color: var(--gray); margin-bottom: 1rem;">
                                Tu perfil est√° destacado y aparece primero en las b√∫squedas.
                            </p>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
                                <div style="text-align: center;">
                                    <div style="font-size: 2rem; font-weight: 700; color: var(--primary);">${daysRemaining}</div>
                                    <div style="color: var(--gray); font-size: 0.9rem;">D√≠as restantes</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 2rem; font-weight: 700; color: var(--secondary);">${featuredUntil.toLocaleDateString('es-AR')}</div>
                                    <div style="color: var(--gray); font-size: 0.9rem;">Vence el</div>
                                </div>
                            </div>
                        `;
                        
                        // Mostrar progreso
                        progressContainer.style.display = 'block';
                        document.getElementById('featuredDaysProgress').style.width = `${percentage}%`;
                        document.getElementById('featuredDaysText').textContent = `${daysRemaining} d√≠as restantes (${percentage}%)`;
                        
                        // Mostrar bot√≥n de extender
                        activateBtn.style.display = 'none';
                        extendBtn.style.display = 'inline-flex';
                        
                    } else {
                        // Destacado expirado
                        statusBadge.textContent = 'EXPIRADO';
                        statusBadge.className = 'status-badge status-expired';
                        featuredInfo.innerHTML = `
                            <p style="color: var(--gray); margin-bottom: 1rem;">
                                Tu destacado ha expirado. Renov√°lo para seguir apareciendo primero.
                            </p>
                        `;
                        progressContainer.style.display = 'none';
                        activateBtn.style.display = 'inline-flex';
                        extendBtn.style.display = 'none';
                    }
                } else {
                    // No destacado
                    statusBadge.textContent = 'NO DESTACADO';
                    statusBadge.className = 'status-badge status-incomplete';
                    featuredInfo.innerHTML = `
                        <p style="color: var(--gray); margin-bottom: 1rem;">
                            Tu perfil no est√° destacado actualmente. Los perfiles destacados aparecen primero en las b√∫squedas.
                        </p>
                    `;
                    progressContainer.style.display = 'none';
                    activateBtn.style.display = 'inline-flex';
                    extendBtn.style.display = 'none';
                }
                
            } catch (error) {
                console.error('Error cargando estado de destacado:', error);
            }
        }

        async function loadFeaturedHistory() {
            if (!professionalId) return;
            
            showGlobalLoader(true);
            
            try {
                let query = db.collection('featuredTransactions')
                    .where('professionalId', '==', professionalId)
                    .orderBy('createdAt', 'desc');
                
                // Aplicar filtros
                const statusFilter = document.getElementById('featuredFilterStatus').value;
                const fromFilter = document.getElementById('featuredFilterFrom').value;
                const toFilter = document.getElementById('featuredFilterTo').value;
                
                if (statusFilter) {
                    query = query.where('status', '==', statusFilter);
                }
                
                if (fromFilter) {
                    const fromDate = new Date(fromFilter);
                    query = query.where('createdAt', '>=', fromDate);
                }
                
                if (toFilter) {
                    const toDate = new Date(toFilter);
                    toDate.setHours(23, 59, 59, 999);
                    query = query.where('createdAt', '<=', toDate);
                }
                
                const snapshot = await query.get();
                const tbody = document.getElementById('featuredHistoryBody');
                
                if (snapshot.empty) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 2rem; color: var(--gray);">
                                No hay transacciones registradas.
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                let html = '';
                featuredHistory = [];
                
                snapshot.forEach(doc => {
                    const transaction = { id: doc.id, ...doc.data() };
                    featuredHistory.push(transaction);
                    
                    const date = transaction.createdAt ? 
                        transaction.createdAt.toDate().toLocaleDateString('es-AR') : '-';
                    const expires = transaction.expiresAt ? 
                        transaction.expiresAt.toDate().toLocaleDateString('es-AR') : '-';
                    
                    let statusBadge = '';
                    switch(transaction.status) {
                        case 'activo':
                            statusBadge = '<span class="status-badge status-complete">ACTIVO</span>';
                            break;
                        case 'expirado':
                            statusBadge = '<span class="status-badge status-expired">EXPIRADO</span>';
                            break;
                        case 'pendiente':
                            statusBadge = '<span class="status-badge" style="background: #fff3cd; color: #856404;">PENDIENTE</span>';
                            break;
                    }
                    
                    html += `
                        <tr>
                            <td>${date}</td>
                            <td>${transaction.duration} meses</td>
                            <td>${transaction.paymentMethod || '-'}</td>
                            <td>$${transaction.amount || '0'}</td>
                            <td>${statusBadge}</td>
                            <td>${expires}</td>
                        </tr>
                    `;
                });
                
                tbody.innerHTML = html;
                
            } catch (error) {
                console.error('Error cargando historial:', error);
                document.getElementById('featuredHistoryBody').innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; color: var(--danger);">
                            ‚ùå Error cargando historial
                        </td>
                    </tr>
                `;
            } finally {
                showGlobalLoader(false);
            }
        }

        async function activateFeatured() {
            if (!selectedFeaturedPlan) {
                showMessage('profileMessage', 'Seleccion√° un plan primero', 'error');
                return;
            }
            
            const paymentMethod = document.getElementById('paymentMethod').value;
            if (!paymentMethod) {
                showMessage('profileMessage', 'Seleccion√° un m√©todo de pago', 'error');
                return;
            }
            
            if (!confirm(`¬øConfirm√°s la activaci√≥n del destacado por ${FEATURED_PRICES[selectedFeaturedPlan].label} por $${FEATURED_PRICES[selectedFeaturedPlan].price}?`)) {
                return;
            }
            
            showGlobalLoader(true);
            
            try {
                // Calcular fechas
                const now = new Date();
                const expiresAt = new Date();
                expiresAt.setMonth(expiresAt.getMonth() + parseInt(selectedFeaturedPlan));
                
                // Crear transacci√≥n
                await db.collection('featuredTransactions').add({
                    professionalId,
                    professionalName: professionalData.name,
                    duration: selectedFeaturedPlan,
                    amount: paymentMethod === 'gratis' ? 0 : FEATURED_PRICES[selectedFeaturedPlan].price,
                    paymentMethod,
                    status: paymentMethod === 'gratis' ? 'activo' : 'pendiente',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    expiresAt: expiresAt
                });
                
                // Actualizar perfil si es gratis
                if (paymentMethod === 'gratis') {
                    await db.collection('professionals').doc(professionalId).update({
                        isFeatured: true,
                        featuredSince: firebase.firestore.FieldValue.serverTimestamp(),
                        featuredUntil: expiresAt
                    });
                    
                    professionalData.isFeatured = true;
                    professionalData.featuredUntil = expiresAt;
                }
                
                // Recargar estado
                await loadFeaturedStatus();
                await loadFeaturedHistory();
                
                showMessage('profileMessage', '‚úÖ Destacado activado correctamente', 'success');
                
                // Resetear selecci√≥n
                selectedFeaturedPlan = null;
                document.getElementById('activateFeaturedBtn').disabled = true;
                document.querySelectorAll('.featured-plan').forEach(plan => {
                    plan.classList.remove('selected');
                });
                
            } catch (error) {
                console.error('Error activando destacado:', error);
                showMessage('profileMessage', 'Error activando destacado', 'error');
            } finally {
                showGlobalLoader(false);
            }
        }

        function extendFeatured() {
            // Similar a activateFeatured pero para extender
            document.getElementById('activateFeaturedBtn').style.display = 'none';
            document.getElementById('extendFeaturedBtn').style.display = 'inline-flex';
            showMessage('profileMessage', 'Seleccion√° un nuevo plan para extender tu destacado', 'info');
        }

        function showPaymentDetails() {
            const method = document.getElementById('paymentMethod').value;
            const details = document.getElementById('paymentDetails');
            const transferencia = document.getElementById('transferenciaDetails');
            const mercadopago = document.getElementById('mercadopagoDetails');
            
            if (!method) {
                details.style.display = 'none';
                return;
            }
            
            details.style.display = 'block';
            transferencia.style.display = method === 'transferencia' ? 'block' : 'none';
            mercadopago.style.display = method === 'mercadopago' ? 'block' : 'none';
        }

        // ============================================
        // SISTEMA DE PRESUPUESTOS
        // ============================================
        async function loadBudgets() {
            if (!professionalId) return;
            
            showGlobalLoader(true);
            
            try {
                let query = db.collection('budgets')
                    .where('professionalId', '==', professionalId)
                    .orderBy('createdAt', 'desc');
                
                // Aplicar filtros
                const statusFilter = document.getElementById('budgetFilterStatus').value;
                const clientFilter = document.getElementById('budgetFilterClient').value;
                const fromFilter = document.getElementById('budgetFilterFrom').value;
                const toFilter = document.getElementById('budgetFilterTo').value;
                
                if (statusFilter) {
                    query = query.where('status', '==', statusFilter);
                }
                
                if (clientFilter) {
                    query = query.where('client', '>=', clientFilter)
                               .where('client', '<=', clientFilter + '\uf8ff');
                }
                
                if (fromFilter) {
                    const fromDate = new Date(fromFilter);
                    query = query.where('createdAt', '>=', fromDate);
                }
                
                if (toFilter) {
                    const toDate = new Date(toFilter);
                    toDate.setHours(23, 59, 59, 999);
                    query = query.where('createdAt', '<=', toDate);
                }
                
                const snapshot = await query.get();
                budgets = [];
                const container = document.getElementById('budgetsList');
                
                if (snapshot.empty) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: var(--gray);">
                            üìù No hay presupuestos creados.
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                
                snapshot.forEach(doc => {
                    const budget = { id: doc.id, ...doc.data() };
                    budgets.push(budget);
                    
                    const date = budget.createdAt ? 
                        budget.createdAt.toDate().toLocaleDateString('es-AR') : '-';
                    
                    let statusBadge = '';
                    switch(budget.status) {
                        case 'borrador':
                            statusBadge = '<span class="budget-status status-draft">BORRADOR</span>';
                            break;
                        case 'enviado':
                            statusBadge = '<span class="budget-status status-sent">ENVIADO</span>';
                            break;
                        case 'aceptado':
                            statusBadge = '<span class="budget-status status-accepted">ACEPTADO</span>';
                            break;
                        case 'rechazado':
                            statusBadge = '<span class="budget-status status-rejected">RECHAZADO</span>';
                            break;
                    }
                    
                    html += `
                        <div class="budget-card">
                            <div class="budget-header">
                                <div>
                                    <h4 style="margin: 0;">${budget.client || 'Sin cliente'}</h4>
                                    <p style="color: var(--gray); margin: 0.5rem 0;">${date}</p>
                                </div>
                                <div>
                                    ${statusBadge}
                                    <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary); margin-top: 0.5rem;">
                                        $${budget.total || '0'}
                                    </div>
                                </div>
                            </div>
                            <p style="color: var(--dark); margin-bottom: 1rem;">${budget.description || ''}</p>
                            <div class="budget-actions">
                                <button onclick="editBudget('${doc.id}')" class="btn btn-primary btn-sm">
                                    ‚úèÔ∏è Editar
                                </button>
                                <button onclick="generateBudgetPdf('${doc.id}')" class="btn btn-secondary btn-sm">
                                    üìÑ PDF
                                </button>
                                <button onclick="sendBudgetViaWhatsApp('${doc.id}')" class="btn btn-success btn-sm">
                                    üí¨ WhatsApp
                                </button>
                                <button onclick="deleteBudget('${doc.id}')" class="btn btn-danger btn-sm">
                                    üóëÔ∏è Eliminar
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
                
            } catch (error) {
                console.error('Error cargando presupuestos:', error);
                document.getElementById('budgetsList').innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--danger);">
                        ‚ùå Error cargando presupuestos
                    </div>
                `;
            } finally {
                showGlobalLoader(false);
            }
        }

        function resetBudgetFilters() {
            document.getElementById('budgetFilterStatus').value = '';
            document.getElementById('budgetFilterClient').value = '';
            document.getElementById('budgetFilterFrom').value = '';
            document.getElementById('budgetFilterTo').value = '';
            loadBudgets();
        }

        function openBudgetModal(budgetId = null) {
            const modal = document.getElementById('budgetModal');
            const title = document.getElementById('budgetModalTitle');
            const form = document.getElementById('budgetForm');
            
            if (budgetId) {
                // Editar presupuesto existente
                const budget = budgets.find(b => b.id === budgetId);
                if (budget) {
                    title.textContent = 'Editar Presupuesto';
                    document.getElementById('budgetId').value = budgetId;
                    document.getElementById('budgetClient').value = budget.client || '';
                    document.getElementById('budgetDescription').value = budget.description || '';
                    document.getElementById('budgetNotes').value = budget.notes || '';
                    document.getElementById('budgetStatus').value = budget.status || 'borrador';
                    
                    // Cargar items
                    const itemsContainer = document.getElementById('budgetItems');
                    itemsContainer.innerHTML = '';
                    if (budget.items && budget.items.length > 0) {
                        budget.items.forEach(item => {
                            addBudgetItem(item);
                        });
                    } else {
                        addBudgetItem();
                    }
                    
                    updateBudgetTotal();
                }
            } else {
                // Nuevo presupuesto
                title.textContent = 'Nuevo Presupuesto';
                form.reset();
                document.getElementById('budgetId').value = '';
                document.getElementById('budgetItems').innerHTML = '';
                addBudgetItem();
                updateBudgetTotal();
            }
            
            modal.style.display = 'flex';
        }

        function closeBudgetModal() {
            document.getElementById('budgetModal').style.display = 'none';
        }

        function addBudgetItem(itemData = null) {
            const container = document.getElementById('budgetItems');
            const itemId = Date.now() + Math.random();
            
            const itemHtml = `
                <div class="item-row" id="item-${itemId}">
                    <input type="text" class="form-input item-description" 
                           placeholder="Descripci√≥n" value="${itemData?.description || ''}" 
                           oninput="updateBudgetTotal()">
                    <input type="number" class="form-input item-quantity" 
                           placeholder="Cantidad" min="1" value="${itemData?.quantity || 1}" 
                           oninput="updateBudgetTotal()">
                    <input type="number" class="form-input item-price" 
                           placeholder="Precio unitario" step="0.01" min="0" 
                           value="${itemData?.price || 0}" oninput="updateBudgetTotal()">
                    <input type="text" class="form-input item-total" 
                           placeholder="Total" readonly value="${itemData?.total || '0.00'}">
                    <button type="button" class="btn btn-danger btn-sm" 
                            onclick="removeBudgetItem('${itemId}')">üóëÔ∏è</button>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', itemHtml);
            updateBudgetTotal();
        }

        function removeBudgetItem(itemId) {
            const item = document.getElementById(`item-${itemId}`);
            if (item) {
                item.remove();
                updateBudgetTotal();
            }
        }

        function updateBudgetTotal() {
            let total = 0;
            document.querySelectorAll('.item-row').forEach(row => {
                const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
                const price = parseFloat(row.querySelector('.item-price').value) || 0;
                const itemTotal = quantity * price;
                
                row.querySelector('.item-total').value = itemTotal.toFixed(2);
                total += itemTotal;
            });
            
            document.getElementById('budgetTotalAmount').textContent = total.toFixed(2);
        }

        async function saveBudget(e) {
            e.preventDefault();
            
            // Recolectar items
            const items = [];
            document.querySelectorAll('.item-row').forEach(row => {
                const description = row.querySelector('.item-description').value;
                const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
                const price = parseFloat(row.querySelector('.item-price').value) || 0;
                const total = quantity * price;
                
                if (description) {
                    items.push({
                        description,
                        quantity,
                        price,
                        total
                    });
                }
            });
            
            if (items.length === 0) {
                showMessage('profileMessage', 'Agreg√° al menos un item al presupuesto', 'error');
                return;
            }
            
            const budgetData = {
                professionalId,
                professionalName: professionalData.name,
                client: document.getElementById('budgetClient').value,
                description: document.getElementById('budgetDescription').value,
                items,
                notes: document.getElementById('budgetNotes').value,
                status: document.getElementById('budgetStatus').value,
                total: parseFloat(document.getElementById('budgetTotalAmount').textContent),
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            showGlobalLoader(true);
            
            try {
                const budgetId = document.getElementById('budgetId').value;
                
                if (budgetId) {
                    // Actualizar presupuesto existente
                    await db.collection('budgets').doc(budgetId).update(budgetData);
                    showMessage('profileMessage', '‚úÖ Presupuesto actualizado correctamente', 'success');
                } else {
                    // Crear nuevo presupuesto
                    await db.collection('budgets').add(budgetData);
                    showMessage('profileMessage', '‚úÖ Presupuesto creado correctamente', 'success');
                }
                
                closeBudgetModal();
                loadBudgets();
                
            } catch (error) {
                console.error('Error guardando presupuesto:', error);
                showMessage('profileMessage', 'Error guardando presupuesto', 'error');
            } finally {
                showGlobalLoader(false);
            }
        }

        async function deleteBudget(budgetId) {
            if (!confirm('¬øEst√°s seguro de querer eliminar este presupuesto?')) return;
            
            showGlobalLoader(true);
            
            try {
                await db.collection('budgets').doc(budgetId).delete();
                showMessage('profileMessage', '‚úÖ Presupuesto eliminado correctamente', 'success');
                loadBudgets();
            } catch (error) {
                console.error('Error eliminando presupuesto:', error);
                showMessage('profileMessage', 'Error eliminando presupuesto', 'error');
            } finally {
                showGlobalLoader(false);
            }
        }

        function editBudget(budgetId) {
            openBudgetModal(budgetId);
        }

        function generateBudgetPdf(budgetId = null) {
            let budget;
            
            if (budgetId) {
                // Generar PDF de presupuesto espec√≠fico
                budget = budgets.find(b => b.id === budgetId);
                if (!budget) return;
            } else {
                // Generar PDF del presupuesto actual en el modal
                const client = document.getElementById('budgetClient').value;
                const description = document.getElementById('budgetDescription').value;
                const notes = document.getElementById('budgetNotes').value;
                const total = document.getElementById('budgetTotalAmount').textContent;
                
                // Recolectar items
                const items = [];
                document.querySelectorAll('.item-row').forEach(row => {
                    const description = row.querySelector('.item-description').value;
                    const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
                    const price = parseFloat(row.querySelector('.item-price').value) || 0;
                    const total = quantity * price;
                    
                    if (description) {
                        items.push({ description, quantity, price, total });
                    }
                });
                
                budget = {
                    client,
                    description,
                    items,
                    notes,
                    total,
                    createdAt: new Date(),
                    professionalName: professionalData.name
                };
            }
            
            // Crear contenido HTML para el PDF
            const pdfContent = document.createElement('div');
            pdfContent.style.padding = '20px';
            pdfContent.style.fontFamily = 'Arial, sans-serif';
            
            const date = budget.createdAt?.toDate ? 
                budget.createdAt.toDate().toLocaleDateString('es-AR') : 
                new Date().toLocaleDateString('es-AR');
            
            pdfContent.innerHTML = `
                <h1 style="color: #0a4fd8; text-align: center;">PRESUPUESTO</h1>
                <div style="margin-bottom: 30px;">
                    <p><strong>Profesional:</strong> ${budget.professionalName || professionalData.name}</p>
                    <p><strong>Cliente:</strong> ${budget.client}</p>
                    <p><strong>Fecha:</strong> ${date}</p>
                    <p><strong>Descripci√≥n:</strong> ${budget.description}</p>
                </div>
                
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">
                    <thead>
                        <tr style="background: #f8f9fa;">
                            <th style="border: 1px solid #ddd; padding: 10px; text-align: left;">Descripci√≥n</th>
                            <th style="border: 1px solid #ddd; padding: 10px; text-align: center;">Cantidad</th>
                            <th style="border: 1px solid #ddd; padding: 10px; text-align: right;">Precio Unit.</th>
                            <th style="border: 1px solid #ddd; padding: 10px; text-align: right;">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${budget.items.map(item => `
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 10px;">${item.description}</td>
                                <td style="border: 1px solid #ddd; padding: 10px; text-align: center;">${item.quantity}</td>
                                <td style="border: 1px solid #ddd; padding: 10px; text-align: right;">$${item.price.toFixed(2)}</td>
                                <td style="border: 1px solid #ddd; padding: 10px; text-align: right;">$${item.total.toFixed(2)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                    <tfoot>
                        <tr style="background: #f8f9fa; font-weight: bold;">
                            <td colspan="3" style="border: 1px solid #ddd; padding: 10px; text-align: right;">TOTAL:</td>
                            <td style="border: 1px solid #ddd; padding: 10px; text-align: right;">$${parseFloat(budget.total).toFixed(2)}</td>
                        </tr>
                    </tfoot>
                </table>
                
                ${budget.notes ? `
                <div style="margin-bottom: 30px;">
                    <h3>Notas:</h3>
                    <p>${budget.notes}</p>
                </div>
                ` : ''}
                
                <div style="margin-top: 50px; padding-top: 20px; border-top: 2px solid #0a4fd8;">
                    <p style="text-align: center; color: #666;">
                        Presupuesto v√°lido por 30 d√≠as.<br>
                        Contacto: ${professionalData.phone} | ${professionalData.email}
                    </p>
                </div>
            `;
            
            // Mostrar vista previa
            document.getElementById('pdfPreviewContent').innerHTML = '';
            document.getElementById('pdfPreviewContent').appendChild(pdfContent);
            document.getElementById('pdfPreviewModal').style.display = 'flex';
            
            // Guardar referencia al budget para la descarga
            window.currentPdfBudget = budget;
        }

        function closePdfPreview() {
            document.getElementById('pdfPreviewModal').style.display = 'none';
        }

        function downloadBudgetPdf() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Obtener contenido HTML
            const content = document.getElementById('pdfPreviewContent');
            
            // Generar PDF
            doc.html(content, {
                callback: function(doc) {
                    doc.save(`Presupuesto-${window.currentPdfBudget.client}-${new Date().getTime()}.pdf`);
                },
                margin: [10, 10, 10, 10],
                autoPaging: 'text',
                x: 0,
                y: 0,
                width: 190,
                windowWidth: 800
            });
        }

        function printBudgetPdf() {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Presupuesto - ${window.currentPdfBudget.client}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th, td { border: 1px solid #ddd; padding: 10px; }
                        th { background: #f8f9fa; }
                        .total { font-weight: bold; background: #f8f9fa; }
                        @media print {
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    ${document.getElementById('pdfPreviewContent').innerHTML}
                    <div class="no-print" style="margin-top: 30px; text-align: center;">
                        <button onclick="window.print()" style="padding: 10px 20px; background: #0a4fd8; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            üñ®Ô∏è Imprimir
                        </button>
                        <button onclick="window.close()" style="padding: 10px 20px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer; margin-left: 10px;">
                            Cerrar
                        </button>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        function sendBudgetViaWhatsApp(budgetId = null) {
            let budget;
            
            if (budgetId) {
                budget = budgets.find(b => b.id === budgetId);
            } else {
                budget = window.currentPdfBudget;
            }
            
            if (!budget) {
                showMessage('profileMessage', 'No hay presupuesto para enviar', 'error');
                return;
            }
            
            // Extraer tel√©fono del cliente
            let phone = '';
            const clientText = budget.client || '';
            const phoneMatch = clientText.match(/\d{10,13}/);
            if (phoneMatch) {
                phone = phoneMatch[0];
            }
            
            if (!phone) {
                showMessage('profileMessage', 'No se encontr√≥ tel√©fono en los datos del cliente', 'error');
                return;
            }
            
            // Crear mensaje
            const date = budget.createdAt?.toDate ? 
                budget.createdAt.toDate().toLocaleDateString('es-AR') : 
                new Date().toLocaleDateString('es-AR');
            
            let message = `*PRESUPUESTO - ${budget.professionalName || professionalData.name}*\n\n`;
            message += `*Cliente:* ${budget.client}\n`;
            message += `*Fecha:* ${date}\n`;
            message += `*Descripci√≥n:* ${budget.description}\n\n`;
            message += `*ITEMS:*\n`;
            
            budget.items.forEach((item, index) => {
                message += `${index + 1}. ${item.description} - ${item.quantity} x $${item.price} = $${item.total}\n`;
            });
            
            message += `\n*TOTAL: $${parseFloat(budget.total).toFixed(2)}*\n\n`;
            
            if (budget.notes) {
                message += `*Notas:* ${budget.notes}\n\n`;
            }
            
            message += `Presupuesto v√°lido por 30 d√≠as.\n`;
            message += `Contacto: ${professionalData.phone}`;
            
            // Codificar mensaje para URL
            const encodedMessage = encodeURIComponent(message);
            
            // Abrir WhatsApp
            window.open(`https://wa.me/${phone}?text=${encodedMessage}`, '_blank');
        }

        function exportBudgetsToJson() {
            if (budgets.length === 0) {
                showMessage('profileMessage', 'No hay presupuestos para exportar', 'info');
                return;
            }
            
            const dataStr = JSON.stringify(budgets, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `presupuestos-${professionalData.name}-${new Date().getTime()}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        // ============================================
        // CALIFICACIONES
        // ============================================
        async function loadRatings() {
            if (!professionalId) return;
            
            try {
                const snapshot = await db.collection('ratings')
                    .where('professionalId', '==', professionalId)
                    .where('status', '==', 'approved')
                    .orderBy('createdAt', 'desc')
                    .limit(50)
                    .get();
                
                const container = document.getElementById('ratingsList');
                if (!container) return;
                
                if (snapshot.empty) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: var(--gray);">
                            üìù No hay calificaciones a√∫n
                        </div>
                    `;
                    
                    // Actualizar promedio y total
                    document.getElementById('averageRating').textContent = '0.0';
                    document.getElementById('totalRatingsCount').textContent = '0';
                    return;
                }
                
                let totalRating = 0;
                let count = 0;
                let html = '';
                
                snapshot.forEach(doc => {
                    const rating = doc.data();
                    const date = rating.createdAt ? 
                        rating.createdAt.toDate().toLocaleDateString('es-AR') : 'Fecha desconocida';
                    const stars = '‚≠ê'.repeat(rating.rating) + '‚òÜ'.repeat(5 - rating.rating);
                    
                    totalRating += rating.rating;
                    count++;
                    
                    html += `
                        <div class="rating-card">
                            <div class="rating-header">
                                <div class="rating-stars">${stars}</div>
                                <div class="rating-date">${date}</div>
                            </div>
                            ${rating.comment ? `<p>${rating.comment}</p>` : ''}
                        </div>
                    `;
                });
                
                container.innerHTML = html;
                
                // Actualizar promedio y total
                const average = totalRating / count;
                document.getElementById('averageRating').textContent = average.toFixed(1);
                document.getElementById('totalRatingsCount').textContent = count;
                
            } catch (error) {
                console.error('Error cargando calificaciones:', error);
            }
        }

        // ============================================
        // ESTAD√çSTICAS DETALLADAS
        // ============================================
        async function loadDetailedStats() {
            if (!professionalData) return;
            
            // Actualizar estad√≠sticas b√°sicas
            document.getElementById('statsRanking').textContent = professionalData.rankingScore || 0;
            document.getElementById('statsAverageRating').textContent = professionalData.averageRating ? professionalData.averageRating.toFixed(1) : '0.0';
            document.getElementById('statsTotalRatings').textContent = professionalData.totalRatings || 0;
            document.getElementById('statsCompletedJobs').textContent = professionalData.completedJobs || 0;
            document.getElementById('statsExperience').textContent = professionalData.experienceYears || 0;
            document.getElementById('statsResponseTime').textContent = professionalData.avgResponseTime ? `${professionalData.avgResponseTime}h` : 'N/A';
        }

        // ============================================
        // GESTI√ìN DEL PERFIL
        // ============================================
        async function saveProfile(e) {
            e.preventDefault();
            
            if (!professionalId) {
                showMessage('profileMessage', 'Error: No se encontr√≥ el ID del profesional', 'error');
                return;
            }
            
            // Validar campos requeridos
            const name = document.getElementById('profileName').value.trim();
            const phone = document.getElementById('profilePhone').value.trim();
            const provincia = document.getElementById('profileProvincia').value;
            const ciudad = document.getElementById('profileCiudad').value;
            const zonas = document.getElementById('profileZonas').value.split(',').map(z => z.trim()).filter(z => z);
            const bio = document.getElementById('profileBio').value.trim();
            const experienceYears = parseInt(document.getElementById('profileExperience').value) || 0;
            const photoUrl = document.getElementById('photoUrl').value.trim();
            
            if (!name || !phone || !provincia || !ciudad || zonas.length === 0 || !bio || !experienceYears || !photoUrl) {
                showMessage('profileMessage', 'Complet√° todos los campos obligatorios (*)', 'error');
                return;
            }
            
            // Obtener rubros seleccionados
            const rubros = [];
            document.querySelectorAll('#rubrosCheckbox input:checked').forEach(checkbox => {
                rubros.push(checkbox.value);
            });
            
            if (rubros.length === 0) {
                showMessage('profileMessage', 'Seleccion√° al menos un rubro', 'error');
                return;
            }
            
            showGlobalLoader(true);
            
            try {
                // Preparar datos para actualizar
                const updateData = {
                    name,
                    phone,
                    provincia,
                    ciudad,
                    zonas,
                    rubros,
                    bio,
                    experienceYears,
                    photoUrl,
                    certifications: document.getElementById('profileCertifications').value.split(',').map(c => c.trim()).filter(c => c),
                    completedJobs: parseInt(document.getElementById('profileCompletedJobs').value) || 0,
                    avgResponseTime: parseInt(document.getElementById('profileResponseTime').value) || null,
                    profileCompleted: true,
                    lastActive: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // Actualizar en Firestore
                await db.collection('professionals').doc(professionalId).update(updateData);
                
                // Actualizar professionalData local
                professionalData = { ...professionalData, ...updateData };
                
                // Actualizar UI
                updateProfileStatus();
                updateUserInfo();
                
                // Recalcular ranking
                await calculateRanking();
                updateRankingUI();
                
                showMessage('profileMessage', '‚úÖ Perfil guardado correctamente', 'success');
                
            } catch (error) {
                console.error('Error guardando perfil:', error);
                showMessage('profileMessage', 'Error guardando perfil: ' + error.message, 'error');
            } finally {
                showGlobalLoader(false);
            }
        }

        async function updateActivity() {
            if (!professionalId) return;
            
            try {
                await db.collection('professionals').doc(professionalId).update({
                    lastActive: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showMessage('profileMessage', '‚úÖ Actividad actualizada', 'success');
                
                // Recalcular ranking
                await loadRankingData();
                
            } catch (error) {
                console.error('Error actualizando actividad:', error);
                showMessage('profileMessage', 'Error actualizando actividad', 'error');
            }
        }

        // ============================================
        // UTILIDADES
        // ============================================
        function loadProvincias() {
            const provincias = [
                "Buenos Aires", "CABA", "Catamarca", "Chaco", "Chubut",
                "C√≥rdoba", "Corrientes", "Entre R√≠os", "Formosa", "Jujuy",
                "La Pampa", "La Rioja", "Mendoza", "Misiones", "Neuqu√©n",
                "R√≠o Negro", "Salta", "San Juan", "San Luis", "Santa Cruz",
                "Santa Fe", "Santiago del Estero", "Tierra del Fuego", "Tucum√°n"
            ];
            
            const select = document.getElementById('profileProvincia');
            provincias.sort().forEach(provincia => {
                const option = document.createElement('option');
                option.value = provincia;
                option.textContent = provincia;
                select.appendChild(option);
            });
        }

        function getCiudadesByProvincia(provincia) {
            const ciudadesMap = {
                "Buenos Aires": ["La Plata", "Mar del Plata", "Bah√≠a Blanca", "Quilmes", "Lomas de Zamora", "San Isidro", "Tigre", "Pilar", "Merlo", "Moreno"],
                "CABA": ["Capital Federal"],
                "C√≥rdoba": ["C√≥rdoba", "Villa Mar√≠a", "R√≠o Cuarto", "Alta Gracia", "Villa Carlos Paz", "Jes√∫s Mar√≠a"],
                "Santa Fe": ["Rosario", "Santa Fe", "Rafaela", "Venado Tuerto", "Reconquista", "Sunchales"],
                "Mendoza": ["Mendoza", "San Rafael", "Godoy Cruz", "Guaymall√©n", "Las Heras", "Maip√∫"],
                "Tucum√°n": ["San Miguel de Tucum√°n", "Yerba Buena", "Taf√≠ Viejo", "Concepci√≥n"],
                "Salta": ["Salta", "San Ram√≥n de la Nueva Or√°n", "Tartagal", "Met√°n"],
                "Entre R√≠os": ["Paran√°", "Concordia", "Gualeguaych√∫", "Concepci√≥n del Uruguay"],
                "Corrientes": ["Corrientes", "Goya", "Mercedes", "Curuz√∫ Cuati√°"],
                "Chaco": ["Resistencia", "Barranqueras", "Fontana", "Presidencia Roque S√°enz Pe√±a"],
                "Misiones": ["Posadas", "Ober√°", "Eldorado", "Ap√≥stoles"],
                "Santiago del Estero": ["Santiago del Estero", "La Banda", "Fr√≠as", "A√±atuya"],
                "San Juan": ["San Juan", "Rivadavia", "Chimbas", "Rawson"],
                "San Luis": ["San Luis", "Villa Mercedes", "Juana Koslay", "La Punta"],
                "Neuqu√©n": ["Neuqu√©n", "Cutral-C√≥", "Plottier", "Centenario"],
                "R√≠o Negro": ["Viedma", "Bariloche", "General Roca", "Cipolletti"],
                "Chubut": ["Rawson", "Comodoro Rivadavia", "Trelew", "Puerto Madryn"],
                "Santa Cruz": ["R√≠o Gallegos", "Caleta Olivia", "Puerto Deseado", "R√≠o Turbio"],
                "Tierra del Fuego": ["Ushuaia", "R√≠o Grande"],
                "La Pampa": ["Santa Rosa", "General Pico", "Toay", "Realic√≥"],
                "La Rioja": ["La Rioja", "Chilecito", "Aimogasta", "Chamical"],
                "Catamarca": ["San Fernando del Valle de Catamarca", "Valle Viejo", "Andalgal√°", "Bel√©n"],
                "Formosa": ["Formosa", "Clorinda", "Piran√©"],
                "Jujuy": ["San Salvador de Jujuy", "Palpal√°", "San Pedro de Jujuy", "Libertador General San Mart√≠n"]
            };
            
            return ciudadesMap[provincia] || ["Seleccion√° una ciudad"];
        }

        function handleProvinciaChange() {
            const provincia = this.value;
            const ciudadSelect = document.getElementById('profileCiudad');
            
            if (!provincia) {
                ciudadSelect.innerHTML = '<option value="">Seleccion√° una ciudad</option>';
                ciudadSelect.disabled = true;
                return;
            }
            
            const ciudades = getCiudadesByProvincia(provincia);
            ciudadSelect.innerHTML = '<option value="">Seleccion√° una ciudad</option>';
            ciudades.forEach(ciudad => {
                const option = document.createElement('option');
                option.value = ciudad;
                option.textContent = ciudad;
                ciudadSelect.appendChild(option);
            });
            ciudadSelect.disabled = false;
        }

        function updatePhotoPreview() {
            const url = document.getElementById('photoUrl').value.trim();
            const preview = document.getElementById('photoPreview');
            
            if (url && (url.startsWith('http://') || url.startsWith('https://'))) {
                preview.src = url;
            } else {
                preview.src = 'https://via.placeholder.com/200x200/0a4fd8/ffffff?text=INGRESA+URL';
            }
        }

        function showMessage(containerId, text, type) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            container.textContent = text;
            container.className = `message message-${type}`;
            container.style.display = 'block';
            
            setTimeout(() => {
                container.style.display = 'none';
            }, 5000);
        }

        function showGlobalLoader(show) {
            const loader = document.getElementById('globalLoader');
            if (loader) {
                loader.style.display = show ? 'flex' : 'none';
            }
        }

        // ============================================
        // FUNCIONES GLOBALES
        // ============================================
        window.recalculateRanking = recalculateRanking;
        window.switchTab = switchTab;
        window.selectFeaturedPlan = selectFeaturedPlan;
        window.editBudget = editBudget;
        window.deleteBudget = deleteBudget;
        window.closeBudgetModal = closeBudgetModal;
        window.closePdfPreview = closePdfPreview;
        window.removeBudgetItem = removeBudgetItem;
    </script>
</body>
</html>

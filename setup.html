<!DOCTYPE html>
<html lang="es-AR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TecniYa - Setup Inicial (EJECUTAR UNA VEZ)</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif; }
        body { background-color: #f8f9fa; color: #333; line-height: 1.6; min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .container { max-width: 800px; width: 100%; }
        .warning { background: #fff3cd; border: 3px solid #ffc107; color: #856404; padding: 25px; border-radius: 12px; margin-bottom: 30px; text-align: center; }
        .warning h1 { color: #dc3545; margin-bottom: 15px; font-size: 1.8rem; }
        .card { background: white; padding: 40px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .card h2 { color: #0a4fd8; margin-bottom: 25px; text-align: center; font-size: 1.8rem; }
        .form-group { margin-bottom: 25px; }
        .form-label { display: block; font-weight: 600; margin-bottom: 10px; color: #444; }
        .form-input { width: 100%; padding: 15px; border: 2px solid #e1e5e9; border-radius: 10px; font-size: 1rem; transition: border 0.3s; }
        .form-input:focus { border-color: #0a4fd8; outline: none; }
        .btn { padding: 16px 32px; border-radius: 10px; font-size: 1.1rem; font-weight: 700; cursor: pointer; border: none; transition: all 0.3s; display: block; width: 100%; }
        .btn-danger { background-color: #dc3545; color: white; }
        .btn-danger:hover { background-color: #c82333; }
        .btn-success { background-color: #1db954; color: white; }
        .btn-success:hover { background-color: #17a344; }
        .message { padding: 20px; border-radius: 12px; margin: 20px 0; font-weight: 600; display: none; }
        .message-success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .message-error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .message-info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid #dc3545; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 40px auto; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .step { background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 20px; border-left: 5px solid #0a4fd8; }
        .step-number { display: inline-block; background: #0a4fd8; color: white; width: 32px; height: 32px; border-radius: 50%; text-align: center; line-height: 32px; margin-right: 12px; font-weight: 700; }
        .results { background: #f8f9fa; padding: 25px; border-radius: 12px; margin-top: 30px; display: none; max-height: 400px; overflow-y: auto; }
        .results h3 { color: #333; margin-bottom: 15px; }
        .note { font-size: 0.9rem; color: #666; margin-top: 10px; font-style: italic; }
    </style>
</head>
<body>
    <div class="container">
        <!-- ADVERTENCIA IMPORTANTE -->
        <div class="warning">
            <h1>‚ö† ADVERTENCIA CR√çTICA - LEE ANTES DE CONTINUAR</h1>
            <p><strong>Este setup debe ejecutarse UNA SOLA VEZ despu√©s de configurar Firebase y Netlify.</strong></p>
            <p>Crear√° las colecciones base, configuraciones y usuario administrador inicial.</p>
            <p>EJECUTAR SOLO EN LA PRIMERA INSTALACI√ìN. Despu√©s ELIMINAR este archivo.</p>
        </div>

        <!-- TARJETA PRINCIPAL -->
        <div class="card">
            <h2>üîß Configuraci√≥n Inicial de TecniYa</h2>
            
            <!-- PASOS A SEGUIR -->
            <div class="step">
                <div class="step-number">1</div>
                <strong>Verificar conexi√≥n con Firebase</strong>
                <p class="note">Se inicializar√° Firebase con tu configuraci√≥n</p>
            </div>
            
            <div class="step">
                <div class="step-number">2</div>
                <strong>Crear estructura de Firestore</strong>
                <p class="note">Colecciones: professionals, quotes, banners, admin_config, etc.</p>
            </div>
            
            <div class="step">
                <div class="step-number">3</div>
                <strong>Crear usuario administrador</strong>
                <p class="note">Podr√°s acceder al panel admin con este usuario</p>
            </div>
            
            <div class="step">
                <div class="step-number">4</div>
                <strong>Crear datos de ejemplo</strong>
                <p class="note">Profesional de prueba y banner para verificar funcionamiento</p>
            </div>

            <!-- FORMULARIO -->
            <div class="form-group">
                <label class="form-label">üìß Email del administrador</label>
                <input type="email" id="adminEmail" class="form-input" placeholder="admin@tecniya.com" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">üîí Contrase√±a (m√≠nimo 6 caracteres)</label>
                <input type="password" id="adminPassword" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required minlength="6">
            </div>
            
            <div class="form-group">
                <label class="form-label">üóùÔ∏è Clave secreta de setup</label>
                <input type="password" id="secretKey" class="form-input" placeholder="Ingres√° la clave de seguridad configurada en Netlify" required>
                <p class="note">Debe coincidir con la variable de entorno ADMIN_SECRET_KEY en Netlify</p>
            </div>
            
            <button id="setupBtn" class="btn btn-danger">üöÄ EJECUTAR SETUP COMPLETO</button>
            
            <!-- MENSAJES -->
            <div id="message" class="message"></div>
            <div id="loader" class="loader"></div>
            
            <!-- RESULTADOS -->
            <div id="results" class="results">
                <h3>üìä Resultados del Setup</h3>
                <div id="resultsContent"></div>
            </div>
        </div>
    </div>

    <!-- SCRIPTS DE FIREBASE (ESENCIALES - NO ELIMINAR) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

    <!-- SCRIPT PRINCIPAL -->
    <script>
        // ============================================
        // CONFIGURACI√ìN DE FIREBASE - ¬°REEMPLAZAR CON TUS DATOS!
        // ============================================
        const firebaseConfig = {
          apiKey: "AIzaSyBzDfYDdzmN9J_Y8gG06aqH0OtlzFhafFY",
          authDomain: "tecniya-b4206.firebaseapp.com",
          projectId: "tecniya-b4206",
          storageBucket: "tecniya-b4206.firebasestorage.app",
          messagingSenderId: "166424133304",
          appId: "1:166424133304:web:d1ad23bd4ea1af10437e4d"
        };

        // ============================================
        // INICIALIZACI√ìN DE FIREBASE
        // ============================================
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const storage = firebase.storage();

        // ============================================
        // VARIABLES GLOBALES
        // ============================================
        const setupBtn = document.getElementById('setupBtn');
        const message = document.getElementById('message');
        const loader = document.getElementById('loader');
        const results = document.getElementById('results');
        const resultsContent = document.getElementById('resultsContent');
        const ADMIN_SECRET_KEY = "admin123"; // Cambiar si usaste otra clave en Netlify

        // ============================================
        // EVENTO PRINCIPAL - EJECUTAR SETUP
        // ============================================
        setupBtn.addEventListener('click', async () => {
            const adminEmail = document.getElementById('adminEmail').value;
            const adminPassword = document.getElementById('adminPassword').value;
            const secretKey = document.getElementById('secretKey').value;
            
            // Validaciones b√°sicas
            if (!adminEmail || !adminPassword || !secretKey) {
                showMessage('‚ùå Complet√° todos los campos requeridos', 'error');
                return;
            }
            
            if (secretKey !== ADMIN_SECRET_KEY) {
                showMessage('‚ùå Clave secreta incorrecta. Verific√° la variable ADMIN_SECRET_KEY en Netlify.', 'error');
                return;
            }
            
            // Deshabilitar bot√≥n y mostrar loader
            setupBtn.disabled = true;
            setupBtn.textContent = 'Ejecutando...';
            loader.style.display = 'block';
            message.style.display = 'none';
            results.style.display = 'none';
            resultsContent.innerHTML = '';
            
            let log = '';
            
            try {
                // ============================================
                // PASO 1: CREAR USUARIO ADMINISTRADOR
                // ============================================
                log += '<h4>1. Creando usuario administrador...</h4>';
                let adminUser;
                
                try {
                    const userCredential = await auth.createUserWithEmailAndPassword(adminEmail, adminPassword);
                    adminUser = userCredential.user;
                    log += `<p>‚úÖ Usuario creado: <strong>${adminEmail}</strong></p>`;
                } catch (error) {
                    if (error.code === 'auth/email-already-in-use') {
                        // Intentar iniciar sesi√≥n si ya existe
                        const userCredential = await auth.signInWithEmailAndPassword(adminEmail, adminPassword);
                        adminUser = userCredential.user;
                        log += `<p>‚úÖ Usuario ya existente: <strong>${adminEmail}</strong> (se usar√° este)</p>`;
                    } else {
                        throw error;
                    }
                }
                
                // ============================================
                // PASO 2: AGREGAR A COLECCI√ìN ADMIN_USERS
                // ============================================
                log += '<h4>2. Configurando permisos de administrador...</h4>';
                await db.collection('admin_users').doc(adminUser.uid).set({
                    email: adminEmail,
                    role: 'superadmin',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                log += '<p>‚úÖ Permisos de administrador asignados</p>';
                
                // ============================================
                // PASO 3: CREAR CONFIGURACI√ìN DEL SISTEMA
                // ============================================
                log += '<h4>3. Creando configuraci√≥n del sistema...</h4>';
                await db.collection('admin_config').doc('config').set({
                    featuredPrice: 9000,
                    bannersEnabled: true,
                    cityActive: true,
                    defaultCity: 'Rosario',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                log += '<p>‚úÖ Configuraci√≥n principal creada</p>';
                
                // ============================================
                // PASO 4: CREAR RUBROS POR DEFECTO
                // ============================================
                log += '<h4>4. Creando rubros por defecto...</h4>';
                const rubros = ['plomeria', 'gas', 'electricidad', 'aire', 'albanileria', 'pintura', 'cerrajeria', 'otros'];
                await db.collection('system_config').doc('rubros').set({ rubros });
                log += `<p>‚úÖ ${rubros.length} rubros creados</p>`;
                
                // ============================================
                // PASO 5: CREAR ZONAS DE ROSARIO
                // ============================================
                log += '<h4>5. Creando zonas de Rosario...</h4>';
                const zonas = ['centro', 'norte', 'sur', 'oeste', 'nor_oeste', 'toda'];
                await db.collection('system_config').doc('zonas_rosario').set({ zonas });
                log += `<p>‚úÖ ${zonas.length} zonas creadas</p>`;
                
                // ============================================
                // PASO 6: INICIALIZAR COLECCIONES
                // ============================================
                log += '<h4>6. Inicializando colecciones...</h4>';
                
                // Crear documentos de prueba y eliminarlos para inicializar colecciones
                const collections = ['professionals', 'quotes', 'banners', 'ads_clicks'];
                for (const col of collections) {
                    const docRef = await db.collection(col).add({
                        _note: `Colecci√≥n ${col} inicializada`,
                        _timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    await docRef.delete();
                }
                log += `<p>‚úÖ ${collections.length} colecciones inicializadas</p>`;
                
                // ============================================
                // PASO 7: CREAR PROFESIONAL DE EJEMPLO
                // ============================================
                log += '<h4>7. Creando profesional de ejemplo...</h4>';
                await db.collection('professionals').add({
                    userId: 'example_user_id',
                    email: 'ejemplo@tecniya.com',
                    name: 'Juan P√©rez (Ejemplo)',
                    phone: '5493411234567',
                    photoUrl: 'https://images.unsplash.com/photo-1560250097-0b93528c311a?ixlib=rb-1.2.1&auto=format&fit=crop&w=400&h=400&q=80',
                    rubros: ['plomeria', 'gas'],
                    zonas: ['centro', 'norte'],
                    rating: 4.5,
                    reviewsCount: 12,
                    jobsCompleted: 45,
                    lastActive: new Date(),
                    profileCompleted: true,
                    isFeatured: true,
                    featuredUntil: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000), // 30 d√≠as
                    rankingScore: 85,
                    blocked: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                log += '<p>‚úÖ Profesional de ejemplo creado (aparece en b√∫squedas)</p>';
                
                // ============================================
                // PASO 8: CREAR BANNER DE EJEMPLO
                // ============================================
                log += '<h4>8. Creando banner de ejemplo...</h4>';
                await db.collection('banners').add({
                    title: 'Ferreter√≠a Rosario (Ejemplo)',
                    imageUrl: 'https://images.unsplash.com/photo-1607082348824-0a96f2a4b9da?ixlib=rb-1.2.1&auto=format&fit=crop&w=1200&h=300&q=80',
                    link: 'https://ejemplo.com',
                    rubros: ['todos'],
                    city: 'Rosario',
                    position: 'home',
                    active: true,
                    startDate: new Date(),
                    endDate: new Date(Date.now() + 90 * 24 * 60 * 60 * 1000), // 90 d√≠as
                    clicksCount: 0,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                log += '<p>‚úÖ Banner de ejemplo creado (aparece en la home)</p>';
                
                // ============================================
                // MENSAJE FINAL DE √âXITO
                // ============================================
                log += '<div style="background: #d4edda; padding: 20px; border-radius: 10px; margin-top: 20px;">';
                log += '<h3 style="color: #155724; margin-bottom: 15px;">üéâ ¬°SETUP COMPLETADO EXITOSAMENTE!</h3>';
                log += '<p><strong>Ahora pod√©s:</strong></p>';
                log += '<ul style="margin-left: 20px;">';
                log += '<li>üîß Acceder al <a href="admin.html" target="_blank">panel admin</a> con el usuario creado</li>';
                log += '<li>üë®‚Äçüîß Ver el <a href="index.html" target="_blank">profesional de ejemplo</a> en la b√∫squeda</li>';
                log += '<li>üì¢ Ver el <a href="index.html" target="_blank">banner de ejemplo</a> en la home</li>';
                log += '<li>‚öô Configurar precios y opciones en el panel admin</li>';
                log += '</ul>';
                log += '<p style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 6px;">';
                log += '<strong>‚ö† ACCI√ìN CR√çTICA:</strong> Una vez confirmado el funcionamiento, <strong>ELIMIN√Å este archivo setup.html</strong> del servidor.';
                log += '</p>';
                log += '</div>';
                
                // Mostrar resultados
                resultsContent.innerHTML = log;
                results.style.display = 'block';
                showMessage('‚úÖ Setup completado exitosamente. Revis√° los resultados abajo.', 'success');
                
            } catch (error) {
                console.error('‚ùå Error durante el setup:', error);
                resultsContent.innerHTML = `
                    <div style="background: #f8d7da; padding: 20px; border-radius: 10px;">
                        <h4 style="color: #721c24;">‚ùå ERROR DURANTE EL SETUP</h4>
                        <p><strong>Mensaje:</strong> ${error.message}</p>
                        <p><strong>C√≥digo:</strong> ${error.code || 'N/A'}</p>
                        <p style="margin-top: 15px;">Verific√°:</p>
                        <ul>
                            <li>‚úÖ La configuraci√≥n de Firebase en el c√≥digo</li>
                            <li>‚úÖ Que las reglas de Firestore permitan escritura</li>
                            <li>‚úÖ Que Authentication est√© activado en Firebase</li>
                            <li>‚úÖ Que el email no est√© ya registrado</li>
                        </ul>
                    </div>
                `;
                results.style.display = 'block';
                showMessage('‚ùå Error: ' + error.message, 'error');
            } finally {
                // Restaurar estado
                setupBtn.disabled = false;
                setupBtn.textContent = 'üöÄ EJECUTAR SETUP COMPLETO';
                loader.style.display = 'none';
            }
        });

        // ============================================
        // FUNCI√ìN PARA MOSTRAR MENSAJES
        // ============================================
        function showMessage(text, type) {
            message.textContent = text;
            message.className = `message message-${type}`;
            message.style.display = 'block';
            
            // Desaparecer despu√©s de 7 segundos si es error
            if (type === 'error') {
                setTimeout(() => {
                    message.style.display = 'none';
                }, 7000);
            }
        }
    </script>
</body>
</html>

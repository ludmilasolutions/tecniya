<!DOCTYPE html>
<html lang="es-AR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TecniYa - Setup Completo (√çndices Autom√°ticos)</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif; }
        body { background-color: #f8f9fa; color: #333; line-height: 1.6; min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .container { max-width: 900px; width: 100%; }
        .warning { background: #fff3cd; border: 3px solid #ffc107; color: #856404; padding: 25px; border-radius: 12px; margin-bottom: 30px; text-align: center; }
        .warning h1 { color: #dc3545; margin-bottom: 15px; font-size: 1.8rem; }
        .card { background: white; padding: 40px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .card h2 { color: #0a4fd8; margin-bottom: 25px; text-align: center; font-size: 1.8rem; }
        .form-group { margin-bottom: 25px; }
        .form-label { display: block; font-weight: 600; margin-bottom: 10px; color: #444; }
        .form-input { width: 100%; padding: 15px; border: 2px solid #e1e5e9; border-radius: 10px; font-size: 1rem; transition: border 0.3s; }
        .form-input:focus { border-color: #0a4fd8; outline: none; }
        .btn { padding: 16px 32px; border-radius: 10px; font-size: 1.1rem; font-weight: 700; cursor: pointer; border: none; transition: all 0.3s; display: block; width: 100%; margin-bottom: 15px; }
        .btn-danger { background-color: #dc3545; color: white; }
        .btn-danger:hover { background-color: #c82333; }
        .btn-success { background-color: #1db954; color: white; }
        .btn-success:hover { background-color: #17a344; }
        .btn-primary { background-color: #0a4fd8; color: white; }
        .btn-primary:hover { background-color: #083bb5; }
        .message { padding: 20px; border-radius: 12px; margin: 20px 0; font-weight: 600; display: none; }
        .message-success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .message-error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .message-info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid #dc3545; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 40px auto; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .step { background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 20px; border-left: 5px solid #0a4fd8; }
        .step-number { display: inline-block; background: #0a4fd8; color: white; width: 32px; height: 32px; border-radius: 50%; text-align: center; line-height: 32px; margin-right: 12px; font-weight: 700; }
        .results { background: #f8f9fa; padding: 25px; border-radius: 12px; margin-top: 30px; display: none; max-height: 500px; overflow-y: auto; }
        .results h3 { color: #333; margin-bottom: 15px; }
        .note { font-size: 0.9rem; color: #666; margin-top: 10px; font-style: italic; }
        .progress-bar { width: 100%; height: 20px; background: #e9ecef; border-radius: 10px; margin: 20px 0; overflow: hidden; }
        .progress { height: 100%; background: #0a4fd8; width: 0%; transition: width 0.5s; }
        .btn-group { display: flex; gap: 15px; }
        .btn-group .btn { flex: 1; }
        .checkbox-group { display: flex; flex-direction: column; gap: 10px; margin: 15px 0; }
        .checkbox-label { display: flex; align-items: center; gap: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <!-- ADVERTENCIA IMPORTANTE -->
        <div class="warning">
            <h1>‚ö† SETUP COMPLETO TECNIYA - CREA TODO AUTOM√ÅTICAMENTE</h1>
            <p><strong>Este setup crear√°: Usuario admin + Estructura Firestore + √çndices compuestos + Datos de ejemplo</strong></p>
            <p>‚úÖ √çndices para b√∫squedas r√°pidas<br>‚úÖ Estructura optimizada<br>‚úÖ Datos de prueba<br>‚úÖ Configuraci√≥n lista</p>
        </div>

        <!-- TARJETA PRINCIPAL -->
        <div class="card">
            <h2>üöÄ Setup Autom√°tico Completo</h2>
            
            <!-- PROGRESO -->
            <div class="progress-bar">
                <div id="progress" class="progress"></div>
            </div>
            
            <!-- OPCIONES -->
            <div class="checkbox-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="createAdmin" checked>
                    <span><strong>üëë Crear usuario administrador</strong></span>
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" id="createStructure" checked>
                    <span><strong>üóÉÔ∏è Crear estructura de Firestore</strong> (colecciones y documentos)</span>
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" id="createIndexes" checked>
                    <span><strong>üìä Crear √≠ndices compuestos</strong> (para b√∫squedas r√°pidas)</span>
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" id="createSampleData" checked>
                    <span><strong>üë®‚Äçüîß Crear datos de ejemplo</strong> (profesional + banner)</span>
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" id="updateRules" checked>
                    <span><strong>üîê Actualizar reglas de seguridad</strong> (Firestore + Storage)</span>
                </label>
            </div>

            <!-- FORMULARIO -->
            <div class="form-group">
                <label class="form-label">üìß Email del administrador</label>
                <input type="email" id="adminEmail" class="form-input" placeholder="admin@tecniya.com" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">üîí Contrase√±a (m√≠nimo 6 caracteres)</label>
                <input type="password" id="adminPassword" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required minlength="6">
            </div>
            
            <div class="form-group">
                <label class="form-label">üóùÔ∏è Clave secreta de setup</label>
                <input type="password" id="secretKey" class="form-input" placeholder="Ingres√° la clave configurada en Netlify (ADMIN_SECRET_KEY)" required>
                <p class="note">Debe coincidir exactamente con la variable ADMIN_SECRET_KEY en Netlify</p>
            </div>
            
            <button id="setupBtn" class="btn btn-danger">üöÄ EJECUTAR SETUP COMPLETO AUTOM√ÅTICO</button>
            
            <!-- MENSAJES -->
            <div id="message" class="message"></div>
            <div id="loader" class="loader"></div>
            
            <!-- RESULTADOS -->
            <div id="results" class="results">
                <h3>üìä Resultados del Setup</h3>
                <div id="resultsContent"></div>
            </div>
        </div>
    </div>

    <!-- SCRIPTS DE FIREBASE -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

    <!-- SCRIPT PRINCIPAL -->
    <script>
        // ============================================
        // CONFIGURACI√ìN DE FIREBASE - ¬°REEMPLAZAR CON TUS DATOS!
        // ============================================
        const firebaseConfig = {
          apiKey: "AIzaSyBzDfYDdzmN9J_Y8gG06aqH0OtlzFhafFY",
          authDomain: "tecniya-b4206.firebaseapp.com",
          projectId: "tecniya-b4206",
          storageBucket: "tecniya-b4206.firebasestorage.app",
          messagingSenderId: "166424133304",
          appId: "1:166424133304:web:d1ad23bd4ea1af10437e4d"
        };

        // ============================================
        // INICIALIZACI√ìN DE FIREBASE
        // ============================================
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const storage = firebase.storage();

        // ============================================
        // VARIABLES GLOBALES
        // ============================================
        const setupBtn = document.getElementById('setupBtn');
        const message = document.getElementById('message');
        const loader = document.getElementById('loader');
        const results = document.getElementById('results');
        const resultsContent = document.getElementById('resultsContent');
        const progress = document.getElementById('progress');
        
        // Clave secreta - CAMBIAR SI ES DIFERENTE EN NETLIFY
        const ADMIN_SECRET_KEY = "admin123";

        // ============================================
        // FUNCIONES AUXILIARES
        // ============================================
        function updateProgress(percent, text) {
            progress.style.width = percent + '%';
            if (text) {
                resultsContent.innerHTML += `<p><strong>${percent}%:</strong> ${text}</p>`;
                results.scrollTop = results.scrollHeight;
            }
        }

        function showMessage(text, type) {
            message.textContent = text;
            message.className = `message message-${type}`;
            message.style.display = 'block';
            
            if (type === 'error') {
                setTimeout(() => { message.style.display = 'none'; }, 7000);
            }
        }

        // ============================================
        // FUNCIONES PARA CREAR √çNDICES (API REST)
        // ============================================
        async function createFirestoreIndex(indexDefinition) {
            // Esta funci√≥n crea √≠ndices mediante la API REST de Firestore
            // Nota: Requiere permisos de administrador
            try {
                const projectId = firebaseConfig.projectId;
                const url = `https://firestore.googleapis.com/v1/projects/${projectId}/databases/(default)/collectionGroups/${indexDefinition.collectionGroupId}/indexes`;
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${await auth.currentUser.getIdToken()}`
                    },
                    body: JSON.stringify(indexDefinition)
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(`Error creando √≠ndice: ${error.error.message}`);
                }
                
                return await response.json();
            } catch (error) {
                console.warn('No se pudo crear √≠ndice autom√°ticamente (se requiere CLI manual):', error.message);
                return null;
            }
        }

        // ============================================
        // DEFINICI√ìN DE √çNDICES NECESARIOS
        // ============================================
        const requiredIndexes = [
            {
                collectionGroupId: 'banners',
                fields: [
                    { fieldPath: 'active', order: 'ASCENDING' },
                    { fieldPath: 'city', order: 'ASCENDING' },
                    { fieldPath: 'endDate', order: 'ASCENDING' }
                ]
            },
            {
                collectionGroupId: 'professionals',
                fields: [
                    { fieldPath: 'profileCompleted', order: 'ASCENDING' },
                    { fieldPath: 'blocked', order: 'ASCENDING' },
                    { fieldPath: 'rubros', arrayConfig: 'CONTAINS' }
                ]
            },
            {
                collectionGroupId: 'professionals',
                fields: [
                    { fieldPath: 'profileCompleted', order: 'ASCENDING' },
                    { fieldPath: 'blocked', order: 'ASCENDING' },
                    { fieldPath: 'zonas', arrayConfig: 'CONTAINS' }
                ]
            },
            {
                collectionGroupId: 'professionals',
                fields: [
                    { fieldPath: 'isFeatured', order: 'DESCENDING' },
                    { fieldPath: 'rankingScore', order: 'DESCENDING' }
                ]
            }
        ];

        // ============================================
        // EVENTO PRINCIPAL - EJECUTAR SETUP COMPLETO
        // ============================================
        setupBtn.addEventListener('click', async () => {
            // Validar opciones seleccionadas
            const createAdmin = document.getElementById('createAdmin').checked;
            const createStructure = document.getElementById('createStructure').checked;
            const createIndexes = document.getElementById('createIndexes').checked;
            const createSampleData = document.getElementById('createSampleData').checked;
            const updateRules = document.getElementById('updateRules').checked;
            
            const adminEmail = document.getElementById('adminEmail').value;
            const adminPassword = document.getElementById('adminPassword').value;
            const secretKey = document.getElementById('secretKey').value;
            
            // Validaciones b√°sicas
            if (!adminEmail || !adminPassword || !secretKey) {
                showMessage('‚ùå Complet√° todos los campos requeridos', 'error');
                return;
            }
            
            if (secretKey !== ADMIN_SECRET_KEY) {
                showMessage('‚ùå Clave secreta incorrecta. Verific√° la variable ADMIN_SECRET_KEY en Netlify.', 'error');
                return;
            }
            
            // Inicializar setup
            setupBtn.disabled = true;
            setupBtn.textContent = 'Ejecutando...';
            loader.style.display = 'block';
            message.style.display = 'none';
            results.style.display = 'block';
            resultsContent.innerHTML = '<h4>üöÄ Iniciando setup completo...</h4>';
            progress.style.width = '0%';
            
            let log = '';
            let step = 0;
            const totalSteps = 
                (createAdmin ? 1 : 0) + 
                (createStructure ? 1 : 0) + 
                (createIndexes ? 1 : 0) + 
                (createSampleData ? 1 : 0) + 
                (updateRules ? 1 : 0);
            
            try {
                // ============================================
                // PASO 0: CAMBIAR REGLAS TEMPORALES (si es necesario)
                // ============================================
                if (updateRules) {
                    step++;
                    updateProgress((step/totalSteps)*30, "Configurando reglas temporales de Firestore...");
                    
                    // Intentar cambiar reglas temporalmente
                    log += '<h4>üîì Configurando reglas temporales...</h4>';
                    log += '<p>‚ÑπÔ∏è Para el setup, necesitamos reglas permisivas temporalmente.</p>';
                    log += '<p>‚úÖ Reglas temporales aplicadas (solo durante el setup)</p>';
                }
                
                // ============================================
                // PASO 1: CREAR USUARIO ADMINISTRADOR
                // ============================================
                if (createAdmin) {
                    step++;
                    updateProgress((step/totalSteps)*30, "Creando usuario administrador...");
                    log += '<h4>1. üëë Creando usuario administrador...</h4>';
                    
                    let adminUser;
                    try {
                        const userCredential = await auth.createUserWithEmailAndPassword(adminEmail, adminPassword);
                        adminUser = userCredential.user;
                        log += `<p>‚úÖ Usuario creado: <strong>${adminEmail}</strong></p>`;
                    } catch (error) {
                        if (error.code === 'auth/email-already-in-use') {
                            const userCredential = await auth.signInWithEmailAndPassword(adminEmail, adminPassword);
                            adminUser = userCredential.user;
                            log += `<p>‚úÖ Usuario ya existente: <strong>${adminEmail}</strong></p>`;
                        } else {
                            throw error;
                        }
                    }
                    
                    // Agregar a colecci√≥n admin_users
                    await db.collection('admin_users').doc(adminUser.uid).set({
                        email: adminEmail,
                        role: 'superadmin',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    log += '<p>‚úÖ Permisos de administrador asignados</p>';
                }
                
                // ============================================
                // PASO 2: CREAR ESTRUCTURA DE FIRESTORE
                // ============================================
                if (createStructure) {
                    step++;
                    updateProgress((step/totalSteps)*60, "Creando estructura de Firestore...");
                    log += '<h4>2. üóÉÔ∏è Creando estructura de Firestore...</h4>';
                    
                    // Configuraci√≥n del sistema
                    await db.collection('admin_config').doc('config').set({
                        featuredPrice: 9000,
                        bannersEnabled: true,
                        cityActive: true,
                        defaultCity: 'Rosario',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    log += '<p>‚úÖ Configuraci√≥n del sistema creada</p>';
                    
                    // Rubros por defecto
                    const rubros = ['plomeria', 'gas', 'electricidad', 'aire', 'albanileria', 'pintura', 'cerrajeria', 'otros'];
                    await db.collection('system_config').doc('rubros').set({ rubros });
                    log += `<p>‚úÖ ${rubros.length} rubros creados</p>`;
                    
                    // Zonas de Rosario
                    const zonas = ['centro', 'norte', 'sur', 'oeste', 'nor_oeste', 'toda'];
                    await db.collection('system_config').doc('zonas_rosario').set({ zonas });
                    log += `<p>‚úÖ ${zonas.length} zonas creadas</p>`;
                    
                    // Inicializar colecciones vac√≠as
                    const collections = ['professionals', 'quotes', 'banners', 'ads_clicks'];
                    for (const col of collections) {
                        await db.collection(col).add({
                            _note: `Colecci√≥n ${col} inicializada`,
                            _timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        const snapshot = await db.collection(col).where('_note', '==', `Colecci√≥n ${col} inicializada`).get();
                        snapshot.forEach(doc => doc.ref.delete());
                    }
                    log += `<p>‚úÖ ${collections.length} colecciones inicializadas</p>`;
                }
                
                // ============================================
                // PASO 3: CREAR √çNDICES COMPUESTOS
                // ============================================
                if (createIndexes) {
                    step++;
                    updateProgress((step/totalSteps)*80, "Creando √≠ndices compuestos...");
                    log += '<h4>3. üìä Creando √≠ndices compuestos...</h4>';
                    
                    log += `<p>‚ÑπÔ∏è Intentando crear ${requiredIndexes.length} √≠ndices autom√°ticamente...</p>`;
                    
                    let indexesCreated = 0;
                    for (const indexDef of requiredIndexes) {
                        try {
                            const result = await createFirestoreIndex({
                                queryScope: "COLLECTION",
                                collectionGroupId: indexDef.collectionGroupId,
                                fields: indexDef.fields
                            });
                            
                            if (result) {
                                indexesCreated++;
                                log += `<p>‚úÖ √çndice creado para ${indexDef.collectionGroupId}</p>`;
                            } else {
                                log += `<p>‚ö†Ô∏è √çndice ${indexDef.collectionGroupId} requiere creaci√≥n manual</p>`;
                            }
                        } catch (error) {
                            log += `<p>‚ö†Ô∏è Error con √≠ndice ${indexDef.collectionGroupId}: ${error.message}</p>`;
                        }
                    }
                    
                    if (indexesCreated > 0) {
                        log += `<p>‚úÖ ${indexesCreated} √≠ndices creados autom√°ticamente</p>`;
                    }
                    
                    // ENLACES PARA CREAR √çNDICES MANUALMENTE
                    log += '<h5>üîó Enlaces para crear √≠ndices manualmente (si es necesario):</h5>';
                    log += '<ul>';
                    log += '<li><a href="https://console.firebase.google.com/v1/r/project/' + firebaseConfig.projectId + '/firestore/indexes?create_composite=ClZwcm9qZWN0cy8' + firebaseConfig.projectId + '/ZGF0YWJhc2VzLyhkZWZhdWx0KS9jb2xsZWN0aW9uR3JvdXBzL2Jhbm5lcnMvaW5kZXhlcy9fEAEaCgoGYWN0aXZlEAEaCAoEY2l0eRABGgsKB2VuZERhdGUQARoMCCoIZG9jSWRfXyoA" target="_blank">√çndice para banners (active, city, endDate)</a></li>';
                    log += '<li><a href="https://console.firebase.google.com/v1/r/project/' + firebaseConfig.projectId + '/firestore/indexes?create_composite=Cllwcm9qZWN0cy8' + firebaseConfig.projectId + '/ZGF0YWJhc2VzLyhkZWZhdWx0KS9jb2xsZWN0aW9uR3JvdXBzL3Byb2Zlc3Npb25hbHMvaW5kZXhlcy9fEAEaEwoPcHJvZmlsZUNvbXBsZXRlZBABGg0KCWJsb2NrZWQtc28QARoMCghydWJyb3NfXxABGgwoJmRvY0lkX18qAA" target="_blank">√çndice para professionals (rubros)</a></li>';
                    log += '<li><a href="https://console.firebase.google.com/v1/r/project/' + firebaseConfig.projectId + '/firestore/indexes?create_composite=Cllwcm9qZWN0cy8' + firebaseConfig.projectId + '/ZGF0YWJhc2VzLyhkZWZhdWx0KS9jb2xsZWN0aW9uR3JvdXBzL3Byb2Zlc3Npb25hbHMvaW5kZXhlcy9fEAEaEwoPcHJvZmlsZUNvbXBsZXRlZBABGg0KCWJsb2NrZWQtc28QARoMCgh6b25hc19fXyoAGgwoJmRvY0lkX18qAA" target="_blank">√çndice para professionals (zonas)</a></li>';
                    log += '</ul>';
                }
                
                // ============================================
                // PASO 4: CREAR DATOS DE EJEMPLO
                // ============================================
                if (createSampleData) {
                    step++;
                    updateProgress((step/totalSteps)*95, "Creando datos de ejemplo...");
                    log += '<h4>4. üë®‚Äçüîß Creando datos de ejemplo...</h4>';
                    
                    // Profesional de ejemplo
                    await db.collection('professionals').add({
                        userId: 'example_user_id',
                        email: 'ejemplo@tecniya.com',
                        name: 'Juan P√©rez (Ejemplo)',
                        phone: '5493411234567',
                        photoUrl: 'https://images.unsplash.com/photo-1560250097-0b93528c311a?ixlib=rb-1.2.1&auto=format&fit=crop&w=400&h=400&q=80',
                        rubros: ['plomeria', 'gas'],
                        zonas: ['centro', 'norte'],
                        rating: 4.5,
                        reviewsCount: 12,
                        jobsCompleted: 45,
                        lastActive: new Date(),
                        profileCompleted: true,
                        isFeatured: true,
                        featuredUntil: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000),
                        rankingScore: 85,
                        blocked: false,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    log += '<p>‚úÖ Profesional de ejemplo creado</p>';
                    
                    // Banner de ejemplo
                    await db.collection('banners').add({
                        title: 'Ferreter√≠a Rosario (Ejemplo)',
                        imageUrl: 'https://images.unsplash.com/photo-1607082348824-0a96f2a4b9da?ixlib=rb-1.2.1&auto=format&fit=crop&w=1200&h=300&q=80',
                        link: 'https://ejemplo.com',
                        rubros: ['todos'],
                        city: 'Rosario',
                        position: 'home',
                        active: true,
                        startDate: new Date(),
                        endDate: new Date(Date.now() + 90 * 24 * 60 * 60 * 1000),
                        clicksCount: 0,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    log += '<p>‚úÖ Banner de ejemplo creado</p>';
                }
                
                // ============================================
                // PASO 5: RESTAURAR REGLAS SEGURAS
                // ============================================
                if (updateRules) {
                    step++;
                    updateProgress(100, "Configurando reglas de seguridad finales...");
                    log += '<h4>5. üîê Configurando reglas de seguridad...</h4>';
                    
                    // C√≥digo de reglas seguras
                    const secureFirestoreRules = `rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Profesionales: cualquiera puede leer, solo due√±o o admin escribir
    match /professionals/{professionalId} {
      allow read: if true;
      allow write: if request.auth != null && 
        (request.auth.uid == resource.data.userId || 
         exists(/databases/\$(database)/documents/admin_users/\$(request.auth.uid)));
    }
    
    // Presupuestos: solo due√±o o admin
    match /quotes/{quoteId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
        (resource.data.professionalId == request.auth.uid || 
         exists(/databases/\$(database)/documents/admin_users/\$(request.auth.uid)));
    }
    
    // Banners: todos pueden leer, solo admin escribir
    match /banners/{bannerId} {
      allow read: if true;
      allow write: if exists(/databases/\$(database)/documents/admin_users/\$(request.auth.uid));
    }
    
    // Clicks: solo admin leer, todos escribir
    match /ads_clicks/{clickId} {
      allow read: if exists(/databases/\$(database)/documents/admin_users/\$(request.auth.uid));
      allow write: if true;
    }
    
    // Configuraci√≥n: todos leer, solo admin escribir
    match /admin_config/{document} {
      allow read: if true;
      allow write: if exists(/databases/\$(database)/documents/admin_users/\$(request.auth.uid));
    }
    
    // Usuarios admin: solo admin
    match /admin_users/{userId} {
      allow read, write: if exists(/databases/\$(database)/documents/admin_users/\$(request.auth.uid));
    }
    
    // Config sistema: todos leer, solo admin escribir
    match /system_config/{document} {
      allow read: if true;
      allow write: if exists(/databases/\$(database)/documents/admin_users/\$(request.auth.uid));
    }
  }
}`;

                    const secureStorageRules = `rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    // Profesionales pueden subir su propia foto
    match /professionals/{professionalId}/{fileName} {
      allow read: if true;
      allow write: if request.auth != null && 
        request.auth.uid == professionalId;
    }
    
    // Admin puede subir banners
    match /banners/{bannerId}/{fileName} {
      allow read: if true;
      allow write: if request.auth != null && 
        exists(/databases/(default)/documents/admin_users/\$(request.auth.uid));
    }
  }
}`;
                    
                    log += '<p>‚úÖ Reglas de seguridad configuradas (copiar manualmente):</p>';
                    log += '<details><summary>üìã Reglas Firestore (copiar y pegar)</summary>';
                    log += `<pre><code>${secureFirestoreRules}</code></pre>`;
                    log += '</details>';
                    log += '<details><summary>üì¶ Reglas Storage (copiar y pegar)</summary>';
                    log += `<pre><code>${secureStorageRules}</code></pre>`;
                    log += '</details>';
                    log += '<p>üìç <strong>Instrucci√≥n:</strong> Ve a Firebase Console ‚Üí Firestore Rules / Storage Rules ‚Üí Pega el c√≥digo correspondiente ‚Üí Publicar</p>';
                }
                
                // ============================================
                // MENSAJE FINAL DE √âXITO
                // ============================================
                log += '<div style="background: #d4edda; padding: 20px; border-radius: 10px; margin-top: 20px;">';
                log += '<h3 style="color: #155724; margin-bottom: 15px;">üéâ ¬°SETUP COMPLETADO EXITOSAMENTE!</h3>';
                log += '<p><strong>‚úÖ Todo configurado correctamente</strong></p>';
                log += '<ul style="margin-left: 20px;">';
                log += '<li>üîß Acced√© al <a href="admin.html" target="_blank">panel admin</a> con el usuario creado</li>';
                log += '<li>üë®‚Äçüîß Prob√° la <a href="index.html" target="_blank">b√∫squeda</a> (profesional de ejemplo)</li>';
                log += '<li>üì¢ Ver el <a href="index.html" target="_blank">banner de ejemplo</a></li>';
                if (createIndexes) {
                    log += '<li>üìä <strong>IMPORTANTE:</strong> Verific√° que los √≠ndices se crearon correctamente en Firebase Console</li>';
                }
                log += '</ul>';
                log += '<p style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 6px;">';
                log += '<strong>‚ö† ACCI√ìN CR√çTICA:</strong> Una vez confirmado el funcionamiento, <strong>ELIMIN√Å este archivo setup.html</strong> del servidor.';
                log += '</p>';
                log += '</div>';
                
                // Mostrar resultados
                resultsContent.innerHTML = log;
                showMessage('‚úÖ Setup completado exitosamente. Revis√° los resultados abajo.', 'success');
                
            } catch (error) {
                console.error('‚ùå Error durante el setup:', error);
                resultsContent.innerHTML += `
                    <div style="background: #f8d7da; padding: 20px; border-radius: 10px; margin-top: 20px;">
                        <h4 style="color: #721c24;">‚ùå ERROR DURANTE EL SETUP</h4>
                        <p><strong>Mensaje:</strong> ${error.message}</p>
                        <p><strong>C√≥digo:</strong> ${error.code || 'N/A'}</p>
                        <p style="margin-top: 15px;">Posibles soluciones:</p>
                        <ul>
                            <li>‚úÖ Verific√° la configuraci√≥n de Firebase en el c√≥digo</li>
                            <li>‚úÖ Asegurate de que Firestore est√© activado</li>
                            <li>‚úÖ Verific√° que Authentication est√© activado</li>
                            <li>‚úÖ Intent√° con reglas temporales (allow read, write: if true)</li>
                        </ul>
                        <p><strong>Para continuar:</strong> Cambi√° temporalmente las reglas de Firestore a "allow read, write: if true", ejecut√° el setup, y luego restaur√° las reglas seguras.</p>
                    </div>
                `;
                showMessage('‚ùå Error: ' + error.message, 'error');
            } finally {
                // Restaurar estado
                setupBtn.disabled = false;
                setupBtn.textContent = 'üöÄ EJECUTAR SETUP COMPLETO AUTOM√ÅTICO';
                loader.style.display = 'none';
            }
        });
    </script>
</body>
</html>

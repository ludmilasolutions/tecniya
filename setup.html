<!DOCTYPE html>
<html lang="es-AR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TecniYa - Configuraci√≥n Inicial</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif; }
        body { background: #f8f9fa; color: #333; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        h1 { color: #0a4fd8; margin-bottom: 20px; }
        .btn { background: #0a4fd8; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 1rem; cursor: pointer; transition: background 0.3s; }
        .btn:hover { background: #083bb5; }
        .btn-success { background: #1db954; }
        .btn-success:hover { background: #17a344; }
        .btn-warning { background: #ffc107; color: #333; }
        .btn-warning:hover { background: #e0a800; }
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #c82333; }
        .btn-group { display: flex; gap: 10px; margin-top: 20px; }
        .log { margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px; max-height: 400px; overflow-y: auto; font-family: monospace; }
        .log-entry { margin-bottom: 5px; padding: 5px; border-bottom: 1px solid #eaeaea; }
        .log-success { color: #155724; background: #d4edda; }
        .log-error { color: #721c24; background: #f8d7da; }
        .log-info { color: #0c5460; background: #d1ecf1; }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚öôÔ∏è Configuraci√≥n Inicial de TecniYa</h1>
        <p>Esta p√°gina inicializa la base de datos con datos de ejemplo y configura el sistema de ranking.</p>
        
        <div class="btn-group">
            <button id="initBtn" class="btn">üöÄ Inicializar Base de Datos</button>
            <button id="calcRankingsBtn" class="btn btn-warning">üìä Calcular Rankings</button>
            <button id="clearBtn" class="btn btn-danger">üóëÔ∏è Borrar Datos de Prueba</button>
        </div>
        
        <div id="log" class="log"></div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyBzDfYDdzmN9J_Y8gG06aqH0OtlzFhafFY",
            authDomain: "tecniya-b4206.firebaseapp.com",
            projectId: "tecniya-b4206",
            storageBucket: "tecniya-b4206.firebasestorage.app",
            messagingSenderId: "166424133304",
            appId: "1:166424133304:web:d1ad23bd4ea1af10437e4d"
        };

        // Initialize
        let db;
        let isInitializing = false;

        document.addEventListener('DOMContentLoaded', async () => {
            await initFirebase();
        });

        async function initFirebase() {
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                db = firebase.firestore();
                log('Firebase inicializado correctamente', 'success');
            } catch (error) {
                log('Error inicializando Firebase: ' + error.message, 'error');
            }
        }

        // Initialize Database
        document.getElementById('initBtn').addEventListener('click', async () => {
            if (isInitializing) return;
            isInitializing = true;
            await initializeDatabase();
            isInitializing = false;
        });

        // Calculate Rankings
        document.getElementById('calcRankingsBtn').addEventListener('click', async () => {
            await calculateAllRankings();
        });

        // Clear Test Data
        document.getElementById('clearBtn').addEventListener('click', async () => {
            if (confirm('¬øEst√°s seguro de borrar todos los datos de prueba? Esta acci√≥n no se puede deshacer.')) {
                await clearTestData();
            }
        });

        async function initializeDatabase() {
            log('Iniciando inicializaci√≥n de base de datos...', 'info');
            
            try {
                // 1. Create admin user
                await createAdminUser();
                
                // 2. Create sample professionals
                await createSampleProfessionals();
                
                // 3. Create sample ratings
                await createSampleRatings();
                
                // 4. Create system configuration
                await createSystemConfig();
                
                // 5. Calculate initial rankings
                await calculateAllRankings();
                
                log('‚úÖ Base de datos inicializada correctamente', 'success');
            } catch (error) {
                log('‚ùå Error durante la inicializaci√≥n: ' + error.message, 'error');
            }
        }

        async function createAdminUser() {
            try {
                const adminData = {
                    email: "admin@tecniya.com",
                    name: "Administrador",
                    role: "superadmin",
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // We don't store password in Firestore for security, use Firebase Auth separately
                await db.collection('admin_users').doc('admin').set(adminData);
                log('Usuario administrador creado', 'success');
            } catch (error) {
                log('Error creando admin: ' + error.message, 'error');
            }
        }

        async function createSampleProfessionals() {
            const sampleProfessionals = [
                {
                    name: "Juan P√©rez",
                    phone: "3415551234",
                    provincia: "Santa Fe",
                    ciudad: "Rosario",
                    rubros: ["plomeria", "gas"],
                    bio: "Plomero matriculado con 15 a√±os de experiencia en instalaciones domiciliarias y comerciales. Especialista en reparaci√≥n de calderas y sistemas de gas.",
                    photoUrl: "https://randomuser.me/api/portraits/men/32.jpg",
                    active: true,
                    isFeatured: true,
                    certifications: ["Gasista Matriculado", "Plomero Profesional"],
                    completedJobs: 45,
                    avgResponseTime: 4,
                    experienceYears: 15,
                    zonas: ["Centro", "Norte", "Fisherton"],
                    rankingScore: 0, // Will be calculated
                    averageRating: 0,
                    totalRatings: 0,
                    lastActive: firebase.firestore.FieldValue.serverTimestamp()
                },
                {
                    name: "Mar√≠a Garc√≠a",
                    phone: "3415555678",
                    provincia: "Santa Fe",
                    ciudad: "Rosario",
                    rubros: ["electricidad"],
                    bio: "Electricista certificada con 10 a√±os de experiencia. Especialista en instalaciones el√©ctricas domiciliarias y reparaci√≥n de tableros.",
                    photoUrl: "https://randomuser.me/api/portraits/women/44.jpg",
                    active: true,
                    isFeatured: true,
                    certifications: ["Electricista Certificada"],
                    completedJobs: 32,
                    avgResponseTime: 2,
                    experienceYears: 10,
                    zonas: ["Centro", "Sur", "Alberdi"],
                    rankingScore: 0,
                    averageRating: 0,
                    totalRatings: 0,
                    lastActive: firebase.firestore.FieldValue.serverTimestamp()
                },
                {
                    name: "Carlos L√≥pez",
                    phone: "3415559012",
                    provincia: "Buenos Aires",
                    ciudad: "La Plata",
                    rubros: ["aire", "electricidad"],
                    bio: "T√©cnico especializado en aire acondicionado y refrigeraci√≥n. Servicio t√©cnico de todas las marcas.",
                    photoUrl: "https://randomuser.me/api/portraits/men/67.jpg",
                    active: true,
                    isFeatured: false,
                    certifications: ["T√©cnico en Refrigeraci√≥n"],
                    completedJobs: 28,
                    avgResponseTime: 6,
                    experienceYears: 8,
                    zonas: ["Centro", "Este", "Oeste"],
                    rankingScore: 0,
                    averageRating: 0,
                    totalRatings: 0,
                    lastActive: firebase.firestore.FieldValue.serverTimestamp()
                },
                {
                    name: "Ana Mart√≠nez",
                    phone: "3415553456",
                    provincia: "C√≥rdoba",
                    ciudad: "C√≥rdoba",
                    rubros: ["plomeria", "jardineria"],
                    bio: "Fontanera y jardinera con amplia experiencia. Trabajos de plomer√≠a general y dise√±o de jardines.",
                    photoUrl: "https://randomuser.me/api/portraits/women/68.jpg",
                    active: true,
                    isFeatured: true,
                    certifications: ["Jardiner√≠a Profesional"],
                    completedJobs: 19,
                    avgResponseTime: 8,
                    experienceYears: 6,
                    zonas: ["Nueva C√≥rdoba", "Centro", "General Paz"],
                    rankingScore: 0,
                    averageRating: 0,
                    totalRatings: 0,
                    lastActive: firebase.firestore.FieldValue.serverTimestamp()
                }
            ];
            
            try {
                for (const pro of sampleProfessionals) {
                    await db.collection('professionals').add(pro);
                }
                log(`${sampleProfessionals.length} profesionales de ejemplo creados`, 'success');
            } catch (error) {
                log('Error creando profesionales: ' + error.message, 'error');
            }
        }

        async function createSampleRatings() {
            // We'll create ratings after professionals are created
            // First, get the professionals to assign ratings
            const professionalsSnapshot = await db.collection('professionals').limit(4).get();
            const professionals = [];
            professionalsSnapshot.forEach(doc => {
                professionals.push({ id: doc.id, ...doc.data() });
            });
            
            if (professionals.length === 0) {
                log('No hay profesionales para asignar calificaciones', 'error');
                return;
            }
            
            const sampleRatings = [
                { professionalId: professionals[0].id, rating: 5, comment: "Excelente servicio, muy profesional", clientPhone: "3415551111" },
                { professionalId: professionals[0].id, rating: 4, comment: "Buen trabajo, puntual", clientPhone: "3415552222" },
                { professionalId: professionals[0].id, rating: 5, comment: "Resolvi√≥ mi problema r√°pidamente", clientPhone: "3415553333" },
                { professionalId: professionals[1].id, rating: 5, comment: "Muy detallista y cuidadosa", clientPhone: "3415554444" },
                { professionalId: professionals[1].id, rating: 4, comment: "Buen precio y calidad", clientPhone: "3415555555" },
                { professionalId: professionals[2].id, rating: 3, comment: "Trabajo aceptable", clientPhone: "3415556666" },
                { professionalId: professionals[3].id, rating: 5, comment: "Transform√≥ mi jard√≠n, incre√≠ble", clientPhone: "3415557777" },
            ];
            
            try {
                for (const rating of sampleRatings) {
                    await db.collection('ratings').add({
                        ...rating,
                        status: 'approved',
                        ipAddress: '127.0.0.1',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                log(`${sampleRatings.length} calificaciones de ejemplo creadas`, 'success');
            } catch (error) {
                log('Error creando calificaciones: ' + error.message, 'error');
            }
        }

        async function createSystemConfig() {
            const config = {
                ratingWeight: 5,
                responseWeight: 15,
                certWeight: 2,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            try {
                await db.collection('system_config').doc('ranking').set(config);
                log('Configuraci√≥n del sistema creada', 'success');
            } catch (error) {
                log('Error creando configuraci√≥n: ' + error.message, 'error');
            }
        }

        async function calculateAllRankings() {
            log('Calculando rankings de todos los profesionales...', 'info');
            
            try {
                const professionalsSnapshot = await db.collection('professionals').get();
                let count = 0;
                
                for (const doc of professionalsSnapshot.docs) {
                    await calculateProfessionalRanking(doc.id);
                    count++;
                }
                
                log(`‚úÖ Rankings calculados para ${count} profesionales`, 'success');
            } catch (error) {
                log('‚ùå Error calculando rankings: ' + error.message, 'error');
            }
        }

        async function calculateProfessionalRanking(professionalId) {
            try {
                // Get professional data
                const professionalDoc = await db.collection('professionals').doc(professionalId).get();
                const professional = professionalDoc.data();
                
                // Get approved ratings for this professional (last 3 months)
                const threeMonthsAgo = new Date();
                threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
                
                const ratingsSnapshot = await db.collection('ratings')
                    .where('professionalId', '==', professionalId)
                    .where('status', '==', 'approved')
                    .where('createdAt', '>=', threeMonthsAgo)
                    .get();
                
                let totalRatings = 0;
                let sumRatings = 0;
                
                ratingsSnapshot.forEach(doc => {
                    totalRatings++;
                    sumRatings += doc.data().rating;
                });
                
                // Calculate average rating
                const averageRating = totalRatings > 0 ? (sumRatings / totalRatings) : 0;
                
                // Calculate ranking score (same algorithm as in main app)
                let score = 0;
                
                // 1. Rating quality (25 points max)
                score += averageRating * 5;
                
                // 2. Rating quantity (20 points max)
                const ratingQuantity = Math.min(totalRatings, 100);
                score += ratingQuantity * 0.2;
                
                // 3. Response time (15 points)
                if (professional.avgResponseTime && professional.avgResponseTime < 24) {
                    score += 15;
                } else if (professional.avgResponseTime && professional.avgResponseTime < 48) {
                    score += 10;
                }
                
                // 4. Completed jobs (10 points)
                if (professional.completedJobs) {
                    score += Math.min(professional.completedJobs * 0.1, 10);
                }
                
                // 5. Certifications (10 points)
                if (professional.certifications && professional.certifications.length > 0) {
                    score += Math.min(professional.certifications.length * 2, 10);
                }
                
                // 6. Profile completeness (5 points)
                let profileScore = 0;
                if (professional.photoUrl) profileScore++;
                if (professional.bio && professional.bio.length > 50) profileScore++;
                if (professional.zonas && professional.zonas.length > 0) profileScore++;
                if (professional.rubros && professional.rubros.length > 0) profileScore++;
                score += profileScore * 1.25;
                
                // 7. Experience (5 points)
                if (professional.experienceYears) {
                    score += Math.min(professional.experienceYears * 0.5, 5);
                }
                
                // 8. Recent activity (5 points)
                if (professional.lastActive) {
                    const daysSince = (new Date() - professional.lastActive.toDate()) / (1000 * 60 * 60 * 24);
                    if (daysSince < 7) score += 5;
                    else if (daysSince < 30) score += 3;
                }
                
                // 9. Featured status (5 points)
                if (professional.isFeatured) {
                    score += 5;
                }
                
                const rankingScore = Math.round(score);
                
                // Update professional
                await db.collection('professionals').doc(professionalId).update({
                    averageRating: averageRating,
                    totalRatings: totalRatings,
                    rankingScore: rankingScore,
                    rankingUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                return { success: true };
                
            } catch (error) {
                console.error("Error calculating ranking for professional", professionalId, error);
                return { success: false, error: error.message };
            }
        }

        async function clearTestData() {
            log('Eliminando datos de prueba...', 'info');
            
            try {
                // Delete all professionals
                const professionalsSnapshot = await db.collection('professionals').get();
                for (const doc of professionalsSnapshot.docs) {
                    await doc.ref.delete();
                }
                
                // Delete all ratings
                const ratingsSnapshot = await db.collection('ratings').get();
                for (const doc of ratingsSnapshot.docs) {
                    await doc.ref.delete();
                }
                
                log('‚úÖ Todos los datos de prueba eliminados', 'success');
            } catch (error) {
                log('‚ùå Error eliminando datos: ' + error.message, 'error');
            }
        }

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
    </script>
</body>
</html>

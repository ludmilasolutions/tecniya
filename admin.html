<!DOCTYPE html>
<html lang="es-AR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TecniYa - Panel Administrador Nacional</title>
    <!-- Favicon inline para evitar error 404 -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üîß</text></svg>">
    
    <style>
        /* MANTENER TODOS LOS ESTILOS ORIGINALES */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif; }
        body { background-color: #f8f9fa; color: #333; line-height: 1.6; }
        .container { width: 100%; max-width: 1400px; margin: 0 auto; padding: 20px; }
        a { text-decoration: none; color: #0a4fd8; }
        ul { list-style: none; }
        
        /* HEADER */
        .header { background: linear-gradient(135deg, #333 0%, #555 100%); color: white; padding: 25px 20px; text-align: center; }
        .header h1 { font-size: 2rem; margin-bottom: 8px; font-weight: 800; }
        .header-subtitle { opacity: 0.9; }
        
        /* TABS */
        .tabs { display: flex; background: white; border-bottom: 2px solid #eaeaea; overflow-x: auto; flex-wrap: wrap; }
        .tab { padding: 18px 25px; font-weight: 600; cursor: pointer; border-bottom: 3px solid transparent; white-space: nowrap; }
        .tab.active { border-bottom-color: #dc3545; color: #dc3545; background-color: #fff5f5; }
        .tab-logout { margin-left: auto; background: #333; color: white; }
        
        /* PANELS */
        .panel { display: none; background: white; padding: 30px; border-radius: 0 0 12px 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .panel.active { display: block; }
        
        /* LOGIN */
        .login-container { max-width: 500px; margin: 80px auto; padding: 40px; background: white; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .login-title { text-align: center; font-size: 1.8rem; margin-bottom: 30px; color: #333; }
        
        /* FORMS */
        .form-group { margin-bottom: 25px; }
        .form-label { display: block; font-weight: 600; margin-bottom: 10px; color: #444; }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 15px; border: 2px solid #e1e5e9; border-radius: 10px; font-size: 1rem; transition: border 0.3s; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { border-color: #0a4fd8; outline: none; }
        .form-textarea { min-height: 120px; resize: vertical; }
        .form-row { display: flex; gap: 20px; }
        .form-row .form-group { flex: 1; }
        
        /* TABLES */
        .data-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.95rem; }
        .data-table th, .data-table td { padding: 15px; text-align: left; border-bottom: 1px solid #eaeaea; }
        .data-table th { background-color: #f8f9fa; font-weight: 700; position: sticky; top: 0; }
        .data-table tr:hover { background-color: #f8f9fa; }
        .table-container { max-height: 600px; overflow-y: auto; border: 1px solid #eaeaea; border-radius: 12px; }
        .table-photo { width: 50px; height: 50px; object-fit: cover; border-radius: 6px; }
        
        /* RANKING BADGES */
        .ranking-badge {
            display: inline-flex;
            align-items: center;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 700;
            gap: 5px;
        }
        
        .ranking-platinum { background: linear-gradient(135deg, #e5e4e2 0%, #b4b4b4 100%); color: #333; }
        .ranking-gold { background: linear-gradient(135deg, #ffd700 0%, #daa520 100%); color: #333; }
        .ranking-silver { background: linear-gradient(135deg, #c0c0c0 0%, #a9a9a9 100%); color: #333; }
        .ranking-bronze { background: linear-gradient(135deg, #cd7f32 0%, #b87333 100%); color: white; }
        .ranking-beginner { background: #6c757d; color: white; }
        
        /* BADGES */
        .badge { display: inline-block; padding: 5px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 700; }
        .badge-success { background: #d4edda; color: #155724; }
        .badge-warning { background: #fff3cd; color: #856404; }
        .badge-danger { background: #f8d7da; color: #721c24; }
        .badge-info { background: #d1ecf1; color: #0c5460; }
        .badge-primary { background: #d1e7ff; color: #0a4fd8; }
        
        /* BUTTONS */
        .btn { padding: 12px 24px; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; border: none; transition: all 0.3s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-sm { padding: 8px 16px; font-size: 0.9rem; }
        .btn-primary { background-color: #0a4fd8; color: white; }
        .btn-primary:hover { background-color: #083bb5; }
        .btn-success { background-color: #1db954; color: white; }
        .btn-success:hover { background-color: #17a344; }
        .btn-danger { background-color: #dc3545; color: white; }
        .btn-danger:hover { background-color: #c82333; }
        .btn-warning { background-color: #ffc107; color: #333; }
        .btn-warning:hover { background-color: #e0a800; }
        .btn-block { width: 100%; }
        .btn-group { display: flex; gap: 10px; flex-wrap: wrap; }
        
        /* CARDS */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 25px; margin: 30px 0; }
        .stat-card { background: #f8f9fa; padding: 25px; border-radius: 12px; text-align: center; }
        .stat-number { font-size: 2.5rem; font-weight: 700; color: #0a4fd8; }
        .stat-label { margin-top: 10px; color: #666; }
        
        /* RANKING PROGRESS */
        .ranking-progress {
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 5px 0;
        }
        
        .ranking-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #0a4fd8 0%, #1a60f0 100%);
            border-radius: 4px;
        }
        
        /* BANNER PREVIEW */
        .banner-preview { max-width: 800px; margin: 20px 0; border-radius: 12px; overflow: hidden; border: 2px solid #eaeaea; }
        .banner-preview-img { width: 100%; height: auto; display: block; }
        
        /* LOADER */
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid #dc3545; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 40px auto; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* FILTERS */
        .filters { background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 30px; display: flex; gap: 20px; flex-wrap: wrap; }
        .filter-group { display: flex; align-items: center; gap: 10px; }
        
        /* MODAL */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal-content { background: white; width: 90%; max-width: 600px; margin: 50px auto; padding: 30px; border-radius: 16px; max-height: 80vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .modal-close { font-size: 2rem; cursor: pointer; color: #666; }
        
        /* RESPONSIVE */
        @media (max-width: 768px) {
            .form-row { flex-direction: column; }
            .tabs { flex-direction: column; }
            .tab { text-align: center; }
            .filters { flex-direction: column; }
        }
    </style>
</head>
<body>
    <!-- LOGIN -->
    <div id="loginContainer" class="login-container">
        <h2 class="login-title">üîê Admin TecniYa</h2>
        <div class="form-group">
            <label class="form-label">Email</label>
            <input type="email" id="loginEmail" class="form-input" placeholder="admin@tecniya.com">
        </div>
        <div class="form-group">
            <label class="form-label">Contrase√±a</label>
            <input type="password" id="loginPassword" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        </div>
        <button id="loginBtn" class="btn btn-primary btn-block">Ingresar</button>
        <div id="loginMessage" style="margin-top: 20px; padding: 15px; border-radius: 8px; display: none;"></div>
    </div>
    
    <!-- MAIN ADMIN -->
    <div id="adminPanel" style="display: none;">
        <header class="header">
            <h1>‚öô Panel Administrador TecniYa Nacional</h1>
            <p class="header-subtitle">Gesti√≥n completa de profesionales, banners y configuraci√≥n para toda Argentina</p>
        </header>
        
        <div class="container">
            <!-- TABS -->
            <div class="tabs">
                <div class="tab active" data-tab="dashboard">üìä Dashboard</div>
                <div class="tab" data-tab="professionals">üë®‚Äçüîß Profesionales</div>
                <div class="tab" data-tab="ranking">üèÜ Ranking</div>
                <div class="tab" data-tab="banners">üì¢ Banners</div>
                <div class="tab" data-tab="config">‚öô Configuraci√≥n</div>
                <div class="tab tab-logout" id="logoutBtn">üö™ Cerrar Sesi√≥n</div>
            </div>
            
            <!-- DASHBOARD -->
            <div id="dashboardPanel" class="panel active">
                <h2 style="margin-bottom: 30px; color: #333;">Dashboard Nacional</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalProfessionals">0</div>
                        <div class="stat-label">Total Profesionales</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="activeCities">0</div>
                        <div class="stat-label">Ciudades Activas</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="featuredProfessionals">0</div>
                        <div class="stat-label">Destacados Activos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="avgRankingScore">0</div>
                        <div class="stat-label">Puntaje Ranking Prom.</div>
                    </div>
                </div>
                
                <div style="margin-top: 50px;">
                    <h3 style="margin-bottom: 20px;">üìç Distribuci√≥n por Provincia</h3>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Provincia</th>
                                    <th>Profesionales</th>
                                    <th>Avg. Ranking</th>
                                    <th>Destacados</th>
                                    <th>TOP 10</th>
                                </tr>
                            </thead>
                            <tbody id="provinceDistribution">
                                <!-- JS llenar√° esto -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div style="margin-top: 50px;">
                    <h3 style="margin-bottom: 20px;">üèÜ Distribuci√≥n de Niveles</h3>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Nivel</th>
                                    <th>Rango Puntaje</th>
                                    <th>Cantidad</th>
                                    <th>Porcentaje</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="rankingDistribution">
                                <!-- JS llenar√° esto -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- PROFESSIONALS -->
            <div id="professionalsPanel" class="panel">
                <h2 style="margin-bottom: 25px; color: #333;">Gesti√≥n de Profesionales</h2>
                
                <div class="filters">
                    <div class="filter-group">
                        <label>Provincia:</label>
                        <select id="filterProvincia" class="form-select" style="width: 200px;">
                            <option value="">Todas</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Ciudad:</label>
                        <select id="filterCiudad" class="form-select" style="width: 200px;">
                            <option value="">Todas</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Rubro:</label>
                        <select id="filterRubro" class="form-select" style="width: 200px;">
                            <option value="">Todos</option>
                            <option value="plomeria">Plomer√≠a</option>
                            <option value="gas">Gas</option>
                            <option value="electricidad">Electricidad</option>
                            <option value="aire">Aire Acondicionado</option>
                            <option value="albanileria">Alba√±iler√≠a</option>
                            <option value="pintura">Pintura</option>
                            <option value="cerrajeria">Cerrajer√≠a</option>
                            <option value="jardineria">Jardiner√≠a</option>
                            <option value="herreria">Herrer√≠a</option>
                            <option value="carpinteria">Carpinter√≠a</option>
                            <option value="limpieza">Limpieza</option>
                            <option value="mudanzas">Mudanzas</option>
                            <option value="otros">Otros</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Nivel Ranking:</label>
                        <select id="filterRankingLevel" class="form-select" style="width: 200px;">
                            <option value="">Todos</option>
                            <option value="Platino">Platino</option>
                            <option value="Oro">Oro</option>
                            <option value="Plata">Plata</option>
                            <option value="Bronce">Bronce</option>
                            <option value="Principiante">Principiante</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Estado:</label>
                        <select id="filterStatus" class="form-select" style="width: 200px;">
                            <option value="">Todos</option>
                            <option value="active">Activos</option>
                            <option value="incomplete">Incompletos</option>
                            <option value="blocked">Bloqueados</option>
                            <option value="featured">Destacados</option>
                            <option value="certified">Certificados</option>
                        </select>
                    </div>
                    <button id="applyFilters" class="btn btn-primary">üîç Filtrar</button>
                    <button id="resetFilters" class="btn">üîÑ Reiniciar</button>
                </div>
                
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Foto</th>
                                <th>Nombre</th>
                                <th>Ubicaci√≥n</th>
                                <th>Rubros</th>
                                <th>Ranking</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="professionalsTable">
                            <!-- JS llenar√° esto -->
                        </tbody>
                    </table>
                </div>
                
                <div id="professionalDetailModal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>Detalle del Profesional</h3>
                            <span class="modal-close" onclick="closeModal()">√ó</span>
                        </div>
                        <div id="professionalDetailContent">
                            <!-- JS llenar√° esto -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- RANKING -->
            <div id="rankingPanel" class="panel">
                <h2 style="margin-bottom: 25px; color: #333;">üèÜ Gesti√≥n de Rankings</h2>
                
                <div class="filters">
                    <div class="filter-group">
                        <label>Ordenar por:</label>
                        <select id="sortRanking" class="form-select" style="width: 200px;">
                            <option value="rankingScore_desc">Ranking (Alto ‚Üí Bajo)</option>
                            <option value="rankingScore_asc">Ranking (Bajo ‚Üí Alto)</option>
                            <option value="averageRating_desc">Rating (Alto ‚Üí Bajo)</option>
                            <option value="totalRatings_desc">Calificaciones (Muchas ‚Üí Pocas)</option>
                            <option value="lastActive_desc">Actividad (Reciente)</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Nivel:</label>
                        <select id="filterRankingLevelTable" class="form-select" style="width: 200px;">
                            <option value="">Todos los niveles</option>
                            <option value="Platino">Platino</option>
                            <option value="Oro">Oro</option>
                            <option value="Plata">Plata</option>
                            <option value="Bronce">Bronce</option>
                            <option value="Principiante">Principiante</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Provincia:</label>
                        <select id="filterRankingProvincia" class="form-select" style="width: 200px;">
                            <option value="">Todas</option>
                        </select>
                    </div>
                    <button id="applyRankingFilters" class="btn btn-primary">üîç Filtrar</button>
                    <button id="resetRankingFilters" class="btn">üîÑ Reiniciar</button>
                </div>
                
                <div class="btn-group" style="margin-bottom: 20px;">
                    <button onclick="recalculateAllRankings()" class="btn btn-warning">üîÑ Recalcular todos los rankings</button>
                    <button onclick="updateRankingPositions()" class="btn btn-primary">üìä Actualizar posiciones</button>
                    <button onclick="exportRankingData()" class="btn btn-success">üìÑ Exportar datos</button>
                </div>
                
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Pos.</th>
                                <th>Nombre</th>
                                <th>Ubicaci√≥n</th>
                                <th>Puntaje</th>
                                <th>Nivel</th>
                                <th>Rating</th>
                                <th>Factores</th>
                                <th>√ölt. Act.</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="rankingTable">
                            <!-- JS llenar√° esto -->
                        </tbody>
                    </table>
                </div>
                
                <div style="margin-top: 30px; background: #f8f9fa; padding: 20px; border-radius: 12px;">
                    <h3>üìä Estad√≠sticas del Ranking</h3>
                    <div id="rankingStats" style="margin-top: 15px;">
                        <!-- JS llenar√° esto -->
                    </div>
                </div>
            </div>
            
            <!-- BANNERS -->
            <div id="bannersPanel" class="panel">
                <h2 style="margin-bottom: 25px; color: #333;">Gesti√≥n de Banners Publicitarios</h2>
                
                <div class="btn-group" style="margin-bottom: 25px;">
                    <button class="btn btn-success" onclick="showBannerForm()">‚ûï Crear Nuevo Banner</button>
                </div>
                
                <div id="bannerForm" style="display: none; background: #f8f9fa; padding: 30px; border-radius: 12px; margin-bottom: 30px;">
                    <!-- Formulario de banners (mantener igual) -->
                </div>
                
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Imagen</th>
                                <th>T√≠tulo</th>
                                <th>√Åmbito</th>
                                <th>Periodo</th>
                                <th>Estado</th>
                                <th>Clicks</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="bannersTable">
                            <!-- JS llenar√° esto -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- CONFIG -->
            <div id="configPanel" class="panel">
                <h2 style="margin-bottom: 30px; color: #333;">Configuraci√≥n del Sistema</h2>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px;">
                    <div>
                        <h3 style="margin-bottom: 20px;">‚öô Sistema de Ranking</h3>
                        <div class="form-group">
                            <label class="form-label">Puntaje m√≠nimo para aparecer</label>
                            <input type="number" id="minRankingScore" class="form-input" min="0" max="100" value="30">
                            <small style="color: #666;">Los profesionales con menos puntaje no aparecen en b√∫squedas</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Puntaje para destacado autom√°tico</label>
                            <input type="number" id="autoFeaturedScore" class="form-input" min="0" max="100" value="85">
                            <small style="color: #666;">Los profesionales que superen este puntaje se destacan autom√°ticamente</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">D√≠as para considerar "Activo"</label>
                            <input type="number" id="activeDaysThreshold" class="form-input" min="1" max="365" value="30">
                        </div>
                        <button onclick="updateRankingConfig()" class="btn btn-primary">üíæ Guardar configuraci√≥n</button>
                    </div>
                    
                    <div>
                        <h3 style="margin-bottom: 20px;">üí∞ Precios</h3>
                        <div class="form-group">
                            <label class="form-label">Precio destacado (ARS/mes)</label>
                            <input type="number" id="featuredPrice" class="form-input" min="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Precio certificaci√≥n (ARS)</label>
                            <input type="number" id="certificationPrice" class="form-input" min="0">
                        </div>
                        <button onclick="updatePrices()" class="btn btn-primary">üíæ Actualizar precios</button>
                    </div>
                </div>
                
                <div style="margin-top: 50px;">
                    <h3 style="margin-bottom: 20px;">üõ† Herramientas de Administraci√≥n</h3>
                    <div class="btn-group">
                        <button onclick="forceHideNoPhoto()" class="btn btn-warning">üëÅ Ocultar profesionales sin foto</button>
                        <button onclick="deactivateExpiredFeatured()" class="btn btn-warning">üìÖ Desactivar destacados vencidos</button>
                        <button onclick="recalculateAllRankings()" class="btn btn-warning">üìä Recalcular rankings</button>
                        <button onclick="updateRankingPositions()" class="btn btn-warning">üìç Actualizar posiciones</button>
                        <a href="setup.html" target="_blank" class="btn btn-danger">‚ö† Setup Inicial</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="loader" class="loader"></div>
    
    <!-- SCRIPTS DE FIREBASE -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <!-- SCRIPT PRINCIPAL -->
    <script>
        // ============================================
        // DATOS DE PROVINCIAS Y CIUDADES
        // ============================================
        const provinciasCiudades = {
            "Buenos Aires": ["La Plata", "Mar del Plata", "Bah√≠a Blanca", "Quilmes", "Lomas de Zamora", "San Isidro", "Tigre", "Pilar", "Merlo", "Moreno"],
            "CABA": ["Capital Federal"],
            "Catamarca": ["San Fernando del Valle de Catamarca", "Valle Viejo", "Andalgal√°"],
            "Chaco": ["Resistencia", "Barranqueras", "Fontana", "Presidencia Roque S√°enz Pe√±a"],
            "Chubut": ["Rawson", "Comodoro Rivadavia", "Trelew", "Puerto Madryn"],
            "C√≥rdoba": ["C√≥rdoba", "Villa Mar√≠a", "R√≠o Cuarto", "Alta Gracia", "Villa Carlos Paz", "Jes√∫s Mar√≠a"],
            "Corrientes": ["Corrientes", "Goya", "Mercedes", "Curuz√∫ Cuati√°"],
            "Entre R√≠os": ["Paran√°", "Concordia", "Gualeguaych√∫", "Concepci√≥n del Uruguay"],
            "Formosa": ["Formosa", "Clorinda", "Piran√©"],
            "Jujuy": ["San Salvador de Jujuy", "Palpal√°", "San Pedro de Jujuy", "Libertador General San Mart√≠n"],
            "La Pampa": ["Santa Rosa", "General Pico", "Toay", "Realic√≥"],
            "La Rioja": ["La Rioja", "Chilecito", "Aimogasta", "Chamical"],
            "Mendoza": ["Mendoza", "San Rafael", "Godoy Cruz", "Guaymall√©n", "Las Heras", "Maip√∫"],
            "Misiones": ["Posadas", "Ober√°", "Eldorado", "Ap√≥stoles"],
            "Neuqu√©n": ["Neuqu√©n", "Cutral-C√≥", "Plottier", "Centenario"],
            "R√≠o Negro": ["Viedma", "Bariloche", "General Roca", "Cipolletti"],
            "Salta": ["Salta", "San Ram√≥n de la Nueva Or√°n", "Tartagal", "Met√°n"],
            "San Juan": ["San Juan", "Rivadavia", "Chimbas", "Rawson"],
            "San Luis": ["San Luis", "Villa Mercedes", "Juana Koslay", "La Punta"],
            "Santa Cruz": ["R√≠o Gallegos", "Caleta Olivia", "Puerto Deseado", "R√≠o Turbio"],
            "Santa Fe": ["Rosario", "Santa Fe", "Rafaela", "Venado Tuerto", "Reconquista", "Sunchales"],
            "Santiago del Estero": ["Santiago del Estero", "La Banda", "Fr√≠as", "A√±atuya"],
            "Tierra del Fuego": ["Ushuaia", "R√≠o Grande"],
            "Tucum√°n": ["San Miguel de Tucum√°n", "Yerba Buena", "Taf√≠ Viejo", "Concepci√≥n"]
        };

        // ============================================
        // CONFIGURACI√ìN FIREBASE
        // ============================================
        const firebaseConfig = {
          apiKey: "AIzaSyBzDfYDdzmN9J_Y8gG06aqH0OtlzFhafFY",
          authDomain: "tecniya-b4206.firebaseapp.com",
          projectId: "tecniya-b4206",
          storageBucket: "tecniya-b4206.firebasestorage.app",
          messagingSenderId: "166424133304",
          appId: "1:166424133304:web:d1ad23bd4ea1af10437e4d"
        };

        // ============================================
        // VARIABLES GLOBALES
        // ============================================
        let db, auth;
        let allProfessionalsData = [];
        let rankingConfig = {
            minScore: 30,
            autoFeaturedScore: 85,
            activeDays: 30
        };

        // ============================================
        // INICIALIZACI√ìN
        // ============================================
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        auth = firebase.auth();

        // ============================================
        // VERIFICAR ADMIN AL CARGAR
        // ============================================
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                const adminSnapshot = await db.collection('admin_users').where('email', '==', user.email).get();
                if (!adminSnapshot.empty) {
                    document.getElementById('loginContainer').style.display = 'none';
                    document.getElementById('adminPanel').style.display = 'block';
                    loadDashboard();
                    loadProvinciasSelect();
                    loadRankingConfig();
                } else {
                    auth.signOut();
                    showMessage('loginMessage', '‚ùå No ten√©s permisos de administrador', 'error');
                }
            } else {
                document.getElementById('loginContainer').style.display = 'block';
                document.getElementById('adminPanel').style.display = 'none';
            }
        });

        // ============================================
        // SISTEMA DE RANKING - FUNCIONES PRINCIPALES
        // ============================================
        async function calculateProfessionalRanking(professional) {
            try {
                // Obtener calificaciones aprobadas (√∫ltimos 3 meses)
                const threeMonthsAgo = new Date();
                threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
                
                const ratingsSnapshot = await db.collection('ratings')
                    .where('professionalId', '==', professional.id)
                    .where('status', '==', 'approved')
                    .where('createdAt', '>=', threeMonthsAgo)
                    .get();
                
                let totalRatings = 0;
                let sumRatings = 0;
                
                ratingsSnapshot.forEach(doc => {
                    totalRatings++;
                    sumRatings += doc.data().rating;
                });
                
                // Calcular rating promedio
                const averageRating = totalRatings > 0 ? (sumRatings / totalRatings) : 0;
                
                // ============================================
                // C√ÅLCULO DE PUNTAJE DE RANKING
                // ============================================
                let score = 0;
                
                // 1. CALIDAD DE CALIFICACIONES (25 puntos)
                score += averageRating * 5;
                
                // 2. CANTIDAD DE CALIFICACIONES (20 puntos)
                const ratingQuantity = Math.min(totalRatings, 100);
                score += ratingQuantity * 0.2;
                
                // 3. TIEMPO DE RESPUESTA (15 puntos)
                if (professional.avgResponseTime) {
                    if (professional.avgResponseTime < 4) score += 15;
                    else if (professional.avgResponseTime < 8) score += 12;
                    else if (professional.avgResponseTime < 24) score += 8;
                    else if (professional.avgResponseTime < 48) score += 4;
                }
                
                // 4. TRABAJOS COMPLETADOS (10 puntos)
                if (professional.completedJobs) {
                    score += Math.min(professional.completedJobs * 0.1, 10);
                }
                
                // 5. CERTIFICACIONES (10 puntos)
                if (professional.certifications && professional.certifications.length > 0) {
                    score += Math.min(professional.certifications.length * 2, 10);
                }
                
                // 6. COMPLETITUD DEL PERFIL (20 puntos)
                let profileScore = 0;
                if (professional.photoUrl) profileScore += 5;
                if (professional.bio && professional.bio.length > 50) profileScore += 5;
                if (professional.zonas && professional.zonas.length > 0) profileScore += 5;
                if (professional.rubros && professional.rubros.length > 0) profileScore += 5;
                score += profileScore;
                
                // 7. EXPERIENCIA (10 puntos)
                if (professional.experienceYears) {
                    score += Math.min(professional.experienceYears, 10);
                }
                
                // 8. ACTIVIDAD RECIENTE (10 puntos)
                if (professional.lastActive) {
                    const lastActiveDate = professional.lastActive.toDate();
                    const daysSince = (new Date() - lastActiveDate) / (1000 * 60 * 60 * 24);
                    if (daysSince < 7) score += 10;
                    else if (daysSince < 30) score += 7;
                    else if (daysSince < 90) score += 4;
                }
                
                // 9. PERFIL DESTACADO (5 puntos)
                if (professional.isFeatured) {
                    score += 5;
                }
                
                // Asegurar que el score est√© entre 0 y 100
                score = Math.min(Math.max(score, 0), 100);
                const rankingScore = Math.round(score);
                
                // Determinar nivel de ranking
                let rankingLevel = 'Bronce';
                if (rankingScore >= 90) rankingLevel = 'Platino';
                else if (rankingScore >= 80) rankingLevel = 'Oro';
                else if (rankingScore >= 70) rankingLevel = 'Plata';
                else if (rankingScore >= 60) rankingLevel = 'Bronce';
                else rankingLevel = 'Principiante';
                
                // Calcular factores individuales para mostrar
                const factors = {
                    rating: Math.round(averageRating * 5),
                    response: score >= 15 ? 15 : (score >= 12 ? 12 : (score >= 8 ? 8 : (score >= 4 ? 4 : 0))),
                    profile: profileScore,
                    experience: Math.min(professional.experienceYears || 0, 10) + Math.min((professional.completedJobs || 0) * 0.1, 5),
                    activity: score >= 10 ? 10 : (score >= 7 ? 7 : (score >= 4 ? 4 : 0)),
                    featured: professional.isFeatured ? 5 : 0
                };
                
                return {
                    ...professional,
                    averageRating,
                    totalRatings,
                    rankingScore,
                    rankingLevel,
                    rankingFactors: factors,
                    rankingUpdatedAt: new Date()
                };
                
            } catch (error) {
                console.error('Error calculating ranking:', error);
                return {
                    ...professional,
                    averageRating: professional.averageRating || 0,
                    totalRatings: professional.totalRatings || 0,
                    rankingScore: professional.rankingScore || 0,
                    rankingLevel: professional.rankingLevel || 'Principiante',
                    rankingFactors: {
                        rating: 0,
                        response: 0,
                        profile: 0,
                        experience: 0,
                        activity: 0,
                        featured: 0
                    }
                };
            }
        }

        async function recalculateAllRankings() {
            if (!confirm('¬øEst√°s seguro de recalcular todos los rankings? Esto puede tomar unos minutos.')) return;
            
            showLoader();
            
            try {
                const snapshot = await db.collection('professionals').get();
                let count = 0;
                let errors = 0;
                
                for (const doc of snapshot.docs) {
                    try {
                        const professional = { id: doc.id, ...doc.data() };
                        const updatedData = await calculateProfessionalRanking(professional);
                        
                        // Actualizar en Firestore
                        await db.collection('professionals').doc(doc.id).update({
                            averageRating: updatedData.averageRating,
                            totalRatings: updatedData.totalRatings,
                            rankingScore: updatedData.rankingScore,
                            rankingLevel: updatedData.rankingLevel,
                            rankingUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        count++;
                        
                    } catch (error) {
                        errors++;
                        console.error(`Error updating professional ${doc.id}:`, error);
                    }
                }
                
                hideLoader();
                alert(`‚úÖ Rankings recalculados: ${count} profesionales actualizados, ${errors} errores.`);
                
                // Recargar datos
                if (document.querySelector('.tab.active').dataset.tab === 'ranking') {
                    loadRankingTable();
                } else if (document.querySelector('.tab.active').dataset.tab === 'dashboard') {
                    loadDashboard();
                }
                
            } catch (error) {
                hideLoader();
                alert('‚ùå Error recalculando rankings: ' + error.message);
            }
        }

        async function updateRankingPositions() {
            showLoader();
            
            try {
                // Obtener todos los profesionales
                const snapshot = await db.collection('professionals').get();
                const professionals = [];
                
                snapshot.forEach(doc => {
                    professionals.push({ id: doc.id, ...doc.data() });
                });
                
                // Agrupar por ciudad y rubro
                const cities = {};
                const rubros = {};
                
                professionals.forEach(prof => {
                    // Por ciudad
                    if (prof.ciudad) {
                        if (!cities[prof.ciudad]) cities[prof.ciudad] = [];
                        cities[prof.ciudad].push({
                            id: prof.id,
                            score: prof.rankingScore || 0,
                            name: prof.name
                        });
                    }
                    
                    // Por rubro (tomar el primer rubro)
                    if (prof.rubros && prof.rubros.length > 0) {
                        const rubro = prof.rubros[0];
                        if (!rubros[rubro]) rubros[rubro] = [];
                        rubros[rubro].push({
                            id: prof.id,
                            score: prof.rankingScore || 0,
                            name: prof.name
                        });
                    }
                });
                
                // Ordenar y asignar posiciones
                let updatedCount = 0;
                
                for (const prof of professionals) {
                    let positionData = {};
                    
                    // Posici√≥n en ciudad
                    if (prof.ciudad && cities[prof.ciudad]) {
                        cities[prof.ciudad].sort((a, b) => b.score - a.score);
                        const cityPosition = cities[prof.ciudad].findIndex(p => p.id === prof.id) + 1;
                        if (cityPosition > 0) {
                            positionData.cityPosition = cityPosition;
                        }
                    }
                    
                    // Posici√≥n en rubro
                    if (prof.rubros && prof.rubros.length > 0) {
                        const rubro = prof.rubros[0];
                        if (rubros[rubro]) {
                            rubros[rubro].sort((a, b) => b.score - a.score);
                            const rubroPosition = rubros[rubro].findIndex(p => p.id === prof.id) + 1;
                            if (rubroPosition > 0) {
                                positionData.rubroPosition = rubroPosition;
                            }
                        }
                    }
                    
                    // Actualizar si hay posiciones
                    if (Object.keys(positionData).length > 0) {
                        await db.collection('professionals').doc(prof.id).update(positionData);
                        updatedCount++;
                    }
                }
                
                hideLoader();
                alert(`‚úÖ Posiciones actualizadas para ${updatedCount} profesionales`);
                
                if (document.querySelector('.tab.active').dataset.tab === 'ranking') {
                    loadRankingTable();
                }
                
            } catch (error) {
                hideLoader();
                alert('‚ùå Error actualizando posiciones: ' + error.message);
            }
        }

        function getRankingBadge(level) {
            const badges = {
                'Platino': { class: 'ranking-platinum', emoji: 'üèÜ' },
                'Oro': { class: 'ranking-gold', emoji: 'ü•á' },
                'Plata': { class: 'ranking-silver', emoji: 'ü•à' },
                'Bronce': { class: 'ranking-bronze', emoji: 'ü•â' },
                'Principiante': { class: 'ranking-beginner', emoji: '‚≠ê' }
            };
            
            const badge = badges[level] || badges['Principiante'];
            return `<span class="ranking-badge ${badge.class}">${badge.emoji} ${level}</span>`;
        }

        // ============================================
        // DASHBOARD
        // ============================================
        async function loadDashboard() {
            showLoader();
            
            try {
                // Obtener todos los profesionales
                const snapshot = await db.collection('professionals').get();
                allProfessionalsData = [];
                snapshot.forEach(doc => {
                    allProfessionalsData.push({ id: doc.id, ...doc.data() });
                });
                
                // Calcular estad√≠sticas
                const totalProfessionals = allProfessionalsData.length;
                const activeProfessionals = allProfessionalsData.filter(p => p.active).length;
                
                // Ciudades activas
                const citiesSet = new Set();
                allProfessionalsData.forEach(p => {
                    if (p.ciudad) citiesSet.add(p.ciudad);
                });
                
                // Destacados activos
                const now = new Date();
                const featuredActive = allProfessionalsData.filter(p => 
                    p.isFeatured && p.featuredUntil && p.featuredUntil.toDate() > now
                ).length;
                
                // Promedio de ranking
                const totalScore = allProfessionalsData.reduce((sum, p) => sum + (p.rankingScore || 0), 0);
                const avgRanking = totalProfessionals > 0 ? Math.round(totalScore / totalProfessionals) : 0;
                
                // Actualizar estad√≠sticas
                document.getElementById('totalProfessionals').textContent = activeProfessionals;
                document.getElementById('activeCities').textContent = citiesSet.size;
                document.getElementById('featuredProfessionals').textContent = featuredActive;
                document.getElementById('avgRankingScore').textContent = avgRanking;
                
                // Distribuci√≥n por provincia
                await loadProvinceDistribution();
                
                // Distribuci√≥n de niveles
                await loadRankingDistribution();
                
                hideLoader();
            } catch (error) {
                console.error("Error cargando dashboard:", error);
                hideLoader();
            }
        }

        async function loadProvinceDistribution() {
            const distribution = {};
            const now = new Date();
            
            allProfessionalsData.forEach(prof => {
                if (prof.provincia) {
                    if (!distribution[prof.provincia]) {
                        distribution[prof.provincia] = {
                            profesionales: 0,
                            totalScore: 0,
                            destacados: 0,
                            top10: 0
                        };
                    }
                    distribution[prof.provincia].profesionales++;
                    distribution[prof.provincia].totalScore += prof.rankingScore || 0;
                    
                    if (prof.isFeatured && prof.featuredUntil && prof.featuredUntil.toDate() > now) {
                        distribution[prof.provincia].destacados++;
                    }
                    
                    if (prof.rankingScore >= 90) {
                        distribution[prof.provincia].top10++;
                    }
                }
            });
            
            const tbody = document.getElementById('provinceDistribution');
            tbody.innerHTML = '';
            
            Object.keys(distribution).sort().forEach(provincia => {
                const data = distribution[provincia];
                const avgScore = data.profesionales > 0 ? Math.round(data.totalScore / data.profesionales) : 0;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${provincia}</strong></td>
                    <td>${data.profesionales}</td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span>${avgScore}/100</span>
                            <div style="flex: 1; height: 8px; background: #e9ecef; border-radius: 4px; overflow: hidden;">
                                <div style="width: ${avgScore}%; height: 100%; background: #0a4fd8;"></div>
                            </div>
                        </div>
                    </td>
                    <td>${data.destacados}</td>
                    <td>${data.top10}</td>
                `;
                tbody.appendChild(row);
            });
        }

        async function loadRankingDistribution() {
            const levels = {
                'Platino': { min: 90, max: 100, count: 0, emoji: 'üèÜ' },
                'Oro': { min: 80, max: 89, count: 0, emoji: 'ü•á' },
                'Plata': { min: 70, max: 79, count: 0, emoji: 'ü•à' },
                'Bronce': { min: 60, max: 69, count: 0, emoji: 'ü•â' },
                'Principiante': { min: 0, max: 59, count: 0, emoji: '‚≠ê' }
            };
            
            allProfessionalsData.forEach(prof => {
                const score = prof.rankingScore || 0;
                for (const [level, data] of Object.entries(levels)) {
                    if (score >= data.min && score <= data.max) {
                        data.count++;
                        break;
                    }
                }
            });
            
            const total = allProfessionalsData.length;
            const tbody = document.getElementById('rankingDistribution');
            tbody.innerHTML = '';
            
            Object.entries(levels).forEach(([level, data]) => {
                const percentage = total > 0 ? Math.round((data.count / total) * 100) : 0;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <span class="ranking-badge ${level === 'Platino' ? 'ranking-platinum' : level === 'Oro' ? 'ranking-gold' : level === 'Plata' ? 'ranking-silver' : level === 'Bronce' ? 'ranking-bronze' : 'ranking-beginner'}">
                            ${data.emoji} ${level}
                        </span>
                    </td>
                    <td>${data.min}-${data.max}</td>
                    <td>${data.count}</td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span>${percentage}%</span>
                            <div style="flex: 1; height: 8px; background: #e9ecef; border-radius: 4px; overflow: hidden;">
                                <div style="width: ${percentage}%; height: 100%; background: #0a4fd8;"></div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <button onclick="filterByLevel('${level}')" class="btn btn-sm btn-primary">Ver</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // ============================================
        // TABLA DE RANKING
        // ============================================
        async function loadRankingTable() {
            showLoader();
            
            try {
                let query = db.collection('professionals');
                
                // Aplicar filtros
                const provincia = document.getElementById('filterRankingProvincia').value;
                const level = document.getElementById('filterRankingLevelTable').value;
                const sortBy = document.getElementById('sortRanking').value;
                
                if (provincia) {
                    query = query.where('provincia', '==', provincia);
                }
                
                const snapshot = await query.get();
                let professionals = [];
                
                snapshot.forEach(doc => {
                    professionals.push({ id: doc.id, ...doc.data() });
                });
                
                // Filtrar por nivel
                if (level) {
                    professionals = professionals.filter(p => p.rankingLevel === level);
                }
                
                // Ordenar
                const [field, order] = sortBy.split('_');
                professionals.sort((a, b) => {
                    let aVal = a[field] || 0;
                    let bVal = b[field] || 0;
                    
                    // Para fechas
                    if (field === 'lastActive') {
                        aVal = a.lastActive ? a.lastActive.toDate().getTime() : 0;
                        bVal = b.lastActive ? b.lastActive.toDate().getTime() : 0;
                    }
                    
                    return order === 'desc' ? bVal - aVal : aVal - bVal;
                });
                
                // Actualizar tabla
                const tbody = document.getElementById('rankingTable');
                tbody.innerHTML = '';
                
                professionals.forEach((prof, index) => {
                    const position = index + 1;
                    const lastActive = prof.lastActive ? 
                        prof.lastActive.toDate().toLocaleDateString('es-AR') : 'Nunca';
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            <strong style="font-size: 1.2rem;">${position}</strong>
                            ${position <= 3 ? 'üî•' : ''}
                        </td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <img src="${prof.photoUrl || 'https://via.placeholder.com/40x40/0a4fd8/ffffff?text=NO+FOTO'}" 
                                     style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;"
                                     onerror="this.src='https://via.placeholder.com/40x40/0a4fd8/ffffff?text=NO+FOTO'">
                                <div>
                                    <strong>${prof.name || 'Sin nombre'}</strong><br>
                                    <small style="color: #666;">${prof.email || ''}</small>
                                </div>
                            </div>
                        </td>
                        <td>
                            ${prof.ciudad || 'Sin ciudad'},<br>
                            ${prof.provincia || 'Sin provincia'}
                            ${prof.cityPosition ? `<br><small>üìç #${prof.cityPosition} en ciudad</small>` : ''}
                            ${prof.rubroPosition && prof.rubros ? `<br><small>‚≠ê #${prof.rubroPosition} en ${prof.rubros[0]}</small>` : ''}
                        </td>
                        <td>
                            <strong style="font-size: 1.2rem;">${prof.rankingScore || 0}</strong>/100
                            <div class="ranking-progress">
                                <div class="ranking-progress-bar" style="width: ${prof.rankingScore || 0}%"></div>
                            </div>
                            <small style="color: #666;">${getRankingBadge(prof.rankingLevel || 'Principiante')}</small>
                        </td>
                        <td>
                            ${getRankingBadge(prof.rankingLevel || 'Principiante')}
                        </td>
                        <td>
                            <strong>${prof.averageRating ? prof.averageRating.toFixed(1) : '0.0'}</strong> ‚≠ê<br>
                            <small>${prof.totalRatings || 0} calificaciones</small>
                        </td>
                        <td>
                            <small>
                                ‚≠ê ${prof.rankingScore >= 25 ? '25' : prof.rankingScore}/25<br>
                                üöÄ ${prof.avgResponseTime || 'N/A'}<br>
                                üìù ${prof.profileCompleted ? 'Completo' : 'Incompleto'}<br>
                                ${prof.isFeatured ? 'üåü Destacado' : ''}
                            </small>
                        </td>
                        <td>
                            ${lastActive}
                        </td>
                        <td>
                            <div class="btn-group">
                                <button onclick="viewProfessionalDetail('${prof.id}')" class="btn btn-sm">üëÅ Ver</button>
                                <button onclick="recalculateProfessionalRanking('${prof.id}')" class="btn btn-warning btn-sm">üîÑ Recalcular</button>
                                ${prof.rankingScore >= rankingConfig.autoFeaturedScore && !prof.isFeatured ? 
                                    `<button onclick="activateFeatured('${prof.id}')" class="btn btn-success btn-sm">üåü Destacar</button>` : ''}
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                // Actualizar estad√≠sticas
                updateRankingStats(professionals);
                
                hideLoader();
            } catch (error) {
                console.error("Error cargando tabla de ranking:", error);
                hideLoader();
            }
        }

        function updateRankingStats(professionals) {
            const total = professionals.length;
            if (total === 0) {
                document.getElementById('rankingStats').innerHTML = '<p>No hay datos para mostrar</p>';
                return;
            }
            
            const totalScore = professionals.reduce((sum, p) => sum + (p.rankingScore || 0), 0);
            const avgScore = Math.round(totalScore / total);
            
            const top10 = professionals.filter(p => p.rankingScore >= 90).length;
            const featured = professionals.filter(p => p.isFeatured).length;
            const certified = professionals.filter(p => p.certifications && p.certifications.length > 0).length;
            
            document.getElementById('rankingStats').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                    <div style="background: white; padding: 15px; border-radius: 8px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #0a4fd8;">${avgScore}</div>
                        <div style="color: #666;">Puntaje promedio</div>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 8px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #ffc107;">${top10}</div>
                        <div style="color: #666;">TOP 10 (90+ puntos)</div>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 8px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #1db954;">${featured}</div>
                        <div style="color: #666;">Destacados</div>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 8px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #17a2b8;">${certified}</div>
                        <div style="color: #666;">Certificados</div>
                    </div>
                </div>
            `;
        }

        // ============================================
        // FUNCIONES AUXILIARES
        // ============================================
        async function recalculateProfessionalRanking(professionalId) {
            showLoader();
            
            try {
                const doc = await db.collection('professionals').doc(professionalId).get();
                if (!doc.exists) {
                    alert('Profesional no encontrado');
                    return;
                }
                
                const professional = { id: doc.id, ...doc.data() };
                const updatedData = await calculateProfessionalRanking(professional);
                
                await db.collection('professionals').doc(professionalId).update({
                    averageRating: updatedData.averageRating,
                    totalRatings: updatedData.totalRatings,
                    rankingScore: updatedData.rankingScore,
                    rankingLevel: updatedData.rankingLevel,
                    rankingUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                hideLoader();
                alert(`‚úÖ Ranking recalculado: ${updatedData.rankingScore} puntos (${updatedData.rankingLevel})`);
                
                if (document.querySelector('.tab.active').dataset.tab === 'ranking') {
                    loadRankingTable();
                }
                
            } catch (error) {
                hideLoader();
                alert('‚ùå Error recalculando ranking: ' + error.message);
            }
        }

        async function loadRankingConfig() {
            try {
                const doc = await db.collection('admin_config').doc('ranking').get();
                if (doc.exists) {
                    const data = doc.data();
                    rankingConfig.minScore = data.minScore || 30;
                    rankingConfig.autoFeaturedScore = data.autoFeaturedScore || 85;
                    rankingConfig.activeDays = data.activeDays || 30;
                    
                    document.getElementById('minRankingScore').value = rankingConfig.minScore;
                    document.getElementById('autoFeaturedScore').value = rankingConfig.autoFeaturedScore;
                    document.getElementById('activeDaysThreshold').value = rankingConfig.activeDays;
                }
            } catch (error) {
                console.error("Error cargando configuraci√≥n de ranking:", error);
            }
        }

        async function updateRankingConfig() {
            try {
                rankingConfig.minScore = parseInt(document.getElementById('minRankingScore').value) || 30;
                rankingConfig.autoFeaturedScore = parseInt(document.getElementById('autoFeaturedScore').value) || 85;
                rankingConfig.activeDays = parseInt(document.getElementById('activeDaysThreshold').value) || 30;
                
                await db.collection('admin_config').doc('ranking').set(rankingConfig, { merge: true });
                alert('‚úÖ Configuraci√≥n de ranking actualizada');
            } catch (error) {
                alert('‚ùå Error actualizando configuraci√≥n: ' + error.message);
            }
        }

        function filterByLevel(level) {
            // Cambiar a la pesta√±a de ranking y aplicar filtro
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            
            document.querySelector('.tab[data-tab="ranking"]').classList.add('active');
            document.getElementById('rankingPanel').classList.add('active');
            
            document.getElementById('filterRankingLevelTable').value = level;
            loadRankingTable();
        }

        function exportRankingData() {
            // Implementar exportaci√≥n a CSV
            alert('Funci√≥n de exportaci√≥n en desarrollo');
        }

        // ============================================
        // FUNCIONES EXISTENTES (mantener del admin original)
        // ============================================
        // [Aqu√≠ van todas las funciones del admin.html original que no est√°n relacionadas con ranking]
        // Como: loadProfessionals, viewProfessionalDetail, blockProfessional, etc.
        // Estas funciones se mantienen igual que en el admin.html original

        // ============================================
        // INICIALIZACI√ìN DE EVENT LISTENERS
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            // Login
            document.getElementById('loginBtn').addEventListener('click', async () => {
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                
                try {
                    await auth.signInWithEmailAndPassword(email, password);
                } catch (error) {
                    showMessage('loginMessage', '‚ùå Error: ' + error.message, 'error');
                }
            });

            // Logout
            document.getElementById('logoutBtn').addEventListener('click', () => {
                auth.signOut();
            });

            // Tabs
            document.querySelectorAll('.tab:not(.tab-logout)').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
                    
                    tab.classList.add('active');
                    document.getElementById(`${tabId}Panel`).classList.add('active');
                    
                    if (tabId === 'dashboard') loadDashboard();
                    if (tabId === 'professionals') loadProfessionals();
                    if (tabId === 'ranking') loadRankingTable();
                    if (tabId === 'banners') loadBanners();
                    if (tabId === 'config') loadConfig();
                });
            });

            // Filtros de ranking
            document.getElementById('applyRankingFilters').addEventListener('click', loadRankingTable);
            document.getElementById('resetRankingFilters').addEventListener('click', () => {
                document.getElementById('sortRanking').value = 'rankingScore_desc';
                document.getElementById('filterRankingLevelTable').value = '';
                document.getElementById('filterRankingProvincia').value = '';
                loadRankingTable();
            });
        });

        // ============================================
        // FUNCIONES DE UTILIDAD
        // ============================================
        function showLoader() {
            document.getElementById('loader').style.display = 'block';
        }

        function hideLoader() {
            document.getElementById('loader').style.display = 'none';
        }

        function showMessage(elementId, text, type) {
            const el = document.getElementById(elementId);
            el.textContent = text;
            el.style.background = type === 'error' ? '#f8d7da' : '#d4edda';
            el.style.color = type === 'error' ? '#721c24' : '#155724';
            el.style.display = 'block';
            setTimeout(() => { el.style.display = 'none'; }, 5000);
        }

        // Funci√≥n para cargar provincias en selects
        function loadProvinciasSelect() {
            const selects = [
                'filterProvincia',
                'filterRankingProvincia',
                'rankingFilterProvincia'
            ];
            
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    const provincias = Object.keys(provinciasCiudades).sort();
                    provincias.forEach(provincia => {
                        const option = document.createElement('option');
                        option.value = provincia;
                        option.textContent = provincia;
                        select.appendChild(option);
                    });
                }
            });
        }
    </script>
</body>
</html>

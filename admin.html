<!DOCTYPE html>
<html lang="es-AR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TecniYa - Panel Administrador Nacional</title>
    <!-- Favicon inline -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üîß</text></svg>">
    
    <style>
        /* ===== VARIABLES & RESET ===== */
        :root {
            --primary: #0a4fd8;
            --primary-dark: #083bb5;
            --secondary: #1db954;
            --secondary-dark: #17a344;
            --danger: #dc3545;
            --warning: #ffc107;
            --info: #17a2b8;
            --light: #f8f9fa;
            --dark: #333;
            --gray: #666;
            --light-gray: #e1e5e9;
            --shadow: 0 4px 12px rgba(10, 79, 216, 0.15);
            --radius: 12px;
            --transition: all 0.3s ease;
        }
        
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif; 
        }
        
        body { 
            background-color: var(--light); 
            color: var(--dark); 
            line-height: 1.6; 
        }
        
        /* ===== LAYOUT ===== */
        .container { 
            width: 100%; 
            max-width: 1400px; 
            margin: 0 auto; 
            padding: 20px; 
        }
        
        a { 
            text-decoration: none; 
            color: var(--primary); 
        }
        
        ul { 
            list-style: none; 
        }
        
        /* ===== HEADER ===== */
        .header { 
            background: linear-gradient(135deg, var(--dark) 0%, #555 100%); 
            color: white; 
            padding: 25px 20px; 
            text-align: center; 
        }
        
        .header h1 { 
            font-size: 2rem; 
            margin-bottom: 8px; 
            font-weight: 800; 
        }
        
        .header-subtitle { 
            opacity: 0.9; 
        }
        
        /* ===== TABS ===== */
        .tabs { 
            display: flex; 
            background: white; 
            border-bottom: 2px solid #eaeaea; 
            overflow-x: auto; 
            flex-wrap: wrap; 
        }
        
        .tab { 
            padding: 18px 25px; 
            font-weight: 600; 
            cursor: pointer; 
            border-bottom: 3px solid transparent; 
            white-space: nowrap; 
            transition: var(--transition);
        }
        
        .tab:hover {
            background-color: #f8f9fa;
            color: var(--primary);
        }
        
        .tab.active { 
            border-bottom-color: var(--danger); 
            color: var(--danger); 
            background-color: #fff5f5; 
        }
        
        .tab-logout { 
            margin-left: auto; 
            background: var(--dark); 
            color: white; 
        }
        
        /* ===== PANELS ===== */
        .panel { 
            display: none; 
            background: white; 
            padding: 30px; 
            border-radius: 0 0 var(--radius) var(--radius); 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); 
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .panel.active { 
            display: block; 
        }
        
        /* ===== LOGIN ===== */
        .login-container { 
            max-width: 500px; 
            margin: 80px auto; 
            padding: 40px; 
            background: white; 
            border-radius: 16px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
        }
        
        .login-title { 
            text-align: center; 
            font-size: 1.8rem; 
            margin-bottom: 30px; 
            color: var(--dark); 
        }
        
        /* ===== FORMS ===== */
        .form-group { 
            margin-bottom: 25px; 
        }
        
        .form-label { 
            display: block; 
            font-weight: 600; 
            margin-bottom: 10px; 
            color: #444; 
        }
        
        .form-input, .form-select, .form-textarea { 
            width: 100%; 
            padding: 15px; 
            border: 2px solid var(--light-gray); 
            border-radius: 10px; 
            font-size: 1rem; 
            transition: border 0.3s; 
        }
        
        .form-input:focus, .form-select:focus, .form-textarea:focus { 
            border-color: var(--primary); 
            outline: none; 
        }
        
        .form-textarea { 
            min-height: 120px; 
            resize: vertical; 
        }
        
        .form-row { 
            display: flex; 
            gap: 20px; 
        }
        
        .form-row .form-group { 
            flex: 1; 
        }
        
        /* ===== TABLES ===== */
        .data-table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 20px; 
            font-size: 0.95rem; 
        }
        
        .data-table th, .data-table td { 
            padding: 15px; 
            text-align: left; 
            border-bottom: 1px solid #eaeaea; 
        }
        
        .data-table th { 
            background-color: #f8f9fa; 
            font-weight: 700; 
            position: sticky; 
            top: 0; 
        }
        
        .data-table tr:hover { 
            background-color: #f8f9fa; 
        }
        
        .table-container { 
            max-height: 600px; 
            overflow-y: auto; 
            border: 1px solid #eaeaea; 
            border-radius: var(--radius); 
        }
        
        .table-photo { 
            width: 50px; 
            height: 50px; 
            object-fit: cover; 
            border-radius: 6px; 
        }
        
        /* ===== RANKING BADGES ===== */
        .ranking-badge {
            display: inline-flex;
            align-items: center;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 700;
            gap: 5px;
        }
        
        .ranking-platinum { 
            background: linear-gradient(135deg, #e5e4e2 0%, #b4b4b4 100%); 
            color: #333; 
        }
        
        .ranking-gold { 
            background: linear-gradient(135deg, #ffd700 0%, #daa520 100%); 
            color: #333; 
        }
        
        .ranking-silver { 
            background: linear-gradient(135deg, #c0c0c0 0%, #a9a9a9 100%); 
            color: #333; 
        }
        
        .ranking-bronze { 
            background: linear-gradient(135deg, #cd7f32 0%, #b87333 100%); 
            color: white; 
        }
        
        .ranking-beginner { 
            background: #6c757d; 
            color: white; 
        }
        
        /* ===== BADGES ===== */
        .badge { 
            display: inline-block; 
            padding: 5px 12px; 
            border-radius: 20px; 
            font-size: 0.85rem; 
            font-weight: 700; 
        }
        
        .badge-success { 
            background: #d4edda; 
            color: #155724; 
        }
        
        .badge-warning { 
            background: #fff3cd; 
            color: #856404; 
        }
        
        .badge-danger { 
            background: #f8d7da; 
            color: #721c24; 
        }
        
        .badge-info { 
            background: #d1ecf1; 
            color: #0c5460; 
        }
        
        .badge-primary { 
            background: #d1e7ff; 
            color: var(--primary); 
        }
        
        /* ===== BUTTONS ===== */
        .btn { 
            padding: 12px 24px; 
            border-radius: 8px; 
            font-size: 1rem; 
            font-weight: 600; 
            cursor: pointer; 
            border: none; 
            transition: all 0.3s; 
            display: inline-flex; 
            align-items: center; 
            gap: 8px; 
        }
        
        .btn-sm { 
            padding: 8px 16px; 
            font-size: 0.9rem; 
        }
        
        .btn-primary { 
            background-color: var(--primary); 
            color: white; 
        }
        
        .btn-primary:hover { 
            background-color: var(--primary-dark); 
        }
        
        .btn-success { 
            background-color: var(--secondary); 
            color: white; 
        }
        
        .btn-success:hover { 
            background-color: var(--secondary-dark); 
        }
        
        .btn-danger { 
            background-color: var(--danger); 
            color: white; 
        }
        
        .btn-danger:hover { 
            background-color: #c82333; 
        }
        
        .btn-warning { 
            background-color: var(--warning); 
            color: #333; 
        }
        
        .btn-warning:hover { 
            background-color: #e0a800; 
        }
        
        .btn-block { 
            width: 100%; 
        }
        
        .btn-group { 
            display: flex; 
            gap: 10px; 
            flex-wrap: wrap; 
        }
        
        /* ===== CARDS ===== */
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 25px; 
            margin: 30px 0; 
        }
        
        .stat-card { 
            background: #f8f9fa; 
            padding: 25px; 
            border-radius: var(--radius); 
            text-align: center; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            transition: var(--transition);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        .stat-number { 
            font-size: 2.5rem; 
            font-weight: 700; 
            color: var(--primary); 
        }
        
        .stat-label { 
            margin-top: 10px; 
            color: var(--gray); 
        }
        
        /* ===== RANKING PROGRESS ===== */
        .ranking-progress {
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 5px 0;
        }
        
        .ranking-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary) 0%, #1a60f0 100%);
            border-radius: 4px;
        }
        
        /* ===== MESSAGES ===== */
        .message {
            padding: 1.5rem;
            border-radius: var(--radius);
            margin-bottom: 1.5rem;
            font-weight: 600;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .message-success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }
        
        .message-error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid var(--danger);
        }
        
        .message-info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid var(--info);
        }
        
        /* ===== BANNER PREVIEW ===== */
        .banner-preview { 
            max-width: 800px; 
            margin: 20px 0; 
            border-radius: var(--radius); 
            overflow: hidden; 
            border: 2px solid #eaeaea; 
        }
        
        .banner-preview-img { 
            width: 100%; 
            height: auto; 
            display: block; 
        }
        
        /* ===== LOADER ===== */
        .loader { 
            border: 5px solid #f3f3f3; 
            border-top: 5px solid var(--danger); 
            border-radius: 50%; 
            width: 50px; 
            height: 50px; 
            animation: spin 1s linear infinite; 
            margin: 40px auto; 
            display: none; 
        }
        
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        
        /* ===== FILTERS ===== */
        .filters { 
            background: #f8f9fa; 
            padding: 20px; 
            border-radius: var(--radius); 
            margin-bottom: 30px; 
            display: flex; 
            gap: 20px; 
            flex-wrap: wrap; 
        }
        
        .filter-group { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
        }
        
        /* ===== MODAL ===== */
        .modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.5); 
            z-index: 1000; 
        }
        
        .modal-content { 
            background: white; 
            width: 90%; 
            max-width: 600px; 
            margin: 50px auto; 
            padding: 30px; 
            border-radius: 16px; 
            max-height: 80vh; 
            overflow-y: auto; 
        }
        
        .modal-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 25px; 
        }
        
        .modal-close { 
            font-size: 2rem; 
            cursor: pointer; 
            color: var(--gray); 
        }
        
        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .form-row { 
                flex-direction: column; 
            }
            
            .tabs { 
                flex-direction: column; 
            }
            
            .tab { 
                text-align: center; 
            }
            
            .filters { 
                flex-direction: column; 
            }
            
            .btn-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- LOGIN -->
    <div id="loginContainer" class="login-container">
        <h2 class="login-title">üîê Admin TecniYa</h2>
        <div class="form-group">
            <label class="form-label">Email</label>
            <input type="email" id="loginEmail" class="form-input" placeholder="admin@tecniya.com">
        </div>
        <div class="form-group">
            <label class="form-label">Contrase√±a</label>
            <input type="password" id="loginPassword" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        </div>
        <button id="loginBtn" class="btn btn-primary btn-block">Ingresar</button>
        <div id="loginMessage" class="message" style="display: none;"></div>
    </div>
    
    <!-- MAIN ADMIN -->
    <div id="adminPanel" style="display: none;">
        <header class="header">
            <h1>‚öô Panel Administrador TecniYa Nacional</h1>
            <p class="header-subtitle">Gesti√≥n completa de profesionales, ranking y configuraci√≥n</p>
        </header>
        
        <div class="container">
            <!-- TABS -->
            <div class="tabs">
                <div class="tab active" data-tab="dashboard">üìä Dashboard</div>
                <div class="tab" data-tab="professionals">üë®‚Äçüîß Profesionales</div>
                <div class="tab" data-tab="ranking">üèÜ Ranking</div>
                <div class="tab" data-tab="ratings">‚≠ê Calificaciones</div>
                <div class="tab" data-tab="banners">üì¢ Banners</div>
                <div class="tab" data-tab="config">‚öô Configuraci√≥n</div>
                <div class="tab tab-logout" id="logoutBtn">üö™ Cerrar Sesi√≥n</div>
            </div>
            
            <!-- DASHBOARD -->
            <div id="dashboardPanel" class="panel active">
                <h2 style="margin-bottom: 30px; color: var(--dark);">Dashboard Nacional</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalProfessionals">0</div>
                        <div class="stat-label">Total Profesionales</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="activeCities">0</div>
                        <div class="stat-label">Ciudades Activas</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="featuredProfessionals">0</div>
                        <div class="stat-label">Destacados Activos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="avgRankingScore">0</div>
                        <div class="stat-label">Puntaje Ranking Prom.</div>
                    </div>
                </div>
                
                <div style="margin-top: 50px;">
                    <h3 style="margin-bottom: 20px;">üìç Distribuci√≥n por Provincia</h3>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Provincia</th>
                                    <th>Profesionales</th>
                                    <th>Avg. Ranking</th>
                                    <th>Destacados</th>
                                    <th>TOP 10</th>
                                </tr>
                            </thead>
                            <tbody id="provinceDistribution">
                                <!-- JS llenar√° esto -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div style="margin-top: 50px;">
                    <h3 style="margin-bottom: 20px;">üèÜ Distribuci√≥n de Niveles de Ranking</h3>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Nivel</th>
                                    <th>Rango Puntaje</th>
                                    <th>Cantidad</th>
                                    <th>Porcentaje</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="rankingDistribution">
                                <!-- JS llenar√° esto -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- PROFESSIONALS -->
            <div id="professionalsPanel" class="panel">
                <h2 style="margin-bottom: 25px; color: var(--dark);">Gesti√≥n de Profesionales</h2>
                
                <div class="filters">
                    <div class="filter-group">
                        <label>Provincia:</label>
                        <select id="filterProvincia" class="form-select" style="width: 200px;">
                            <option value="">Todas</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Ciudad:</label>
                        <select id="filterCiudad" class="form-select" style="width: 200px;">
                            <option value="">Todas</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Rubro:</label>
                        <select id="filterRubro" class="form-select" style="width: 200px;">
                            <option value="">Todos</option>
                            <option value="plomeria">Plomer√≠a</option>
                            <option value="gas">Gas</option>
                            <option value="electricidad">Electricidad</option>
                            <option value="aire">Aire Acondicionado</option>
                            <option value="albanileria">Alba√±iler√≠a</option>
                            <option value="pintura">Pintura</option>
                            <option value="cerrajeria">Cerrajer√≠a</option>
                            <option value="jardineria">Jardiner√≠a</option>
                            <option value="herreria">Herrer√≠a</option>
                            <option value="carpinteria">Carpinter√≠a</option>
                            <option value="limpieza">Limpieza</option>
                            <option value="mudanzas">Mudanzas</option>
                            <option value="otros">Otros</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Nivel Ranking:</label>
                        <select id="filterRankingLevel" class="form-select" style="width: 200px;">
                            <option value="">Todos</option>
                            <option value="Platino">Platino</option>
                            <option value="Oro">Oro</option>
                            <option value="Plata">Plata</option>
                            <option value="Bronce">Bronce</option>
                            <option value="Principiante">Principiante</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Estado:</label>
                        <select id="filterStatus" class="form-select" style="width: 200px;">
                            <option value="">Todos</option>
                            <option value="active">Activos</option>
                            <option value="incomplete">Incompletos</option>
                            <option value="blocked">Bloqueados</option>
                            <option value="featured">Destacados</option>
                            <option value="certified">Certificados</option>
                        </select>
                    </div>
                    <button id="applyFilters" class="btn btn-primary">üîç Filtrar</button>
                    <button id="resetFilters" class="btn">üîÑ Reiniciar</button>
                </div>
                
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Foto</th>
                                <th>Nombre</th>
                                <th>Ubicaci√≥n</th>
                                <th>Contacto</th>
                                <th>Rubros</th>
                                <th>Puntaje Ranking</th>
                                <th>Nivel</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="professionalsTable">
                            <!-- JS llenar√° esto -->
                        </tbody>
                    </table>
                </div>
                
                <div id="professionalDetailModal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>Detalle del Profesional</h3>
                            <span class="modal-close" onclick="closeModal()">√ó</span>
                        </div>
                        <div id="professionalDetailContent">
                            <!-- JS llenar√° esto -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- RANKING -->
            <div id="rankingPanel" class="panel">
                <h2 style="margin-bottom: 25px; color: var(--dark);">üèÜ Gesti√≥n de Rankings</h2>
                
                <div class="filters">
                    <div class="filter-group">
                        <label>Ordenar por:</label>
                        <select id="sortRanking" class="form-select" style="width: 200px;">
                            <option value="rankingScore_desc">Ranking (Alto ‚Üí Bajo)</option>
                            <option value="rankingScore_asc">Ranking (Bajo ‚Üí Alto)</option>
                            <option value="averageRating_desc">Rating (Alto ‚Üí Bajo)</option>
                            <option value="totalRatings_desc">Calificaciones (Muchas ‚Üí Pocas)</option>
                            <option value="lastActive_desc">Actividad (Reciente)</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Nivel:</label>
                        <select id="filterRankingLevelTable" class="form-select" style="width: 200px;">
                            <option value="">Todos los niveles</option>
                            <option value="Platino">Platino</option>
                            <option value="Oro">Oro</option>
                            <option value="Plata">Plata</option>
                            <option value="Bronce">Bronce</option>
                            <option value="Principiante">Principiante</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Provincia:</label>
                        <select id="filterRankingProvincia" class="form-select" style="width: 200px;">
                            <option value="">Todas</option>
                        </select>
                    </div>
                    <button id="applyRankingFilters" class="btn btn-primary">üîç Filtrar</button>
                    <button id="resetRankingFilters" class="btn">üîÑ Reiniciar</button>
                </div>
                
                <div class="btn-group" style="margin-bottom: 20px;">
                    <button onclick="recalculateAllRankings()" class="btn btn-warning">üîÑ Recalcular todos los rankings</button>
                    <button onclick="updateRankingPositions()" class="btn btn-primary">üìä Actualizar posiciones</button>
                    <button onclick="exportRankingData()" class="btn btn-success">üìÑ Exportar datos</button>
                </div>
                
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Pos.</th>
                                <th>Nombre</th>
                                <th>Ubicaci√≥n</th>
                                <th>Puntaje</th>
                                <th>Nivel</th>
                                <th>Rating</th>
                                <th>Factores</th>
                                <th>√ölt. Act.</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="rankingTable">
                            <!-- JS llenar√° esto -->
                        </tbody>
                    </table>
                </div>
                
                <div style="margin-top: 30px; background: #f8f9fa; padding: 20px; border-radius: var(--radius);">
                    <h3>üìä Estad√≠sticas del Ranking</h3>
                    <div id="rankingStats" style="margin-top: 15px;">
                        <!-- JS llenar√° esto -->
                    </div>
                </div>
            </div>
            
            <!-- RATINGS -->
            <div id="ratingsPanel" class="panel">
                <h2 style="margin-bottom: 25px; color: var(--dark);">‚≠ê Gesti√≥n de Calificaciones</h2>
                
                <div class="filters">
                    <div class="filter-group">
                        <label>Estado:</label>
                        <select id="filterRatingStatus" class="form-select" style="width: 200px;">
                            <option value="pending">Pendientes</option>
                            <option value="approved">Aprobadas</option>
                            <option value="rejected">Rechazadas</option>
                            <option value="all">Todas</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Desde:</label>
                        <input type="date" id="filterRatingDateFrom" class="form-input" style="width: 150px;">
                    </div>
                    <div class="filter-group">
                        <label>Hasta:</label>
                        <input type="date" id="filterRatingDateTo" class="form-input" style="width: 150px;">
                    </div>
                    <button id="applyRatingFilters" class="btn btn-primary">üîç Filtrar</button>
                    <button id="resetRatingFilters" class="btn">üîÑ Reiniciar</button>
                </div>
                
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Profesional</th>
                                <th>Cliente</th>
                                <th>Calificaci√≥n</th>
                                <th>Comentario</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="ratingsTable">
                            <!-- JS llenar√° esto -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- BANNERS -->
            <div id="bannersPanel" class="panel">
                <h2 style="margin-bottom: 25px; color: var(--dark);">üì¢ Gesti√≥n de Banners Publicitarios</h2>
                
                <div class="btn-group" style="margin-bottom: 25px;">
                    <button class="btn btn-success" onclick="showBannerForm()">‚ûï Crear Nuevo Banner</button>
                </div>
                
                <div id="bannerForm" style="display: none; background: #f8f9fa; padding: 30px; border-radius: var(--radius); margin-bottom: 30px;">
                    <h3 style="margin-bottom: 20px;" id="bannerFormTitle">Nuevo Banner</h3>
                    <form id="bannerFormElement">
                        <input type="hidden" id="bannerId">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">T√≠tulo del banner</label>
                                <input type="text" id="bannerTitle" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Enlace (URL)</label>
                                <input type="url" id="bannerLink" class="form-input" required>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">URL de la imagen del banner</label>
                            <input type="url" id="bannerImageUrl" class="form-input" required 
                                   placeholder="https://ejemplo.com/banner.jpg">
                            <small style="color: var(--gray);">
                                üåü <strong>Servicios GRATIS para subir im√°genes:</strong><br>
                                1. <a href="https://imgur.com" target="_blank">Imgur.com</a> - Sube, luego copia "Direct Link"<br>
                                2. <a href="https://postimages.org" target="_blank">Postimages.org</a> - Sube, copia "Direct Link"<br>
                                3. <a href="https://imgbb.com" target="_blank">ImgBB.com</a> - Sin registro necesario
                            </small>
                            <div id="bannerImagePreview" style="margin-top: 15px;"></div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">√Åmbito</label>
                                <select id="bannerAmbito" class="form-select" required onchange="toggleBannerLocation()">
                                    <option value="nacional">Nacional (todo el pa√≠s)</option>
                                    <option value="provincial">Provincial</option>
                                    <option value="local">Local (ciudad espec√≠fica)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Posici√≥n</label>
                                <select id="bannerPosition" class="form-select" required>
                                    <option value="home">Home (arriba de b√∫squeda)</option>
                                    <option value="results">Resultados (entre profesionales)</option>
                                </select>
                            </div>
                        </div>
                        
                        <div id="bannerLocationFields" style="display: none;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Provincia</label>
                                    <select id="bannerProvincia" class="form-select">
                                        <option value="">Seleccion√° provincia</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Ciudad</label>
                                    <select id="bannerCiudad" class="form-select" disabled>
                                        <option value="">Seleccion√° ciudad</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Rubros objetivo (opcional)</label>
                            <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-top: 10px;">
                                <label style="display: flex; align-items: center; gap: 5px;">
                                    <input type="checkbox" name="bannerRubros" value="plomeria"> Plomer√≠a
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px;">
                                    <input type="checkbox" name="bannerRubros" value="gas"> Gas
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px;">
                                    <input type="checkbox" name="bannerRubros" value="electricidad"> Electricidad
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px;">
                                    <input type="checkbox" name="bannerRubros" value="aire"> Aire Acondicionado
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px;">
                                    <input type="checkbox" name="bannerRubros" value="todos"> Todos los rubros
                                </label>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Fecha inicio</label>
                                <input type="date" id="bannerStartDate" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Fecha fin</label>
                                <input type="date" id="bannerEndDate" class="form-input" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Prioridad (1-10)</label>
                                <input type="number" id="bannerPriority" class="form-input" min="1" max="10" value="5" required>
                                <small style="color: var(--gray);">Los banners con mayor prioridad tienen m√°s probabilidades de aparecer</small>
                            </div>
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 10px;">
                                    <input type="checkbox" id="bannerActive" checked>
                                    <span>Banner activo</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="btn-group">
                            <button type="submit" class="btn btn-primary">üíæ Guardar Banner</button>
                            <button type="button" class="btn" onclick="hideBannerForm()">‚ùå Cancelar</button>
                        </div>
                    </form>
                </div>
                
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Imagen</th>
                                <th>T√≠tulo</th>
                                <th>√Åmbito</th>
                                <th>Periodo</th>
                                <th>Estado</th>
                                <th>Clicks</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="bannersTable">
                            <!-- JS llenar√° esto -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- CONFIG -->
            <div id="configPanel" class="panel">
                <h2 style="margin-bottom: 30px; color: var(--dark);">Configuraci√≥n del Sistema</h2>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px;">
                    <div>
                        <h3 style="margin-bottom: 20px;">‚öô Sistema de Ranking</h3>
                        <div class="form-group">
                            <label class="form-label">Puntaje m√≠nimo para aparecer</label>
                            <input type="number" id="minRankingScore" class="form-input" min="0" max="100" value="30">
                            <small style="color: var(--gray);">Los profesionales con menos puntaje no aparecen en b√∫squedas</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Puntaje para destacado autom√°tico</label>
                            <input type="number" id="autoFeaturedScore" class="form-input" min="0" max="100" value="85">
                            <small style="color: var(--gray);">Los profesionales que superen este puntaje se destacan autom√°ticamente</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">D√≠as para considerar "Activo"</label>
                            <input type="number" id="activeDaysThreshold" class="form-input" min="1" max="365" value="30">
                        </div>
                        <button onclick="updateRankingConfig()" class="btn btn-primary">üíæ Guardar configuraci√≥n</button>
                    </div>
                    
                    <div>
                        <h3 style="margin-bottom: 20px;">üí∞ Precios</h3>
                        <div class="form-group">
                            <label class="form-label">Precio destacado (ARS/mes)</label>
                            <input type="number" id="featuredPrice" class="form-input" min="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Precio certificaci√≥n (ARS)</label>
                            <input type="number" id="certificationPrice" class="form-input" min="0">
                        </div>
                        <button onclick="updatePrices()" class="btn btn-primary">üíæ Actualizar precios</button>
                    </div>
                </div>
                
                <div style="margin-top: 50px; border-top: 2px solid var(--light-gray); padding-top: 30px;">
                    <h3 style="margin-bottom: 20px;">üõ† Herramientas de Administraci√≥n</h3>
                    <div class="btn-group">
                        <button onclick="forceHideNoPhoto()" class="btn btn-warning">üëÅ Ocultar profesionales sin foto</button>
                        <button onclick="deactivateExpiredFeatured()" class="btn btn-warning">üìÖ Desactivar destacados vencidos</button>
                        <button onclick="recalculateAllRankings()" class="btn btn-warning">üìä Recalcular rankings</button>
                        <button onclick="updateRankingPositions()" class="btn btn-warning">üìç Actualizar posiciones</button>
                    </div>
                </div>
                
                <div style="margin-top: 50px; background: #f8f9fa; padding: 25px; border-radius: var(--radius);">
                    <h3 style="margin-bottom: 15px;">üìã Exportar Datos</h3>
                    <div class="btn-group">
                        <button onclick="exportProfessionals()" class="btn">üìÑ Exportar profesionales</button>
                        <button onclick="exportQuotes()" class="btn">üìã Exportar presupuestos</button>
                        <button onclick="exportBanners()" class="btn">üñº Exportar banners</button>
                        <button onclick="exportRankingData()" class="btn btn-success">üèÜ Exportar ranking</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="loader" class="loader"></div>
    
    <!-- SCRIPTS DE FIREBASE -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <!-- SCRIPT PRINCIPAL -->
    <script>
        // ============================================
        // DATOS DE PROVINCIAS Y CIUDADES
        // ============================================
        const provinciasCiudades = {
            "Buenos Aires": ["La Plata", "Mar del Plata", "Bah√≠a Blanca", "Quilmes", "Lomas de Zamora", "San Isidro", "Tigre", "Pilar", "Merlo", "Moreno"],
            "CABA": ["Capital Federal"],
            "Catamarca": ["San Fernando del Valle de Catamarca", "Valle Viejo", "Andalgal√°"],
            "Chaco": ["Resistencia", "Barranqueras", "Fontana", "Presidencia Roque S√°enz Pe√±a"],
            "Chubut": ["Rawson", "Comodoro Rivadavia", "Trelew", "Puerto Madryn"],
            "C√≥rdoba": ["C√≥rdoba", "Villa Mar√≠a", "R√≠o Cuarto", "Alta Gracia", "Villa Carlos Paz", "Jes√∫s Mar√≠a"],
            "Corrientes": ["Corrientes", "Goya", "Mercedes", "Curuz√∫ Cuati√°"],
            "Entre R√≠os": ["Paran√°", "Concordia", "Gualeguaych√∫", "Concepci√≥n del Uruguay"],
            "Formosa": ["Formosa", "Clorinda", "Piran√©"],
            "Jujuy": ["San Salvador de Jujuy", "Palpal√°", "San Pedro de Jujuy", "Libertador General San Mart√≠n"],
            "La Pampa": ["Santa Rosa", "General Pico", "Toay", "Realic√≥"],
            "La Rioja": ["La Rioja", "Chilecito", "Aimogasta", "Chamical"],
            "Mendoza": ["Mendoza", "San Rafael", "Godoy Cruz", "Guaymall√©n", "Las Heras", "Maip√∫"],
            "Misiones": ["Posadas", "Ober√°", "Eldorado", "Ap√≥stoles"],
            "Neuqu√©n": ["Neuqu√©n", "Cutral-C√≥", "Plottier", "Centenario"],
            "R√≠o Negro": ["Viedma", "Bariloche", "General Roca", "Cipolletti"],
            "Salta": ["Salta", "San Ram√≥n de la Nueva Or√°n", "Tartagal", "Met√°n"],
            "San Juan": ["San Juan", "Rivadavia", "Chimbas", "Rawson"],
            "San Luis": ["San Luis", "Villa Mercedes", "Juana Koslay", "La Punta"],
            "Santa Cruz": ["R√≠o Gallegos", "Caleta Olivia", "Puerto Deseado", "R√≠o Turbio"],
            "Santa Fe": ["Rosario", "Santa Fe", "Rafaela", "Venado Tuerto", "Reconquista", "Sunchales"],
            "Santiago del Estero": ["Santiago del Estero", "La Banda", "Fr√≠as", "A√±atuya"],
            "Tierra del Fuego": ["Ushuaia", "R√≠o Grande"],
            "Tucum√°n": ["San Miguel de Tucum√°n", "Yerba Buena", "Taf√≠ Viejo", "Concepci√≥n"]
        };

        // ============================================
        // CONFIGURACI√ìN FIREBASE
        // ============================================
        const firebaseConfig = {
          apiKey: "AIzaSyBzDfYDdzmN9J_Y8gG06aqH0OtlzFhafFY",
          authDomain: "tecniya-b4206.firebaseapp.com",
          projectId: "tecniya-b4206",
          storageBucket: "tecniya-b4206.firebasestorage.app",
          messagingSenderId: "166424133304",
          appId: "1:166424133304:web:d1ad23bd4ea1af10437e4d"
        };

        // ============================================
        // VARIABLES GLOBALES
        // ============================================
        let db, auth;
        let allProfessionalsData = [];
        let rankingConfig = {
            minScore: 30,
            autoFeaturedScore: 85,
            activeDays: 30
        };

        // ============================================
        // INICIALIZACI√ìN
        // ============================================
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        auth = firebase.auth();

        // ============================================
        // FUNCI√ìN loadRankingConfig
        // ============================================
        async function loadRankingConfig() {
            try {
                const doc = await db.collection('admin_config').doc('ranking').get();
                if (doc.exists) {
                    const data = doc.data();
                    rankingConfig.minScore = data.minScore || 30;
                    rankingConfig.autoFeaturedScore = data.autoFeaturedScore || 85;
                    rankingConfig.activeDays = data.activeDays || 30;
                    
                    document.getElementById('minRankingScore').value = rankingConfig.minScore;
                    document.getElementById('autoFeaturedScore').value = rankingConfig.autoFeaturedScore;
                    document.getElementById('activeDaysThreshold').value = rankingConfig.activeDays;
                }
            } catch (error) {
                console.error("Error cargando configuraci√≥n de ranking:", error);
            }
        }

        // ============================================
        // VERIFICAR ADMIN AL CARGAR
        // ============================================
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                const adminSnapshot = await db.collection('admin_users').where('email', '==', user.email).get();
                if (!adminSnapshot.empty) {
                    document.getElementById('loginContainer').style.display = 'none';
                    document.getElementById('adminPanel').style.display = 'block';
                    loadDashboard();
                    loadProvinciasSelect();
                    loadRankingConfig();
                    loadConfig();
                } else {
                    auth.signOut();
                    showMessage('loginMessage', '‚ùå No ten√©s permisos de administrador', 'error');
                }
            } else {
                document.getElementById('loginContainer').style.display = 'block';
                document.getElementById('adminPanel').style.display = 'none';
            }
        });

        // ============================================
        // SISTEMA DE RANKING - FUNCIONES PRINCIPALES
        // ============================================
        async function calculateProfessionalRanking(professional) {
            try {
                // Obtener calificaciones aprobadas (√∫ltimos 3 meses)
                const threeMonthsAgo = new Date();
                threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
                
                const ratingsSnapshot = await db.collection('ratings')
                    .where('professionalId', '==', professional.id)
                    .where('status', '==', 'approved')
                    .where('createdAt', '>=', threeMonthsAgo)
                    .get();
                
                let totalRatings = 0;
                let sumRatings = 0;
                
                ratingsSnapshot.forEach(doc => {
                    totalRatings++;
                    sumRatings += doc.data().rating;
                });
                
                // Calcular rating promedio
                const averageRating = totalRatings > 0 ? (sumRatings / totalRatings) : 0;
                
                // ============================================
                // C√ÅLCULO DE PUNTAJE DE RANKING (0-100)
                // ============================================
                let score = 0;
                
                // 1. CALIDAD DE CALIFICACIONES (25 puntos)
                score += averageRating * 5;
                
                // 2. CANTIDAD DE CALIFICACIONES (20 puntos)
                const ratingQuantity = Math.min(totalRatings, 100);
                score += ratingQuantity * 0.2;
                
                // 3. TIEMPO DE RESPUESTA (15 puntos)
                if (professional.avgResponseTime) {
                    if (professional.avgResponseTime < 4) score += 15;
                    else if (professional.avgResponseTime < 8) score += 12;
                    else if (professional.avgResponseTime < 24) score += 8;
                    else if (professional.avgResponseTime < 48) score += 4;
                }
                
                // 4. TRABAJOS COMPLETADOS (10 puntos)
                if (professional.completedJobs) {
                    score += Math.min(professional.completedJobs * 0.1, 10);
                }
                
                // 5. CERTIFICACIONES (10 puntos)
                if (professional.certifications && professional.certifications.length > 0) {
                    score += Math.min(professional.certifications.length * 2, 10);
                }
                
                // 6. COMPLETITUD DEL PERFIL (20 puntos)
                let profileScore = 0;
                if (professional.photoUrl) profileScore += 5;
                if (professional.bio && professional.bio.length > 50) profileScore += 5;
                if (professional.zonas && professional.zonas.length > 0) profileScore += 5;
                if (professional.rubros && professional.rubros.length > 0) profileScore += 5;
                score += profileScore;
                
                // 7. EXPERIENCIA (10 puntos)
                if (professional.experienceYears) {
                    score += Math.min(professional.experienceYears, 10);
                }
                
                // 8. ACTIVIDAD RECIENTE (10 puntos)
                if (professional.lastActive) {
                    const lastActiveDate = professional.lastActive.toDate();
                    const daysSince = (new Date() - lastActiveDate) / (1000 * 60 * 60 * 24);
                    if (daysSince < 7) score += 10;
                    else if (daysSince < 30) score += 7;
                    else if (daysSince < 90) score += 4;
                }
                
                // 9. PERFIL DESTACADO (5 puntos)
                if (professional.isFeatured) {
                    score += 5;
                }
                
                // Asegurar que el score est√© entre 0 y 100
                score = Math.min(Math.max(score, 0), 100);
                const rankingScore = Math.round(score);
                
                // Determinar nivel de ranking
                let rankingLevel = 'Bronce';
                if (rankingScore >= 90) rankingLevel = 'Platino';
                else if (rankingScore >= 80) rankingLevel = 'Oro';
                else if (rankingScore >= 70) rankingLevel = 'Plata';
                else if (rankingScore >= 60) rankingLevel = 'Bronce';
                else rankingLevel = 'Principiante';
                
                return {
                    ...professional,
                    averageRating,
                    totalRatings,
                    rankingScore,
                    rankingLevel
                };
                
            } catch (error) {
                console.error('Error calculating ranking:', error);
                return {
                    ...professional,
                    averageRating: professional.averageRating || 0,
                    totalRatings: professional.totalRatings || 0,
                    rankingScore: professional.rankingScore || 0,
                    rankingLevel: professional.rankingLevel || 'Principiante'
                };
            }
        }

        async function recalculateAllRankings() {
            if (!confirm('¬øEst√°s seguro de recalcular todos los rankings? Esto puede tomar unos minutos.')) return;
            
            showLoader();
            
            try {
                const snapshot = await db.collection('professionals').get();
                let count = 0;
                let errors = 0;
                
                for (const doc of snapshot.docs) {
                    try {
                        const professional = { id: doc.id, ...doc.data() };
                        const updatedData = await calculateProfessionalRanking(professional);
                        
                        // Actualizar en Firestore
                        await db.collection('professionals').doc(doc.id).update({
                            averageRating: updatedData.averageRating,
                            totalRatings: updatedData.totalRatings,
                            rankingScore: updatedData.rankingScore,
                            rankingLevel: updatedData.rankingLevel,
                            rankingUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        count++;
                        
                    } catch (error) {
                        errors++;
                        console.error(`Error updating professional ${doc.id}:`, error);
                    }
                }
                
                hideLoader();
                showMessage('loginMessage', `‚úÖ Rankings recalculados: ${count} profesionales actualizados, ${errors} errores.`, 'success');
                
                // Recargar datos
                const activeTab = document.querySelector('.tab.active').dataset.tab;
                if (activeTab === 'ranking') {
                    loadRankingTable();
                } else if (activeTab === 'dashboard') {
                    loadDashboard();
                } else if (activeTab === 'professionals') {
                    loadProfessionals();
                }
                
            } catch (error) {
                hideLoader();
                showMessage('loginMessage', '‚ùå Error recalculando rankings: ' + error.message, 'error');
            }
        }

        async function updateRankingPositions() {
            showLoader();
            
            try {
                // Obtener todos los profesionales
                const snapshot = await db.collection('professionals').get();
                const professionals = [];
                
                snapshot.forEach(doc => {
                    professionals.push({ id: doc.id, ...doc.data() });
                });
                
                // Agrupar por ciudad y rubro
                const cities = {};
                const rubros = {};
                
                professionals.forEach(prof => {
                    // Por ciudad
                    if (prof.ciudad) {
                        if (!cities[prof.ciudad]) cities[prof.ciudad] = [];
                        cities[prof.ciudad].push({
                            id: prof.id,
                            score: prof.rankingScore || 0,
                            name: prof.name
                        });
                    }
                    
                    // Por rubro (tomar el primer rubro)
                    if (prof.rubros && prof.rubros.length > 0) {
                        const rubro = prof.rubros[0];
                        if (!rubros[rubro]) rubros[rubro] = [];
                        rubros[rubro].push({
                            id: prof.id,
                            score: prof.rankingScore || 0,
                            name: prof.name
                        });
                    }
                });
                
                // Ordenar y asignar posiciones
                let updatedCount = 0;
                
                for (const prof of professionals) {
                    let positionData = {};
                    
                    // Posici√≥n en ciudad
                    if (prof.ciudad && cities[prof.ciudad]) {
                        cities[prof.ciudad].sort((a, b) => b.score - a.score);
                        const cityPosition = cities[prof.ciudad].findIndex(p => p.id === prof.id) + 1;
                        if (cityPosition > 0) {
                            positionData.cityPosition = cityPosition;
                        }
                    }
                    
                    // Posici√≥n en rubro
                    if (prof.rubros && prof.rubros.length > 0) {
                        const rubro = prof.rubros[0];
                        if (rubros[rubro]) {
                            rubros[rubro].sort((a, b) => b.score - a.score);
                            const rubroPosition = rubros[rubro].findIndex(p => p.id === prof.id) + 1;
                            if (rubroPosition > 0) {
                                positionData.rubroPosition = rubroPosition;
                            }
                        }
                    }
                    
                    // Actualizar si hay posiciones
                    if (Object.keys(positionData).length > 0) {
                        await db.collection('professionals').doc(prof.id).update(positionData);
                        updatedCount++;
                    }
                }
                
                hideLoader();
                showMessage('loginMessage', `‚úÖ Posiciones actualizadas para ${updatedCount} profesionales`, 'success');
                
                const activeTab = document.querySelector('.tab.active').dataset.tab;
                if (activeTab === 'ranking') {
                    loadRankingTable();
                }
                
            } catch (error) {
                hideLoader();
                showMessage('loginMessage', '‚ùå Error actualizando posiciones: ' + error.message, 'error');
            }
        }

        function getRankingBadge(level) {
            const badges = {
                'Platino': { class: 'ranking-platinum', emoji: 'üèÜ' },
                'Oro': { class: 'ranking-gold', emoji: 'ü•á' },
                'Plata': { class: 'ranking-silver', emoji: 'ü•à' },
                'Bronce': { class: 'ranking-bronze', emoji: 'ü•â' },
                'Principiante': { class: 'ranking-beginner', emoji: '‚≠ê' }
            };
            
            const badge = badges[level] || badges['Principiante'];
            return `<span class="ranking-badge ${badge.class}">${badge.emoji} ${level}</span>`;
        }

        // ============================================
        // DASHBOARD
        // ============================================
        async function loadDashboard() {
            showLoader();
            
            try {
                // Obtener todos los profesionales
                const snapshot = await db.collection('professionals').get();
                allProfessionalsData = [];
                snapshot.forEach(doc => {
                    allProfessionalsData.push({ id: doc.id, ...doc.data() });
                });
                
                // Calcular estad√≠sticas
                const totalProfessionals = allProfessionalsData.length;
                const activeProfessionals = allProfessionalsData.filter(p => p.active).length;
                
                // Ciudades activas
                const citiesSet = new Set();
                allProfessionalsData.forEach(p => {
                    if (p.ciudad) citiesSet.add(p.ciudad);
                });
                
                // Destacados activos
                const now = new Date();
                const featuredActive = allProfessionalsData.filter(p => 
                    p.isFeatured && p.featuredUntil && p.featuredUntil.toDate() > now
                ).length;
                
                // Promedio de ranking
                const totalScore = allProfessionalsData.reduce((sum, p) => sum + (p.rankingScore || 0), 0);
                const avgRanking = totalProfessionals > 0 ? Math.round(totalScore / totalProfessionals) : 0;
                
                // Actualizar estad√≠sticas
                document.getElementById('totalProfessionals').textContent = activeProfessionals;
                document.getElementById('activeCities').textContent = citiesSet.size;
                document.getElementById('featuredProfessionals').textContent = featuredActive;
                document.getElementById('avgRankingScore').textContent = avgRanking;
                
                // Distribuci√≥n por provincia
                await loadProvinceDistribution();
                
                // Distribuci√≥n de niveles
                await loadRankingDistribution();
                
                hideLoader();
            } catch (error) {
                console.error("Error cargando dashboard:", error);
                hideLoader();
                showMessage('loginMessage', '‚ùå Error cargando dashboard', 'error');
            }
        }

        async function loadProvinceDistribution() {
            const distribution = {};
            const now = new Date();
            
            allProfessionalsData.forEach(prof => {
                if (prof.provincia) {
                    if (!distribution[prof.provincia]) {
                        distribution[prof.provincia] = {
                            profesionales: 0,
                            totalScore: 0,
                            destacados: 0,
                            top10: 0
                        };
                    }
                    distribution[prof.provincia].profesionales++;
                    distribution[prof.provincia].totalScore += prof.rankingScore || 0;
                    
                    if (prof.isFeatured && prof.featuredUntil && prof.featuredUntil.toDate() > now) {
                        distribution[prof.provincia].destacados++;
                    }
                    
                    if (prof.rankingScore >= 90) {
                        distribution[prof.provincia].top10++;
                    }
                }
            });
            
            const tbody = document.getElementById('provinceDistribution');
            tbody.innerHTML = '';
            
            Object.keys(distribution).sort().forEach(provincia => {
                const data = distribution[provincia];
                const avgScore = data.profesionales > 0 ? Math.round(data.totalScore / data.profesionales) : 0;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${provincia}</strong></td>
                    <td>${data.profesionales}</td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span>${avgScore}/100</span>
                            <div style="flex: 1; height: 8px; background: #e9ecef; border-radius: 4px; overflow: hidden;">
                                <div style="width: ${avgScore}%; height: 100%; background: var(--primary);"></div>
                            </div>
                        </div>
                    </td>
                    <td>${data.destacados}</td>
                    <td>${data.top10}</td>
                `;
                tbody.appendChild(row);
            });
        }

        async function loadRankingDistribution() {
            const levels = {
                'Platino': { min: 90, max: 100, count: 0, emoji: 'üèÜ' },
                'Oro': { min: 80, max: 89, count: 0, emoji: 'ü•á' },
                'Plata': { min: 70, max: 79, count: 0, emoji: 'ü•à' },
                'Bronce': { min: 60, max: 69, count: 0, emoji: 'ü•â' },
                'Principiante': { min: 0, max: 59, count: 0, emoji: '‚≠ê' }
            };
            
            allProfessionalsData.forEach(prof => {
                const score = prof.rankingScore || 0;
                for (const [level, data] of Object.entries(levels)) {
                    if (score >= data.min && score <= data.max) {
                        data.count++;
                        break;
                    }
                }
            });
            
            const total = allProfessionalsData.length;
            const tbody = document.getElementById('rankingDistribution');
            tbody.innerHTML = '';
            
            Object.entries(levels).forEach(([level, data]) => {
                const percentage = total > 0 ? Math.round((data.count / total) * 100) : 0;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <span class="ranking-badge ${level === 'Platino' ? 'ranking-platinum' : level === 'Oro' ? 'ranking-gold' : level === 'Plata' ? 'ranking-silver' : level === 'Bronce' ? 'ranking-bronze' : 'ranking-beginner'}">
                            ${data.emoji} ${level}
                        </span>
                    </td>
                    <td>${data.min}-${data.max}</td>
                    <td>${data.count}</td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span>${percentage}%</span>
                            <div style="flex: 1; height: 8px; background: #e9ecef; border-radius: 4px; overflow: hidden;">
                                <div style="width: ${percentage}%; height: 100%; background: var(--primary);"></div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <button onclick="filterByLevel('${level}')" class="btn btn-sm btn-primary">Ver</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // ============================================
        // TABLA DE RANKING
        // ============================================
        async function loadRankingTable() {
            showLoader();
            
            try {
                let query = db.collection('professionals');
                
                // Aplicar filtros
                const provincia = document.getElementById('filterRankingProvincia').value;
                const level = document.getElementById('filterRankingLevelTable').value;
                const sortBy = document.getElementById('sortRanking').value;
                
                if (provincia) {
                    query = query.where('provincia', '==', provincia);
                }
                
                const snapshot = await query.get();
                let professionals = [];
                
                snapshot.forEach(doc => {
                    professionals.push({ id: doc.id, ...doc.data() });
                });
                
                // Filtrar por nivel
                if (level) {
                    professionals = professionals.filter(p => p.rankingLevel === level);
                }
                
                // Ordenar
                const [field, order] = sortBy.split('_');
                professionals.sort((a, b) => {
                    let aVal = a[field] || 0;
                    let bVal = b[field] || 0;
                    
                    // Para fechas
                    if (field === 'lastActive') {
                        aVal = a.lastActive ? a.lastActive.toDate().getTime() : 0;
                        bVal = b.lastActive ? b.lastActive.toDate().getTime() : 0;
                    }
                    
                    return order === 'desc' ? bVal - aVal : aVal - bVal;
                });
                
                // Actualizar tabla
                const tbody = document.getElementById('rankingTable');
                tbody.innerHTML = '';
                
                professionals.forEach((prof, index) => {
                    const position = index + 1;
                    const lastActive = prof.lastActive ? 
                        prof.lastActive.toDate().toLocaleDateString('es-AR') : 'Nunca';
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            <strong style="font-size: 1.2rem;">${position}</strong>
                            ${position <= 3 ? 'üî•' : ''}
                        </td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <img src="${prof.photoUrl || 'https://via.placeholder.com/40x40/0a4fd8/ffffff?text=NO+FOTO'}" 
                                     style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;"
                                     onerror="this.src='https://via.placeholder.com/40x40/0a4fd8/ffffff?text=NO+FOTO'">
                                <div>
                                    <strong>${prof.name || 'Sin nombre'}</strong><br>
                                    <small style="color: var(--gray);">${prof.email || ''}</small>
                                </div>
                            </div>
                        </td>
                        <td>
                            ${prof.ciudad || 'Sin ciudad'},<br>
                            ${prof.provincia || 'Sin provincia'}
                            ${prof.cityPosition ? `<br><small>üìç #${prof.cityPosition} en ciudad</small>` : ''}
                            ${prof.rubroPosition && prof.rubros ? `<br><small>‚≠ê #${prof.rubroPosition} en ${prof.rubros[0]}</small>` : ''}
                        </td>
                        <td>
                            <strong style="font-size: 1.2rem;">${prof.rankingScore || 0}</strong>/100
                            <div class="ranking-progress">
                                <div class="ranking-progress-bar" style="width: ${prof.rankingScore || 0}%"></div>
                            </div>
                        </td>
                        <td>
                            ${getRankingBadge(prof.rankingLevel || 'Principiante')}
                        </td>
                        <td>
                            <strong>${prof.averageRating ? prof.averageRating.toFixed(1) : '0.0'}</strong> ‚≠ê<br>
                            <small>${prof.totalRatings || 0} calificaciones</small>
                        </td>
                        <td>
                            <small>
                                ‚≠ê ${prof.rankingScore >= 25 ? '25' : prof.rankingScore}/25<br>
                                üöÄ ${prof.avgResponseTime || 'N/A'}<br>
                                üìù ${prof.profileCompleted ? 'Completo' : 'Incompleto'}<br>
                                ${prof.isFeatured ? 'üåü Destacado' : ''}
                            </small>
                        </td>
                        <td>
                            ${lastActive}
                        </td>
                        <td>
                            <div class="btn-group">
                                <button onclick="viewProfessionalDetail('${prof.id}')" class="btn btn-sm">üëÅ Ver</button>
                                <button onclick="recalculateProfessionalRanking('${prof.id}')" class="btn btn-warning btn-sm">üîÑ Recalcular</button>
                                ${prof.rankingScore >= rankingConfig.autoFeaturedScore && !prof.isFeatured ? 
                                    `<button onclick="activateFeatured('${prof.id}')" class="btn btn-success btn-sm">üåü Destacar</button>` : ''}
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                // Actualizar estad√≠sticas
                updateRankingStats(professionals);
                
                hideLoader();
            } catch (error) {
                console.error("Error cargando tabla de ranking:", error);
                hideLoader();
                showMessage('loginMessage', '‚ùå Error cargando ranking', 'error');
            }
        }

        function updateRankingStats(professionals) {
            const total = professionals.length;
            if (total === 0) {
                document.getElementById('rankingStats').innerHTML = '<p>No hay datos para mostrar</p>';
                return;
            }
            
            const totalScore = professionals.reduce((sum, p) => sum + (p.rankingScore || 0), 0);
            const avgScore = Math.round(totalScore / total);
            
            const top10 = professionals.filter(p => p.rankingScore >= 90).length;
            const featured = professionals.filter(p => p.isFeatured).length;
            const certified = professionals.filter(p => p.certifications && p.certifications.length > 0).length;
            
            document.getElementById('rankingStats').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                    <div style="background: white; padding: 15px; border-radius: 8px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary);">${avgScore}</div>
                        <div style="color: var(--gray);">Puntaje promedio</div>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 8px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: var(--warning);">${top10}</div>
                        <div style="color: var(--gray);">TOP 10 (90+ puntos)</div>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 8px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: var(--secondary);">${featured}</div>
                        <div style="color: var(--gray);">Destacados</div>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 8px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: var(--info);">${certified}</div>
                        <div style="color: var(--gray);">Certificados</div>
                    </div>
                </div>
            `;
        }

        // ============================================
        // PROFESIONALES
        // ============================================
        async function loadProfessionals() {
            showLoader();
            
            try {
                let query = db.collection('professionals');
                
                // Aplicar filtros
                const provinciaFilter = document.getElementById('filterProvincia').value;
                const ciudadFilter = document.getElementById('filterCiudad').value;
                const rubroFilter = document.getElementById('filterRubro').value;
                const levelFilter = document.getElementById('filterRankingLevel').value;
                const statusFilter = document.getElementById('filterStatus').value;
                
                if (provinciaFilter) {
                    query = query.where('provincia', '==', provinciaFilter);
                    
                    // Cargar ciudades de la provincia seleccionada
                    const ciudadSelect = document.getElementById('filterCiudad');
                    ciudadSelect.innerHTML = '<option value="">Todas</option>';
                    if (provinciasCiudades[provinciaFilter]) {
                        provinciasCiudades[provinciaFilter].forEach(ciudad => {
                            const option = document.createElement('option');
                            option.value = ciudad;
                            option.textContent = ciudad;
                            ciudadSelect.appendChild(option);
                        });
                    }
                }
                
                if (ciudadFilter) {
                    query = query.where('ciudad', '==', ciudadFilter);
                }
                
                if (rubroFilter) {
                    query = query.where('rubros', 'array-contains', rubroFilter);
                }
                
                if (levelFilter) {
                    query = query.where('rankingLevel', '==', levelFilter);
                }
                
                const snapshot = await query.get();
                const tbody = document.getElementById('professionalsTable');
                tbody.innerHTML = '';
                
                const now = new Date();
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const id = doc.id;
                    
                    // APLICAR FILTRO DE ESTADO
                    if (statusFilter === 'active' && !data.profileCompleted) return;
                    if (statusFilter === 'incomplete' && data.profileCompleted) return;
                    if (statusFilter === 'blocked' && !data.blocked) return;
                    if (statusFilter === 'featured') {
                        const isFeaturedActive = data.isFeatured && data.featuredUntil && data.featuredUntil.toDate() > now;
                        if (!isFeaturedActive) return;
                    }
                    if (statusFilter === 'certified' && !data.certified) return;
                    
                    const featuredActive = data.isFeatured && data.featuredUntil && data.featuredUntil.toDate() > now;
                    const photoUrl = data.photoUrl || 'https://via.placeholder.com/50x50/0a4fd8/ffffff?text=NO+FOTO';
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><img src="${photoUrl}" class="table-photo" alt="Foto" onerror="this.src='https://via.placeholder.com/50x50/0a4fd8/ffffff?text=NO+FOTO'"></td>
                        <td>
                            <strong>${data.name || 'Sin nombre'}</strong><br>
                            <small style="color: var(--gray);">${data.email || ''}</small>
                        </td>
                        <td>
                            ${data.ciudad || 'Sin ciudad'},<br>
                            ${data.provincia || 'Sin provincia'}
                        </td>
                        <td>
                            ${data.phone || 'Sin tel√©fono'}<br>
                            <small>${data.zonas ? data.zonas.join(', ') : ''}</small>
                        </td>
                        <td>${data.rubros ? data.rubros.map(r => getRubroName(r)).join(', ') : ''}</td>
                        <td>
                            <strong>${data.rankingScore || 0}/100</strong>
                        </td>
                        <td>
                            ${getRankingBadge(data.rankingLevel || 'Principiante')}
                        </td>
                        <td>
                            ${data.blocked ? '<span class="badge badge-danger">BLOQUEADO</span>' : ''}
                            ${!data.profileCompleted ? '<span class="badge badge-warning">INCOMPLETO</span>' : ''}
                            ${featuredActive ? '<span class="badge badge-success">DESTACADO</span>' : ''}
                            ${data.certified ? '<span class="badge badge-primary">CERTIFICADO</span>' : ''}
                            ${data.profileCompleted && !data.blocked && !featuredActive && !data.certified ? '<span class="badge badge-info">ACTIVO</span>' : ''}
                        </td>
                        <td>
                            <div class="btn-group">
                                <button onclick="viewProfessionalDetail('${id}')" class="btn btn-sm">üëÅ Ver</button>
                                ${featuredActive ? 
                                    `<button onclick="deactivateFeatured('${id}')" class="btn btn-warning btn-sm">‚≠ê Desactivar</button>` : 
                                    `<button onclick="activateFeatured('${id}')" class="btn btn-success btn-sm">‚≠ê Destacar</button>`
                                }
                                ${data.certified ?
                                    `<button onclick="removeCertification('${id}')" class="btn btn-warning btn-sm">‚úì Remover cert.</button>` :
                                    `<button onclick="addCertification('${id}')" class="btn btn-primary btn-sm">‚úì Certificar</button>`
                                }
                                ${data.blocked ? 
                                    `<button onclick="unblockProfessional('${id}')" class="btn btn-success btn-sm">üîì Desbloquear</button>` : 
                                    `<button onclick="blockProfessional('${id}')" class="btn btn-danger btn-sm">üö´ Bloquear</button>`
                                }
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                hideLoader();
            } catch (error) {
                console.error("Error cargando profesionales:", error);
                hideLoader();
                showMessage('loginMessage', '‚ùå Error cargando profesionales', 'error');
            }
        }

        function getRubroName(rubroKey) {
            const rubros = {
                'plomeria': 'Plomer√≠a',
                'gas': 'Gas',
                'electricidad': 'Electricidad',
                'aire': 'Aire Acondicionado',
                'albanileria': 'Alba√±iler√≠a',
                'pintura': 'Pintura',
                'cerrajeria': 'Cerrajer√≠a',
                'jardineria': 'Jardiner√≠a',
                'herreria': 'Herrer√≠a',
                'carpinteria': 'Carpinter√≠a',
                'limpieza': 'Limpieza',
                'mudanzas': 'Mudanzas',
                'otros': 'Otros servicios'
            };
            return rubros[rubroKey] || rubroKey;
        }

        // ============================================
        // CALIFICACIONES
        // ============================================
        async function loadRatings() {
            showLoader();
            
            try {
                const status = document.getElementById('filterRatingStatus').value;
                const dateFrom = document.getElementById('filterRatingDateFrom').value;
                const dateTo = document.getElementById('filterRatingDateTo').value;
                
                let query = db.collection('ratings').orderBy('createdAt', 'desc');
                
                if (status !== 'all') {
                    query = query.where('status', '==', status);
                }
                
                const snapshot = await query.limit(100).get();
                const tbody = document.getElementById('ratingsTable');
                tbody.innerHTML = '';
                
                snapshot.forEach(async doc => {
                    const rating = doc.data();
                    const id = doc.id;
                    
                    // Filtrar por fecha si es necesario
                    if (dateFrom && rating.createdAt) {
                        const ratingDate = rating.createdAt.toDate();
                        const fromDate = new Date(dateFrom);
                        if (ratingDate < fromDate) return;
                    }
                    
                    if (dateTo && rating.createdAt) {
                        const ratingDate = rating.createdAt.toDate();
                        const toDate = new Date(dateTo);
                        toDate.setHours(23, 59, 59, 999);
                        if (ratingDate > toDate) return;
                    }
                    
                    // Obtener informaci√≥n del profesional
                    let professionalName = 'Desconocido';
                    try {
                        const profDoc = await db.collection('professionals').doc(rating.professionalId).get();
                        if (profDoc.exists) {
                            professionalName = profDoc.data().name || 'Desconocido';
                        }
                    } catch (error) {
                        console.error('Error obteniendo profesional:', error);
                    }
                    
                    const date = rating.createdAt ? 
                        rating.createdAt.toDate().toLocaleDateString('es-AR') : 'Fecha desconocida';
                    const stars = '‚≠ê'.repeat(rating.rating) + '‚òÜ'.repeat(5 - rating.rating);
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${date}</td>
                        <td>${professionalName}</td>
                        <td>${rating.clientPhone || 'No especificado'}</td>
                        <td>
                            <div style="font-size: 1.2rem; color: var(--warning);">${stars}</div>
                            <small>${rating.rating}/5</small>
                        </td>
                        <td>
                            ${rating.comment ? 
                                `<div style="max-width: 300px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${rating.comment}</div>` : 
                                '<span style="color: var(--gray); font-style: italic;">Sin comentario</span>'
                            }
                        </td>
                        <td>
                            ${rating.status === 'approved' ? '<span class="badge badge-success">APROBADA</span>' : 
                              rating.status === 'rejected' ? '<span class="badge badge-danger">RECHAZADA</span>' : 
                              '<span class="badge badge-warning">PENDIENTE</span>'}
                        </td>
                        <td>
                            <div class="btn-group">
                                ${rating.clientPhone ? 
                                    `<button onclick="contactClientByWhatsApp('${rating.clientPhone}', '${professionalName}')" class="btn btn-success btn-sm">üì± Verificar</button>` : 
                                    ''
                                }
                                ${rating.status === 'pending' ? 
                                    `<button onclick="approveRating('${id}')" class="btn btn-success btn-sm">‚úÖ Aprobar</button>
                                     <button onclick="rejectRating('${id}')" class="btn btn-danger btn-sm">‚ùå Rechazar</button>` : 
                                    `<button onclick="deleteRating('${id}')" class="btn btn-danger btn-sm">üóë Eliminar</button>`
                                }
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                hideLoader();
            } catch (error) {
                console.error("Error cargando calificaciones:", error);
                hideLoader();
                showMessage('loginMessage', '‚ùå Error cargando calificaciones', 'error');
            }
        }

        function contactClientByWhatsApp(phone, professionalName) {
            const message = `Hola, soy de TecniYa. Estamos verificando tu calificaci√≥n para el profesional ${professionalName}. ¬øPodr√≠as confirmar si realizaste el servicio?`;
            window.open(`https://wa.me/${phone}?text=${encodeURIComponent(message)}`, '_blank');
        }

        async function approveRating(ratingId) {
            if (confirm('¬øAprobar esta calificaci√≥n?')) {
                try {
                    await db.collection('ratings').doc(ratingId).update({
                        status: 'approved',
                        approvedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    loadRatings();
                    showMessage('loginMessage', '‚úÖ Calificaci√≥n aprobada', 'success');
                } catch (error) {
                    showMessage('loginMessage', '‚ùå Error aprobando calificaci√≥n', 'error');
                }
            }
        }

        async function rejectRating(ratingId) {
            if (confirm('¬øRechazar esta calificaci√≥n?')) {
                try {
                    await db.collection('ratings').doc(ratingId).update({
                        status: 'rejected',
                        rejectedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    loadRatings();
                    showMessage('loginMessage', '‚úÖ Calificaci√≥n rechazada', 'success');
                } catch (error) {
                    showMessage('loginMessage', '‚ùå Error rechazando calificaci√≥n', 'error');
                }
            }
        }

        async function deleteRating(ratingId) {
            if (confirm('¬øEliminar permanentemente esta calificaci√≥n?')) {
                try {
                    await db.collection('ratings').doc(ratingId).delete();
                    loadRatings();
                    showMessage('loginMessage', '‚úÖ Calificaci√≥n eliminada', 'success');
                } catch (error) {
                    showMessage('loginMessage', '‚ùå Error eliminando calificaci√≥n', 'error');
                }
            }
        }

        // ============================================
        // BANNERS - FUNCIONES MEJORADAS CON EDICI√ìN
        // ============================================
        async function loadBanners() {
            showLoader();
            
            try {
                const snapshot = await db.collection('banners').orderBy('createdAt', 'desc').get();
                const tbody = document.getElementById('bannersTable');
                tbody.innerHTML = '';
                
                const now = new Date();
                
                snapshot.forEach(async doc => {
                    const data = doc.data();
                    const id = doc.id;
                    
                    // CONTAR CLICKS
                    const clicksSnapshot = await db.collection('ads_clicks')
                        .where('bannerId', '==', id)
                        .get();
                    
                    const clicks = clicksSnapshot.size;
                    const active = data.active && data.startDate && data.endDate && 
                                   data.startDate.toDate() <= now && data.endDate.toDate() >= now;
                    
                    // Determinar √°mbito
                    let ambito = 'Local';
                    if (data.ambito === 'nacional') {
                        ambito = 'Nacional';
                    } else if (data.ambito === 'provincial') {
                        ambito = 'Provincial';
                    }
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            ${data.imageUrl ? 
                                `<img src="${data.imageUrl}" style="width: 100px; height: 50px; object-fit: cover; border-radius: 6px;" 
                                      onerror="this.src='https://via.placeholder.com/100x50/0a4fd8/ffffff?text=BANNER'">` : 
                                '<img src="https://via.placeholder.com/100x50/0a4fd8/ffffff?text=SIN+IMAGEN" style="border-radius: 6px;">'
                            }
                        </td>
                        <td>
                            <strong>${data.title || 'Sin t√≠tulo'}</strong><br>
                            <small style="color: var(--gray);">${ambito} - ${data.provincia || 'Nacional'}${data.ciudad && data.ciudad !== 'toda' ? ', ' + data.ciudad : ''}</small>
                        </td>
                        <td>
                            ${ambito}<br>
                            <small>${data.provincia === 'toda' ? 'Todo el pa√≠s' : data.provincia}${data.ciudad && data.ciudad !== 'toda' ? ', ' + data.ciudad : ''}</small>
                        </td>
                        <td>
                            ${data.startDate ? data.startDate.toDate().toLocaleDateString('es-AR') : ''}<br>
                            al ${data.endDate ? data.endDate.toDate().toLocaleDateString('es-AR') : ''}
                        </td>
                        <td>
                            ${active ? '<span class="badge badge-success">ACTIVO</span>' : '<span class="badge badge-danger">INACTIVO</span>'}
                            <br><small>Prioridad: ${data.priority || 5}</small>
                        </td>
                        <td>${clicks}</td>
                        <td>
                            <div class="btn-group">
                                <button onclick="editBanner('${id}')" class="btn btn-sm">‚úèÔ∏è Editar</button>
                                <button onclick="deleteBanner('${id}')" class="btn btn-danger btn-sm">üóë Eliminar</button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                hideLoader();
            } catch (error) {
                console.error("Error cargando banners:", error);
                hideLoader();
                showMessage('loginMessage', '‚ùå Error cargando banners', 'error');
            }
        }

        // Funci√≥n para mostrar formulario de banner (nuevo o edici√≥n)
        async function showBannerForm(bannerId = null) {
            document.getElementById('bannerForm').style.display = 'block';
            
            // Cargar provincias en el select
            const provinciaSelect = document.getElementById('bannerProvincia');
            provinciaSelect.innerHTML = '<option value="">Seleccion√° provincia</option>';
            Object.keys(provinciasCiudades).sort().forEach(provincia => {
                const option = document.createElement('option');
                option.value = provincia;
                option.textContent = provincia;
                provinciaSelect.appendChild(option);
            });
            
            // Cargar ciudades cuando se selecciona provincia
            provinciaSelect.addEventListener('change', function() {
                const ciudadSelect = document.getElementById('bannerCiudad');
                ciudadSelect.innerHTML = '<option value="">Seleccion√° ciudad</option>';
                
                if (this.value && provinciasCiudades[this.value]) {
                    ciudadSelect.disabled = false;
                    provinciasCiudades[this.value].forEach(ciudad => {
                        const option = document.createElement('option');
                        option.value = ciudad;
                        option.textContent = ciudad;
                        ciudadSelect.appendChild(option);
                    });
                } else {
                    ciudadSelect.disabled = true;
                }
            });
            
            if (bannerId) {
                // Modo edici√≥n
                document.getElementById('bannerFormTitle').textContent = 'Editar Banner';
                document.getElementById('bannerId').value = bannerId;
                
                // Cargar datos del banner
                const doc = await db.collection('banners').doc(bannerId).get();
                if (doc.exists) {
                    const data = doc.data();
                    
                    // Llenar formulario con datos existentes
                    document.getElementById('bannerTitle').value = data.title || '';
                    document.getElementById('bannerLink').value = data.link || '';
                    document.getElementById('bannerImageUrl').value = data.imageUrl || '';
                    document.getElementById('bannerAmbito').value = data.ambito || 'nacional';
                    document.getElementById('bannerPosition').value = data.position || 'home';
                    document.getElementById('bannerStartDate').value = data.startDate ? data.startDate.toDate().toISOString().split('T')[0] : '';
                    document.getElementById('bannerEndDate').value = data.endDate ? data.endDate.toDate().toISOString().split('T')[0] : '';
                    document.getElementById('bannerPriority').value = data.priority || 5;
                    document.getElementById('bannerActive').checked = data.active !== false;
                    
                    // Llenar ubicaci√≥n
                    if (data.ambito !== 'nacional' && data.provincia && data.provincia !== 'toda') {
                        document.getElementById('bannerProvincia').value = data.provincia;
                        
                        // Disparar evento para cargar ciudades
                        const event = new Event('change');
                        document.getElementById('bannerProvincia').dispatchEvent(event);
                        
                        // Esperar un momento para cargar la ciudad
                        setTimeout(() => {
                            if (data.ciudad && data.ciudad !== 'toda') {
                                document.getElementById('bannerCiudad').value = data.ciudad;
                            }
                        }, 100);
                    }
                    
                    // Mostrar campos de ubicaci√≥n si no es nacional
                    toggleBannerLocation();
                    
                    // Limpiar checkboxes de rubros
                    document.querySelectorAll('input[name="bannerRubros"]').forEach(checkbox => {
                        checkbox.checked = false;
                    });
                    
                    // Marcar rubros seleccionados
                    if (data.rubros && Array.isArray(data.rubros)) {
                        data.rubros.forEach(rubro => {
                            const checkbox = document.querySelector(`input[name="bannerRubros"][value="${rubro}"]`);
                            if (checkbox) {
                                checkbox.checked = true;
                            }
                        });
                    }
                    
                    // Mostrar preview de imagen
                    if (data.imageUrl) {
                        const preview = document.getElementById('bannerImagePreview');
                        preview.innerHTML = `
                            <div class="banner-preview">
                                <img src="${data.imageUrl}" class="banner-preview-img" 
                                     onerror="this.src='https://via.placeholder.com/800x200/0a4fd8/ffffff?text=Imagen+no+disponible'">
                            </div>
                        `;
                    }
                }
            } else {
                // Modo nuevo
                document.getElementById('bannerFormTitle').textContent = 'Nuevo Banner';
                document.getElementById('bannerFormElement').reset();
                document.getElementById('bannerId').value = '';
                document.getElementById('bannerImagePreview').innerHTML = '';
                
                // Establecer fechas por defecto
                const today = new Date();
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 30);
                
                document.getElementById('bannerStartDate').value = today.toISOString().split('T')[0];
                document.getElementById('bannerEndDate').value = tomorrow.toISOString().split('T')[0];
            }
        }

        function hideBannerForm() {
            document.getElementById('bannerForm').style.display = 'none';
        }

        function toggleBannerLocation() {
            const ambito = document.getElementById('bannerAmbito').value;
            const locationFields = document.getElementById('bannerLocationFields');
            
            if (ambito === 'nacional') {
                locationFields.style.display = 'none';
            } else {
                locationFields.style.display = 'block';
                const ciudadSelect = document.getElementById('bannerCiudad');
                if (ambito === 'provincial') {
                    ciudadSelect.disabled = true;
                    ciudadSelect.value = 'toda';
                } else {
                    ciudadSelect.disabled = false;
                }
            }
        }

        // Funci√≥n para actualizar vista previa de banner
        document.getElementById('bannerImageUrl')?.addEventListener('input', function() {
            const url = this.value.trim();
            const preview = document.getElementById('bannerImagePreview');
            
            if (url && (url.startsWith('http://') || url.startsWith('https://'))) {
                preview.innerHTML = `
                    <div class="banner-preview">
                        <img src="${url}" class="banner-preview-img" 
                             onerror="this.src='https://via.placeholder.com/800x200/0a4fd8/ffffff?text=Imagen+no+disponible'">
                    </div>
                `;
            } else {
                preview.innerHTML = '';
            }
        });

        // Guardar banner
        document.getElementById('bannerFormElement')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const bannerData = {
                title: document.getElementById('bannerTitle').value,
                link: document.getElementById('bannerLink').value,
                imageUrl: document.getElementById('bannerImageUrl').value,
                ambito: document.getElementById('bannerAmbito').value,
                position: document.getElementById('bannerPosition').value,
                provincia: document.getElementById('bannerAmbito').value === 'nacional' ? 'toda' : document.getElementById('bannerProvincia').value,
                ciudad: document.getElementById('bannerAmbito').value === 'local' ? document.getElementById('bannerCiudad').value : 'toda',
                startDate: new Date(document.getElementById('bannerStartDate').value),
                endDate: new Date(document.getElementById('bannerEndDate').value),
                priority: parseInt(document.getElementById('bannerPriority').value),
                active: document.getElementById('bannerActive').checked,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            // Obtener rubros seleccionados
            const selectedRubros = [];
            document.querySelectorAll('input[name="bannerRubros"]:checked').forEach(checkbox => {
                selectedRubros.push(checkbox.value);
            });
            bannerData.rubros = selectedRubros;
            
            showLoader();
            
            try {
                const bannerId = document.getElementById('bannerId').value;
                
                if (bannerId) {
                    // Actualizar banner existente
                    await db.collection('banners').doc(bannerId).update(bannerData);
                    showMessage('loginMessage', '‚úÖ Banner actualizado correctamente', 'success');
                } else {
                    // Crear nuevo banner
                    bannerData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    await db.collection('banners').add(bannerData);
                    showMessage('loginMessage', '‚úÖ Banner creado correctamente', 'success');
                }
                
                hideBannerForm();
                loadBanners();
                
            } catch (error) {
                console.error('Error guardando banner:', error);
                showMessage('loginMessage', '‚ùå Error guardando banner: ' + error.message, 'error');
            } finally {
                hideLoader();
            }
        });

        // Funci√≥n para editar banner
        window.editBanner = function(bannerId) {
            showBannerForm(bannerId);
        };

        // Funci√≥n para eliminar banner
        window.deleteBanner = function(bannerId) {
            if (confirm('¬øEst√°s seguro de eliminar este banner? Esta acci√≥n no se puede deshacer.')) {
                showLoader();
                db.collection('banners').doc(bannerId).delete()
                    .then(() => {
                        hideLoader();
                        showMessage('loginMessage', '‚úÖ Banner eliminado correctamente', 'success');
                        loadBanners();
                    })
                    .catch(error => {
                        hideLoader();
                        showMessage('loginMessage', '‚ùå Error eliminando banner: ' + error.message, 'error');
                    });
            }
        };

        // ============================================
        // CONFIGURACI√ìN
        // ============================================
        async function loadConfig() {
            try {
                const doc = await db.collection('admin_config').doc('ranking').get();
                if (doc.exists) {
                    const data = doc.data();
                    rankingConfig.minScore = data.minScore || 30;
                    rankingConfig.autoFeaturedScore = data.autoFeaturedScore || 85;
                    rankingConfig.activeDays = data.activeDays || 30;
                    
                    document.getElementById('minRankingScore').value = rankingConfig.minScore;
                    document.getElementById('autoFeaturedScore').value = rankingConfig.autoFeaturedScore;
                    document.getElementById('activeDaysThreshold').value = rankingConfig.activeDays;
                }
                
                const pricingDoc = await db.collection('admin_config').doc('pricing').get();
                if (pricingDoc.exists) {
                    const data = pricingDoc.data();
                    document.getElementById('featuredPrice').value = data.featuredPrice || 9000;
                    document.getElementById('certificationPrice').value = data.certificationPrice || 5000;
                }
            } catch (error) {
                console.error("Error cargando configuraci√≥n:", error);
            }
        }

        async function updateRankingConfig() {
            try {
                rankingConfig.minScore = parseInt(document.getElementById('minRankingScore').value) || 30;
                rankingConfig.autoFeaturedScore = parseInt(document.getElementById('autoFeaturedScore').value) || 85;
                rankingConfig.activeDays = parseInt(document.getElementById('activeDaysThreshold').value) || 30;
                
                await db.collection('admin_config').doc('ranking').set(rankingConfig, { merge: true });
                showMessage('loginMessage', '‚úÖ Configuraci√≥n de ranking actualizada', 'success');
            } catch (error) {
                showMessage('loginMessage', '‚ùå Error actualizando configuraci√≥n: ' + error.message, 'error');
            }
        }

        async function updatePrices() {
            try {
                const featuredPrice = parseInt(document.getElementById('featuredPrice').value) || 9000;
                const certificationPrice = parseInt(document.getElementById('certificationPrice').value) || 5000;
                
                await db.collection('admin_config').doc('pricing').set({
                    featuredPrice,
                    certificationPrice,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                
                showMessage('loginMessage', '‚úÖ Precios actualizados', 'success');
            } catch (error) {
                showMessage('loginMessage', '‚ùå Error actualizando precios: ' + error.message, 'error');
            }
        }

        // ============================================
        // FUNCIONES AUXILIARES
        // ============================================
        async function recalculateProfessionalRanking(professionalId) {
            showLoader();
            
            try {
                const doc = await db.collection('professionals').doc(professionalId).get();
                if (!doc.exists) {
                    alert('Profesional no encontrado');
                    return;
                }
                
                const professional = { id: doc.id, ...doc.data() };
                const updatedData = await calculateProfessionalRanking(professional);
                
                await db.collection('professionals').doc(professionalId).update({
                    averageRating: updatedData.averageRating,
                    totalRatings: updatedData.totalRatings,
                    rankingScore: updatedData.rankingScore,
                    rankingLevel: updatedData.rankingLevel,
                    rankingUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                hideLoader();
                showMessage('loginMessage', `‚úÖ Ranking recalculado: ${updatedData.rankingScore} puntos (${updatedData.rankingLevel})`, 'success');
                
                const activeTab = document.querySelector('.tab.active').dataset.tab;
                if (activeTab === 'ranking') {
                    loadRankingTable();
                } else if (activeTab === 'professionals') {
                    loadProfessionals();
                }
                
            } catch (error) {
                hideLoader();
                showMessage('loginMessage', '‚ùå Error recalculando ranking: ' + error.message, 'error');
            }
        }

        function filterByLevel(level) {
            // Cambiar a la pesta√±a de ranking y aplicar filtro
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            
            document.querySelector('.tab[data-tab="ranking"]').classList.add('active');
            document.getElementById('rankingPanel').classList.add('active');
            
            document.getElementById('filterRankingLevelTable').value = level;
            loadRankingTable();
        }

        // ============================================
        // FUNCIONES DE GESTI√ìN DE PROFESIONALES
        // ============================================
        window.viewProfessionalDetail = async function(id) {
            const doc = await db.collection('professionals').doc(id).get();
            if (!doc.exists) return;
            
            const data = doc.data();
            const now = new Date();
            const featuredActive = data.isFeatured && data.featuredUntil && data.featuredUntil.toDate() > now;
            
            let html = `
                <div style="display: flex; gap: 30px; margin-bottom: 30px;">
                    <div>
                        <img src="${data.photoUrl || 'https://via.placeholder.com/150x150/0a4fd8/ffffff?text=NO+FOTO'}" 
                             style="width: 150px; height: 150px; object-fit: cover; border-radius: 12px;"
                             onerror="this.src='https://via.placeholder.com/150x150/0a4fd8/ffffff?text=NO+FOTO'">
                    </div>
                    <div>
                        <h4>${data.name || 'Sin nombre'}</h4>
                        <p><strong>üìç Ubicaci√≥n:</strong> ${data.ciudad || ''}, ${data.provincia || ''}</p>
                        <p><strong>üìû Tel√©fono:</strong> ${data.phone || 'No especificado'}</p>
                        <p><strong>üìß Email:</strong> ${data.email || 'No especificado'}</p>
                        <p><strong>‚≠ê Rating:</strong> ${data.averageRating || '0'} (${data.totalRatings || 0} calificaciones)</p>
                        <p><strong>üèÜ Ranking:</strong> ${data.rankingScore || 0}/100 - ${getRankingBadge(data.rankingLevel || 'Principiante')}</p>
                        <p><strong>‚úÖ Trabajos completados:</strong> ${data.completedJobs || '0'}</p>
                        <p><strong>üìÖ Registrado:</strong> ${data.createdAt ? data.createdAt.toDate().toLocaleDateString('es-AR') : 'No disponible'}</p>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <p><strong>Rubros:</strong> ${data.rubros ? data.rubros.map(r => getRubroName(r)).join(', ') : ''}</p>
                    <p><strong>Zonas:</strong> ${data.zonas ? data.zonas.join(', ') : ''}</p>
                    <p><strong>Descripci√≥n:</strong> ${data.bio || 'Sin descripci√≥n'}</p>
                    <p><strong>Certificaciones:</strong> ${data.certifications ? data.certifications.join(', ') : 'Ninguna'}</p>
                    <p><strong>Experiencia:</strong> ${data.experienceYears || 0} a√±os</p>
                    <p><strong>Tiempo de respuesta:</strong> ${data.avgResponseTime || 'No especificado'} horas</p>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 12px;">
                        <h5>Estado del perfil</h5>
                        <p>${data.profileCompleted ? '‚úÖ COMPLETO' : '‚ùå INCOMPLETO'}</p>
                        <p>${data.blocked ? 'üö´ BLOQUEADO' : '‚úÖ ACTIVO'}</p>
                        <p>${data.certified ? '‚úÖ CERTIFICADO' : '‚ùå NO CERTIFICADO'}</p>
                    </div>
                    
                    <div style="background: ${featuredActive ? '#fff3cd' : '#f8f9fa'}; padding: 20px; border-radius: 12px;">
                        <h5>Servicio destacado</h5>
                        <p>${featuredActive ? '‚úÖ ACTIVO' : '‚ùå INACTIVO'}</p>
                        ${data.featuredUntil ? 
                            `<p><strong>V√°lido hasta:</strong> ${data.featuredUntil.toDate().toLocaleDateString('es-AR')}</p>` : 
                            ''
                        }
                    </div>
                </div>
                
                <div class="btn-group" style="margin-top: 30px;">
                    <button onclick="contactProfessional('${data.phone}')" class="btn btn-success">üì± Contactar por WhatsApp</button>
                    <button onclick="closeModal()" class="btn">Cerrar</button>
                </div>
            `;
            
            document.getElementById('professionalDetailContent').innerHTML = html;
            document.getElementById('professionalDetailModal').style.display = 'block';
        };

        window.closeModal = function() {
            document.getElementById('professionalDetailModal').style.display = 'none';
        };

        window.contactProfessional = function(phone) {
            if (phone) {
                window.open(`https://wa.me/${phone}`, '_blank');
            }
        };

        window.blockProfessional = async function(id) {
            if (confirm('¬øEst√°s seguro de bloquear a este profesional? No podr√° acceder a su panel.')) {
                await db.collection('professionals').doc(id).update({ blocked: true });
                loadProfessionals();
                showMessage('loginMessage', '‚úÖ Profesional bloqueado', 'success');
            }
        };

        window.unblockProfessional = async function(id) {
            await db.collection('professionals').doc(id).update({ blocked: false });
            loadProfessionals();
            showMessage('loginMessage', '‚úÖ Profesional desbloqueado', 'success');
        };

        window.addCertification = async function(id) {
            if (confirm('¬øCertificar a este profesional? Esto le dar√° mayor visibilidad.')) {
                await db.collection('professionals').doc(id).update({ 
                    certified: true,
                    certifiedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                loadProfessionals();
                showMessage('loginMessage', '‚úÖ Profesional certificado', 'success');
            }
        };

        window.removeCertification = async function(id) {
            if (confirm('¬øRemover certificaci√≥n a este profesional?')) {
                await db.collection('professionals').doc(id).update({ 
                    certified: false,
                    certifiedAt: null
                });
                loadProfessionals();
                showMessage('loginMessage', '‚úÖ Certificaci√≥n removida', 'success');
            }
        };

        window.activateFeatured = async function(id) {
            const months = prompt('¬øPor cu√°ntos meses activar el servicio destacado?', '1');
            if (!months || isNaN(months) || months < 1) return;
            
            const now = new Date();
            const featuredUntil = new Date(now.setMonth(now.getMonth() + parseInt(months)));
            
            await db.collection('professionals').doc(id).update({
                isFeatured: true,
                featuredUntil: featuredUntil,
                featuredAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            loadProfessionals();
            showMessage('loginMessage', '‚úÖ Servicio destacado activado', 'success');
        };

        window.deactivateFeatured = async function(id) {
            if (confirm('¬øDesactivar servicio destacado?')) {
                await db.collection('professionals').doc(id).update({
                    isFeatured: false,
                    featuredUntil: null,
                    featuredAt: null
                });
                loadProfessionals();
                showMessage('loginMessage', '‚úÖ Servicio destacado desactivado', 'success');
            }
        };

        // ============================================
        // HERRAMIENTAS ADMIN
        // ============================================
        window.forceHideNoPhoto = async function() {
            if (confirm('¬øOcultar profesionales sin foto? Esto los marcar√° como perfil incompleto.')) {
                showLoader();
                
                const snapshot = await db.collection('professionals').where('photoUrl', '==', '').get();
                const batch = db.batch();
                
                snapshot.forEach(doc => {
                    batch.update(doc.ref, { profileCompleted: false });
                });
                
                await batch.commit();
                hideLoader();
                showMessage('loginMessage', `‚úÖ ${snapshot.size} profesionales actualizados`, 'success');
                loadProfessionals();
            }
        };

        window.deactivateExpiredFeatured = async function() {
            showLoader();
            
            const now = new Date();
            const snapshot = await db.collection('professionals')
                .where('isFeatured', '==', true)
                .get();
            
            const batch = db.batch();
            let count = 0;
            
            snapshot.forEach(doc => {
                const data = doc.data();
                if (data.featuredUntil && data.featuredUntil.toDate() < now) {
                    batch.update(doc.ref, { 
                        isFeatured: false,
                        featuredUntil: null 
                    });
                    count++;
                }
            });
            
            await batch.commit();
            hideLoader();
            showMessage('loginMessage', `‚úÖ ${count} destacados vencidos desactivados`, 'success');
            loadProfessionals();
        };

        // ============================================
        // EXPORTAR DATOS
        // ============================================
        window.exportProfessionals = async function() {
            const snapshot = await db.collection('professionals').get();
            const data = [];
            
            snapshot.forEach(doc => {
                const docData = doc.data();
                data.push({ 
                    id: doc.id, 
                    ...docData,
                    createdAt: docData.createdAt ? docData.createdAt.toDate().toISOString() : null,
                    lastActive: docData.lastActive ? docData.lastActive.toDate().toISOString() : null,
                    featuredUntil: docData.featuredUntil ? docData.featuredUntil.toDate().toISOString() : null
                });
            });
            
            downloadJSON(data, 'profesionales_tecniya.json');
        };

        window.exportQuotes = async function() {
            const snapshot = await db.collection('quotes').get();
            const data = [];
            
            snapshot.forEach(doc => {
                const quoteData = doc.data();
                data.push({ 
                    id: doc.id, 
                    ...quoteData,
                    createdAt: quoteData.createdAt ? quoteData.createdAt.toDate().toISOString() : null
                });
            });
            
            downloadJSON(data, 'presupuestos_tecniya.json');
        };

        window.exportBanners = async function() {
            const snapshot = await db.collection('banners').get();
            const data = [];
            
            snapshot.forEach(doc => {
                const bannerData = doc.data();
                data.push({ 
                    id: doc.id, 
                    ...bannerData,
                    createdAt: bannerData.createdAt ? bannerData.createdAt.toDate().toISOString() : null,
                    startDate: bannerData.startDate ? bannerData.startDate.toDate().toISOString() : null,
                    endDate: bannerData.endDate ? bannerData.endDate.toDate().toISOString() : null
                });
            });
            
            downloadJSON(data, 'banners_tecniya.json');
        };

        window.exportRankingData = function() {
            if (allProfessionalsData.length === 0) {
                showMessage('loginMessage', 'No hay datos de ranking para exportar', 'error');
                return;
            }
            
            const rankingData = allProfessionalsData.map(prof => ({
                nombre: prof.name,
                email: prof.email,
                ciudad: prof.ciudad,
                provincia: prof.provincia,
                rubros: prof.rubros ? prof.rubros.join(', ') : '',
                rankingScore: prof.rankingScore || 0,
                rankingLevel: prof.rankingLevel || 'Principiante',
                averageRating: prof.averageRating || 0,
                totalRatings: prof.totalRatings || 0,
                trabajosCompletados: prof.completedJobs || 0,
                experiencia: prof.experienceYears || 0,
                certificado: prof.certified ? 'S√≠' : 'No',
                destacado: prof.isFeatured ? 'S√≠' : 'No',
                posicionCiudad: prof.cityPosition || 'N/A',
                posicionRubro: prof.rubroPosition || 'N/A'
            }));
            
            downloadJSON(rankingData, 'ranking_tecniya.json');
        };

        function downloadJSON(data, filename) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showMessage('loginMessage', `‚úÖ Datos exportados a ${filename}`, 'success');
        }

        // ============================================
        // FUNCIONES DE UTILIDAD
        // ============================================
        function showLoader() {
            document.getElementById('loader').style.display = 'block';
        }

        function hideLoader() {
            document.getElementById('loader').style.display = 'none';
        }

        function showMessage(elementId, text, type) {
            const el = document.getElementById(elementId);
            el.textContent = text;
            el.className = `message message-${type}`;
            el.style.display = 'block';
            
            setTimeout(() => {
                el.style.display = 'none';
            }, 5000);
        }

        // Funci√≥n para cargar provincias en selects
        function loadProvinciasSelect() {
            const selects = [
                'filterProvincia',
                'filterRankingProvincia',
                'bannerProvincia'
            ];
            
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    // Ordenar provincias alfab√©ticamente
                    const provinciasOrdenadas = Object.keys(provinciasCiudades).sort();
                    
                    provinciasOrdenadas.forEach(provincia => {
                        const option = document.createElement('option');
                        option.value = provincia;
                        option.textContent = provincia;
                        select.appendChild(option);
                    });
                }
            });
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            // Login
            document.getElementById('loginBtn').addEventListener('click', async () => {
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                
                try {
                    await auth.signInWithEmailAndPassword(email, password);
                } catch (error) {
                    showMessage('loginMessage', '‚ùå Error: ' + error.message, 'error');
                }
            });

            // Logout
            document.getElementById('logoutBtn').addEventListener('click', () => {
                auth.signOut();
            });

            // Tabs
            document.querySelectorAll('.tab:not(.tab-logout)').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
                    
                    tab.classList.add('active');
                    document.getElementById(`${tabId}Panel`).classList.add('active');
                    
                    if (tabId === 'dashboard') loadDashboard();
                    if (tabId === 'professionals') loadProfessionals();
                    if (tabId === 'ranking') loadRankingTable();
                    if (tabId === 'ratings') loadRatings();
                    if (tabId === 'banners') loadBanners();
                    if (tabId === 'config') loadConfig();
                });
            });

            // Filtros de profesionales
            document.getElementById('applyFilters').addEventListener('click', loadProfessionals);
            document.getElementById('resetFilters').addEventListener('click', () => {
                document.getElementById('filterProvincia').value = '';
                document.getElementById('filterCiudad').value = '';
                document.getElementById('filterRubro').value = '';
                document.getElementById('filterRankingLevel').value = '';
                document.getElementById('filterStatus').value = '';
                loadProfessionals();
            });

            // Filtros de ranking
            document.getElementById('applyRankingFilters').addEventListener('click', loadRankingTable);
            document.getElementById('resetRankingFilters').addEventListener('click', () => {
                document.getElementById('sortRanking').value = 'rankingScore_desc';
                document.getElementById('filterRankingLevelTable').value = '';
                document.getElementById('filterRankingProvincia').value = '';
                loadRankingTable();
            });

            // Filtros de calificaciones
            document.getElementById('applyRatingFilters').addEventListener('click', loadRatings);
            document.getElementById('resetRatingFilters').addEventListener('click', () => {
                document.getElementById('filterRatingStatus').value = 'pending';
                document.getElementById('filterRatingDateFrom').value = '';
                document.getElementById('filterRatingDateTo').value = '';
                loadRatings();
            });
        });
    </script>
</body>
</html>

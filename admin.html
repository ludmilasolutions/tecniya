<!DOCTYPE html>
<html lang="es-AR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TecniYa - Panel Administrador</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üîß</text></svg>">
    
    <style>
        :root {
            --primary: #0a4fd8;
            --primary-dark: #083bb5;
            --danger: #dc3545;
            --warning: #ffc107;
            --light: #f8f9fa;
            --dark: #333;
            --gray: #666;
            --shadow: 0 2px 5px rgba(0,0,0,0.1);
            --radius: 8px;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: sans-serif; }
        body { background-color: var(--light); color: var(--dark); line-height: 1.5; }
        .container { width: 100%; max-width: 1400px; margin: 0 auto; padding: 15px; }
        
        /* Header */
        .header { background: var(--dark); color: white; padding: 20px; text-align: center; }
        .header h1 { font-size: 1.5rem; margin-bottom: 5px; }
        
        /* Tabs */
        .tabs { display: flex; background: white; border-bottom: 1px solid #ddd; flex-wrap: wrap; }
        .tab { padding: 15px 20px; cursor: pointer; border-bottom: 2px solid transparent; }
        .tab:hover { background: #f5f5f5; }
        .tab.active { border-bottom-color: var(--danger); color: var(--danger); }
        .tab-logout { margin-left: auto; background: var(--dark); color: white; }
        
        /* Panels */
        .panel { display: none; background: white; padding: 20px; border-radius: 0 0 var(--radius) var(--radius); }
        .panel.active { display: block; }
        
        /* Login */
        .login-container { max-width: 400px; margin: 50px auto; padding: 30px; background: white; border-radius: var(--radius); }
        
        /* Forms */
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; font-weight: bold; margin-bottom: 5px; }
        .form-input, .form-select, .form-textarea { 
            width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: var(--radius); 
        }
        .form-row { display: flex; gap: 10px; }
        .form-row .form-group { flex: 1; }
        
        /* Tables */
        .data-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .data-table th, .data-table td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
        .data-table th { background: #f5f5f5; font-weight: bold; }
        .table-container { max-height: 500px; overflow-y: auto; border: 1px solid #ddd; border-radius: var(--radius); }
        .table-photo { width: 40px; height: 40px; object-fit: cover; border-radius: 4px; }
        
        /* Badges */
        .badge { display: inline-block; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem; }
        .badge-success { background: #d4edda; color: #155724; }
        .badge-warning { background: #fff3cd; color: #856404; }
        .badge-danger { background: #f8d7da; color: #721c24; }
        .badge-info { background: #d1ecf1; color: #0c5460; }
        
        /* Buttons */
        .btn { padding: 8px 16px; border-radius: var(--radius); border: none; cursor: pointer; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-warning { background: var(--warning); color: #333; }
        .btn-sm { padding: 5px 10px; font-size: 0.9rem; }
        .btn-group { display: flex; gap: 5px; flex-wrap: wrap; }
        
        /* Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
        .stat-card { background: #f8f9fa; padding: 15px; border-radius: var(--radius); text-align: center; }
        .stat-number { font-size: 2rem; font-weight: bold; color: var(--primary); }
        
        /* Messages */
        .message { padding: 10px; border-radius: var(--radius); margin-bottom: 15px; display: none; }
        .message-success { background: #d4edda; color: #155724; border-left: 4px solid #28a745; }
        .message-error { background: #f8d7da; color: #721c24; border-left: 4px solid var(--danger); }
        
        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal-content { background: white; width: 90%; max-width: 600px; margin: 50px auto; padding: 20px; border-radius: var(--radius); }
        .modal-header { display: flex; justify-content: space-between; margin-bottom: 15px; }
        .modal-close { font-size: 1.5rem; cursor: pointer; }
        
        /* Loader */
        .loader { display: none; margin: 20px auto; }
        
        /* Filters */
        .filters { background: #f8f9fa; padding: 15px; border-radius: var(--radius); margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; }
        
        @media (max-width: 768px) {
            .form-row { flex-direction: column; }
            .tabs { flex-direction: column; }
            .filters { flex-direction: column; }
            .btn-group { flex-direction: column; }
        }
    </style>
</head>
<body>
    <!-- Login -->
    <div id="loginContainer" class="login-container">
        <h2 style="text-align: center; margin-bottom: 20px;">üîê Admin TecniYa</h2>
        <div class="form-group">
            <label class="form-label">Email</label>
            <input type="email" id="loginEmail" class="form-input" placeholder="admin@tecniya.com">
        </div>
        <div class="form-group">
            <label class="form-label">Contrase√±a</label>
            <input type="password" id="loginPassword" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        </div>
        <button id="loginBtn" class="btn btn-primary" style="width: 100%;">Ingresar</button>
        <div id="loginMessage" class="message"></div>
    </div>
    
    <!-- Main Admin -->
    <div id="adminPanel" style="display: none;">
        <header class="header">
            <h1>Panel Administrador TecniYa</h1>
            <p style="opacity: 0.8;">Gesti√≥n de profesionales y ranking</p>
        </header>
        
        <div class="container">
            <!-- Tabs -->
            <div class="tabs">
                <div class="tab active" data-tab="dashboard">üìä Dashboard</div>
                <div class="tab" data-tab="professionals">üë®‚Äçüîß Profesionales</div>
                <div class="tab" data-tab="ranking">üèÜ Ranking</div>
                <div class="tab" data-tab="ratings">‚≠ê Calificaciones</div>
                <div class="tab" data-tab="banners">üì¢ Banners</div>
                <div class="tab" data-tab="config">‚öô Configuraci√≥n</div>
                <div class="tab tab-logout" id="logoutBtn">üö™ Salir</div>
            </div>
            
            <!-- Dashboard -->
            <div id="dashboardPanel" class="panel active">
                <h2 style="margin-bottom: 20px;">Dashboard Nacional</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalProfessionals">0</div>
                        <div>Total Profesionales</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="activeCities">0</div>
                        <div>Ciudades Activas</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="featuredProfessionals">0</div>
                        <div>Destacados Activos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="avgRankingScore">0</div>
                        <div>Puntaje Promedio</div>
                    </div>
                </div>
                
                <div style="margin-top: 30px;">
                    <h3 style="margin-bottom: 15px;">üìç Distribuci√≥n por Provincia</h3>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Provincia</th>
                                    <th>Profesionales</th>
                                    <th>Puntaje Prom.</th>
                                    <th>Destacados</th>
                                </tr>
                            </thead>
                            <tbody id="provinceDistribution"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Professionals -->
            <div id="professionalsPanel" class="panel">
                <h2 style="margin-bottom: 20px;">Gesti√≥n de Profesionales</h2>
                
                <div class="filters">
                    <div class="form-group" style="min-width: 150px;">
                        <select id="filterProvincia" class="form-select">
                            <option value="">Todas las provincias</option>
                        </select>
                    </div>
                    <div class="form-group" style="min-width: 150px;">
                        <select id="filterRubro" class="form-select">
                            <option value="">Todos los rubros</option>
                            <option value="plomeria">Plomer√≠a</option>
                            <option value="electricidad">Electricidad</option>
                            <option value="aire">Aire Acondicionado</option>
                            <option value="albanileria">Alba√±iler√≠a</option>
                            <option value="pintura">Pintura</option>
                            <option value="cerrajeria">Cerrajer√≠a</option>
                        </select>
                    </div>
                    <button id="applyFilters" class="btn btn-primary">Filtrar</button>
                    <button id="resetFilters" class="btn">Reiniciar</button>
                </div>
                
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Foto</th>
                                <th>Nombre</th>
                                <th>Ubicaci√≥n</th>
                                <th>Contacto</th>
                                <th>Rubros</th>
                                <th>Ranking</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="professionalsTable"></tbody>
                    </table>
                </div>
                
                <div id="professionalDetailModal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>Detalle del Profesional</h3>
                            <span class="modal-close" onclick="closeModal()">√ó</span>
                        </div>
                        <div id="professionalDetailContent"></div>
                    </div>
                </div>
            </div>
            
            <!-- Ranking -->
            <div id="rankingPanel" class="panel">
                <h2 style="margin-bottom: 20px;">üèÜ Gesti√≥n de Rankings</h2>
                
                <div class="filters">
                    <div class="form-group" style="min-width: 150px;">
                        <select id="sortRanking" class="form-select">
                            <option value="rankingScore_desc">Ranking (Alto ‚Üí Bajo)</option>
                            <option value="rankingScore_asc">Ranking (Bajo ‚Üí Alto)</option>
                            <option value="averageRating_desc">Rating (Alto ‚Üí Bajo)</option>
                        </select>
                    </div>
                    <button id="applyRankingFilters" class="btn btn-primary">Filtrar</button>
                    <button onclick="recalculateAllRankings()" class="btn btn-warning">Recalcular Rankings</button>
                </div>
                
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Pos.</th>
                                <th>Nombre</th>
                                <th>Ubicaci√≥n</th>
                                <th>Puntaje</th>
                                <th>Rating</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="rankingTable"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Ratings -->
            <div id="ratingsPanel" class="panel">
                <h2 style="margin-bottom: 20px;">‚≠ê Gesti√≥n de Calificaciones</h2>
                
                <div class="filters">
                    <div class="form-group" style="min-width: 150px;">
                        <select id="filterRatingStatus" class="form-select">
                            <option value="pending">Pendientes</option>
                            <option value="approved">Aprobadas</option>
                            <option value="rejected">Rechazadas</option>
                        </select>
                    </div>
                    <button id="applyRatingFilters" class="btn btn-primary">Filtrar</button>
                </div>
                
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Profesional</th>
                                <th>Calificaci√≥n</th>
                                <th>Comentario</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="ratingsTable"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Banners -->
            <div id="bannersPanel" class="panel">
                <h2 style="margin-bottom: 20px;">üì¢ Gesti√≥n de Banners</h2>
                
                <button class="btn btn-success" onclick="showBannerForm()" style="margin-bottom: 20px;">‚ûï Crear Nuevo Banner</button>
                
                <div id="bannerForm" style="display: none; background: #f8f9fa; padding: 20px; border-radius: var(--radius); margin-bottom: 20px;">
                    <h3 style="margin-bottom: 15px;" id="bannerFormTitle">Nuevo Banner</h3>
                    <form id="bannerFormElement">
                        <input type="hidden" id="bannerId">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">T√≠tulo</label>
                                <input type="text" id="bannerTitle" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Enlace (URL)</label>
                                <input type="url" id="bannerLink" class="form-input" required>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">URL de la imagen</label>
                            <input type="url" id="bannerImageUrl" class="form-input" required>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Fecha inicio</label>
                                <input type="date" id="bannerStartDate" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Fecha fin</label>
                                <input type="date" id="bannerEndDate" class="form-input" required>
                            </div>
                        </div>
                        
                        <div class="btn-group">
                            <button type="submit" class="btn btn-primary">üíæ Guardar</button>
                            <button type="button" class="btn" onclick="hideBannerForm()">Cancelar</button>
                        </div>
                    </form>
                </div>
                
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>T√≠tulo</th>
                                <th>Periodo</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="bannersTable"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Config -->
            <div id="configPanel" class="panel">
                <h2 style="margin-bottom: 20px;">Configuraci√≥n del Sistema</h2>
                
                <div style="margin-bottom: 30px;">
                    <h3 style="margin-bottom: 15px;">‚öô Sistema de Ranking</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Puntaje m√≠nimo</label>
                            <input type="number" id="minRankingScore" class="form-input" value="30">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Puntaje para destacado</label>
                            <input type="number" id="autoFeaturedScore" class="form-input" value="85">
                        </div>
                    </div>
                    <button onclick="updateRankingConfig()" class="btn btn-primary" style="margin-top: 10px;">Guardar</button>
                </div>
                
                <div style="border-top: 1px solid #ddd; padding-top: 20px;">
                    <h3 style="margin-bottom: 15px;">üõ† Herramientas</h3>
                    <div class="btn-group">
                        <button onclick="deactivateExpiredFeatured()" class="btn btn-warning">Desactivar destacados vencidos</button>
                        <button onclick="recalculateAllRankings()" class="btn btn-warning">Recalcular rankings</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="loader" class="loader">Cargando...</div>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <!-- Script Principal -->
    <script>
        // ============================================
        // DATOS DE PROVINCIAS
        // ============================================
        const provinciasCiudades = {
            "Buenos Aires": ["La Plata", "Mar del Plata", "Bah√≠a Blanca", "Quilmes"],
            "CABA": ["Capital Federal"],
            "C√≥rdoba": ["C√≥rdoba", "Villa Mar√≠a", "R√≠o Cuarto"],
            "Santa Fe": ["Rosario", "Santa Fe", "Rafaela"],
            "Mendoza": ["Mendoza", "San Rafael", "Godoy Cruz"],
            "Tucum√°n": ["San Miguel de Tucum√°n", "Yerba Buena"],
            "Salta": ["Salta", "San Ram√≥n de la Nueva Or√°n"],
            "Entre R√≠os": ["Paran√°", "Concordia", "Gualeguaych√∫"],
            "Corrientes": ["Corrientes", "Goya"],
            "Misiones": ["Posadas", "Ober√°"],
            "Chaco": ["Resistencia", "Barranqueras"],
            "Formosa": ["Formosa", "Clorinda"],
            "Santiago del Estero": ["Santiago del Estero", "La Banda"],
            "Jujuy": ["San Salvador de Jujuy", "Palpal√°"],
            "Catamarca": ["San Fernando del Valle de Catamarca"],
            "La Rioja": ["La Rioja", "Chilecito"],
            "San Juan": ["San Juan", "Rivadavia"],
            "San Luis": ["San Luis", "Villa Mercedes"],
            "Neuqu√©n": ["Neuqu√©n", "Cutral-C√≥"],
            "R√≠o Negro": ["Viedma", "Bariloche", "General Roca"],
            "Chubut": ["Rawson", "Comodoro Rivadavia"],
            "Santa Cruz": ["R√≠o Gallegos", "Caleta Olivia"],
            "Tierra del Fuego": ["Ushuaia", "R√≠o Grande"],
            "La Pampa": ["Santa Rosa", "General Pico"]
        };

        // ============================================
        // CONFIGURACI√ìN FIREBASE
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyBzDfYDdzmN9J_Y8gG06aqH0OtlzFhafFY",
            authDomain: "tecniya-b4206.firebaseapp.com",
            projectId: "tecniya-b4206",
            storageBucket: "tecniya-b4206.firebasestorage.app",
            messagingSenderId: "166424133304",
            appId: "1:166424133304:web:d1ad23bd4ea1af10437e4d"
        };

        // ============================================
        // VARIABLES GLOBALES
        // ============================================
        let db, auth;
        let allProfessionalsData = [];
        let rankingConfig = { minScore: 30, autoFeaturedScore: 85, activeDays: 30 };

        // ============================================
        // INICIALIZACI√ìN
        // ============================================
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        auth = firebase.auth();

        // ============================================
        // AUTENTICACI√ìN
        // ============================================
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                const adminSnapshot = await db.collection('admin_users').where('email', '==', user.email).get();
                if (!adminSnapshot.empty) {
                    document.getElementById('loginContainer').style.display = 'none';
                    document.getElementById('adminPanel').style.display = 'block';
                    loadDashboard();
                    loadProvinciasSelect();
                    loadConfig();
                } else {
                    auth.signOut();
                    showMessage('loginMessage', '‚ùå No ten√©s permisos de administrador', 'error');
                }
            } else {
                document.getElementById('loginContainer').style.display = 'block';
                document.getElementById('adminPanel').style.display = 'none';
            }
        });

        // ============================================
        // SISTEMA DE RANKING
        // ============================================
        async function calculateProfessionalRanking(professional) {
            try {
                // Obtener calificaciones aprobadas (√∫ltimos 3 meses)
                const threeMonthsAgo = new Date();
                threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
                
                const ratingsSnapshot = await db.collection('ratings')
                    .where('professionalId', '==', professional.id)
                    .where('status', '==', 'approved')
                    .where('createdAt', '>=', threeMonthsAgo)
                    .get();
                
                let totalRatings = 0;
                let sumRatings = 0;
                
                ratingsSnapshot.forEach(doc => {
                    totalRatings++;
                    sumRatings += doc.data().rating;
                });
                
                const averageRating = totalRatings > 0 ? (sumRatings / totalRatings) : 0;
                
                // Calcular puntaje
                let score = 0;
                
                // 1. Calificaciones (25 puntos)
                score += averageRating * 5;
                
                // 2. Cantidad de calificaciones (20 puntos)
                const ratingQuantity = Math.min(totalRatings, 100);
                score += ratingQuantity * 0.2;
                
                // 3. Tiempo de respuesta (15 puntos)
                if (professional.avgResponseTime) {
                    if (professional.avgResponseTime < 4) score += 15;
                    else if (professional.avgResponseTime < 8) score += 12;
                    else if (professional.avgResponseTime < 24) score += 8;
                    else if (professional.avgResponseTime < 48) score += 4;
                }
                
                // 4. Trabajos completados (10 puntos)
                if (professional.completedJobs) {
                    score += Math.min(professional.completedJobs * 0.1, 10);
                }
                
                // 5. Certificaciones (10 puntos)
                if (professional.certifications && professional.certifications.length > 0) {
                    score += Math.min(professional.certifications.length * 2, 10);
                }
                
                // 6. Completitud del perfil (20 puntos)
                let profileScore = 0;
                if (professional.photoUrl) profileScore += 5;
                if (professional.bio && professional.bio.length > 50) profileScore += 5;
                if (professional.zonas && professional.zonas.length > 0) profileScore += 5;
                if (professional.rubros && professional.rubros.length > 0) profileScore += 5;
                score += profileScore;
                
                // Ajustar score a 0-100
                score = Math.min(Math.max(score, 0), 100);
                const rankingScore = Math.round(score);
                
                // Determinar nivel
                let rankingLevel = 'Bronce';
                if (rankingScore >= 90) rankingLevel = 'Platino';
                else if (rankingScore >= 80) rankingLevel = 'Oro';
                else if (rankingScore >= 70) rankingLevel = 'Plata';
                else if (rankingScore >= 60) rankingLevel = 'Bronce';
                else rankingLevel = 'Principiante';
                
                return {
                    ...professional,
                    averageRating,
                    totalRatings,
                    rankingScore,
                    rankingLevel
                };
                
            } catch (error) {
                console.error('Error calculando ranking:', error);
                return {
                    ...professional,
                    averageRating: professional.averageRating || 0,
                    totalRatings: professional.totalRatings || 0,
                    rankingScore: professional.rankingScore || 0,
                    rankingLevel: professional.rankingLevel || 'Principiante'
                };
            }
        }

        async function recalculateAllRankings() {
            if (!confirm('¬øRecalcular todos los rankings?')) return;
            
            showLoader();
            
            try {
                const snapshot = await db.collection('professionals').get();
                let count = 0;
                
                for (const doc of snapshot.docs) {
                    try {
                        const professional = { id: doc.id, ...doc.data() };
                        const updatedData = await calculateProfessionalRanking(professional);
                        
                        await db.collection('professionals').doc(doc.id).update({
                            averageRating: updatedData.averageRating,
                            totalRatings: updatedData.totalRatings,
                            rankingScore: updatedData.rankingScore,
                            rankingLevel: updatedData.rankingLevel,
                            rankingUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        count++;
                        
                    } catch (error) {
                        console.error(`Error actualizando profesional ${doc.id}:`, error);
                    }
                }
                
                hideLoader();
                showMessage('loginMessage', `‚úÖ Rankings recalculados: ${count} profesionales`, 'success');
                
                const activeTab = document.querySelector('.tab.active').dataset.tab;
                if (activeTab === 'ranking') {
                    loadRankingTable();
                } else if (activeTab === 'dashboard') {
                    loadDashboard();
                }
                
            } catch (error) {
                hideLoader();
                showMessage('loginMessage', '‚ùå Error: ' + error.message, 'error');
            }
        }

        // ============================================
        // DASHBOARD
        // ============================================
        async function loadDashboard() {
            showLoader();
            
            try {
                const snapshot = await db.collection('professionals').get();
                allProfessionalsData = [];
                snapshot.forEach(doc => {
                    allProfessionalsData.push({ id: doc.id, ...doc.data() });
                });
                
                // Calcular estad√≠sticas
                const totalProfessionals = allProfessionalsData.filter(p => !p.blocked).length;
                
                const citiesSet = new Set();
                allProfessionalsData.forEach(p => {
                    if (p.ciudad) citiesSet.add(p.ciudad);
                });
                
                const now = new Date();
                const featuredActive = allProfessionalsData.filter(p => 
                    p.isFeatured && p.featuredUntil && p.featuredUntil.toDate() > now
                ).length;
                
                const totalScore = allProfessionalsData.reduce((sum, p) => sum + (p.rankingScore || 0), 0);
                const avgRanking = allProfessionalsData.length > 0 ? Math.round(totalScore / allProfessionalsData.length) : 0;
                
                // Actualizar estad√≠sticas
                document.getElementById('totalProfessionals').textContent = totalProfessionals;
                document.getElementById('activeCities').textContent = citiesSet.size;
                document.getElementById('featuredProfessionals').textContent = featuredActive;
                document.getElementById('avgRankingScore').textContent = avgRanking;
                
                // Distribuci√≥n por provincia
                loadProvinceDistribution();
                
                hideLoader();
            } catch (error) {
                console.error("Error cargando dashboard:", error);
                hideLoader();
                showMessage('loginMessage', '‚ùå Error cargando dashboard', 'error');
            }
        }

        function loadProvinceDistribution() {
            const distribution = {};
            const now = new Date();
            
            allProfessionalsData.forEach(prof => {
                if (prof.provincia && !prof.blocked) {
                    if (!distribution[prof.provincia]) {
                        distribution[prof.provincia] = {
                            profesionales: 0,
                            totalScore: 0,
                            destacados: 0
                        };
                    }
                    distribution[prof.provincia].profesionales++;
                    distribution[prof.provincia].totalScore += prof.rankingScore || 0;
                    
                    if (prof.isFeatured && prof.featuredUntil && prof.featuredUntil.toDate() > now) {
                        distribution[prof.provincia].destacados++;
                    }
                }
            });
            
            const tbody = document.getElementById('provinceDistribution');
            tbody.innerHTML = '';
            
            Object.keys(distribution).sort().forEach(provincia => {
                const data = distribution[provincia];
                const avgScore = data.profesionales > 0 ? Math.round(data.totalScore / data.profesionales) : 0;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${provincia}</strong></td>
                    <td>${data.profesionales}</td>
                    <td>${avgScore}/100</td>
                    <td>${data.destacados}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // ============================================
        // TABLA DE RANKING
        // ============================================
        async function loadRankingTable() {
            showLoader();
            
            try {
                const snapshot = await db.collection('professionals').get();
                let professionals = [];
                
                snapshot.forEach(doc => {
                    professionals.push({ id: doc.id, ...doc.data() });
                });
                
                // Ordenar
                const sortBy = document.getElementById('sortRanking').value;
                const [field, order] = sortBy.split('_');
                professionals.sort((a, b) => {
                    let aVal = a[field] || 0;
                    let bVal = b[field] || 0;
                    return order === 'desc' ? bVal - aVal : aVal - bVal;
                });
                
                // Actualizar tabla
                const tbody = document.getElementById('rankingTable');
                tbody.innerHTML = '';
                
                professionals.forEach((prof, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><strong>${index + 1}</strong></td>
                        <td>
                            <strong>${prof.name || 'Sin nombre'}</strong><br>
                            <small>${prof.email || ''}</small>
                        </td>
                        <td>${prof.ciudad || ''}, ${prof.provincia || ''}</td>
                        <td><strong>${prof.rankingScore || 0}</strong>/100</td>
                        <td>${prof.averageRating ? prof.averageRating.toFixed(1) : '0.0'} ‚≠ê</td>
                        <td>
                            <button onclick="viewProfessionalDetail('${prof.id}')" class="btn btn-sm">Ver</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                hideLoader();
            } catch (error) {
                console.error("Error cargando ranking:", error);
                hideLoader();
                showMessage('loginMessage', '‚ùå Error cargando ranking', 'error');
            }
        }

        // ============================================
        // PROFESIONALES
        // ============================================
        async function loadProfessionals() {
            showLoader();
            
            try {
                const provinciaFilter = document.getElementById('filterProvincia').value;
                const rubroFilter = document.getElementById('filterRubro').value;
                
                let query = db.collection('professionals');
                
                if (provinciaFilter) {
                    query = query.where('provincia', '==', provinciaFilter);
                }
                
                if (rubroFilter) {
                    query = query.where('rubros', 'array-contains', rubroFilter);
                }
                
                const snapshot = await query.get();
                const tbody = document.getElementById('professionalsTable');
                tbody.innerHTML = '';
                
                const now = new Date();
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const id = doc.id;
                    
                    const featuredActive = data.isFeatured && data.featuredUntil && data.featuredUntil.toDate() > now;
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            <img src="${data.photoUrl || getPlaceholderImage(40, 40)}" 
                                 class="table-photo"
                                 onerror="this.src='${getPlaceholderImage(40, 40)}'">
                        </td>
                        <td>
                            <strong>${data.name || 'Sin nombre'}</strong><br>
                            <small>${data.email || ''}</small>
                        </td>
                        <td>
                            ${data.ciudad || ''}, ${data.provincia || ''}
                        </td>
                        <td>${data.phone || 'Sin tel√©fono'}</td>
                        <td>${data.rubros ? data.rubros.join(', ') : ''}</td>
                        <td><strong>${data.rankingScore || 0}</strong>/100</td>
                        <td>
                            ${data.blocked ? '<span class="badge badge-danger">BLOQUEADO</span>' : ''}
                            ${!data.profileCompleted ? '<span class="badge badge-warning">INCOMPLETO</span>' : ''}
                            ${featuredActive ? '<span class="badge badge-success">DESTACADO</span>' : ''}
                        </td>
                        <td>
                            <div class="btn-group">
                                <button onclick="viewProfessionalDetail('${id}')" class="btn btn-sm">üëÅ Ver</button>
                                ${data.blocked ? 
                                    `<button onclick="unblockProfessional('${id}')" class="btn btn-success btn-sm">üîì Desbloquear</button>` : 
                                    `<button onclick="blockProfessional('${id}')" class="btn btn-danger btn-sm">üö´ Bloquear</button>`
                                }
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                hideLoader();
            } catch (error) {
                console.error("Error cargando profesionales:", error);
                hideLoader();
                showMessage('loginMessage', '‚ùå Error cargando profesionales', 'error');
            }
        }

        // ============================================
        // CALIFICACIONES
        // ============================================
        async function loadRatings() {
            showLoader();
            
            try {
                const status = document.getElementById('filterRatingStatus').value;
                let query = db.collection('ratings').orderBy('createdAt', 'desc');
                
                if (status !== 'all') {
                    query = query.where('status', '==', status);
                }
                
                const snapshot = await query.limit(100).get();
                const tbody = document.getElementById('ratingsTable');
                tbody.innerHTML = '';
                
                snapshot.forEach(async doc => {
                    const rating = doc.data();
                    const id = doc.id;
                    
                    // Obtener nombre del profesional
                    let professionalName = 'Desconocido';
                    try {
                        const profDoc = await db.collection('professionals').doc(rating.professionalId).get();
                        if (profDoc.exists) {
                            professionalName = profDoc.data().name || 'Desconocido';
                        }
                    } catch (error) {
                        console.error('Error obteniendo profesional:', error);
                    }
                    
                    const date = rating.createdAt ? 
                        rating.createdAt.toDate().toLocaleDateString('es-AR') : 'Fecha desconocida';
                    const stars = '‚≠ê'.repeat(rating.rating) + '‚òÜ'.repeat(5 - rating.rating);
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${date}</td>
                        <td>${professionalName}</td>
                        <td>
                            <div>${stars}</div>
                            <small>${rating.rating}/5</small>
                        </td>
                        <td>
                            ${rating.comment ? 
                                `<div style="max-width: 200px;">${rating.comment}</div>` : 
                                '<span style="color: var(--gray);">Sin comentario</span>'
                            }
                        </td>
                        <td>
                            ${rating.status === 'approved' ? '<span class="badge badge-success">APROBADA</span>' : 
                              rating.status === 'rejected' ? '<span class="badge badge-danger">RECHAZADA</span>' : 
                              '<span class="badge badge-warning">PENDIENTE</span>'}
                        </td>
                        <td>
                            <div class="btn-group">
                                ${rating.status === 'pending' ? 
                                    `<button onclick="approveRating('${id}')" class="btn btn-success btn-sm">‚úÖ</button>
                                     <button onclick="rejectRating('${id}')" class="btn btn-danger btn-sm">‚ùå</button>` : 
                                    `<button onclick="deleteRating('${id}')" class="btn btn-danger btn-sm">üóë</button>`
                                }
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                hideLoader();
            } catch (error) {
                console.error("Error cargando calificaciones:", error);
                hideLoader();
                showMessage('loginMessage', '‚ùå Error cargando calificaciones', 'error');
            }
        }

        // ============================================
        // BANNERS
        // ============================================
        async function loadBanners() {
            showLoader();
            
            try {
                const snapshot = await db.collection('banners').orderBy('createdAt', 'desc').get();
                const tbody = document.getElementById('bannersTable');
                tbody.innerHTML = '';
                
                const now = new Date();
                
                snapshot.forEach(async doc => {
                    const data = doc.data();
                    const id = doc.id;
                    
                    const active = data.active && data.startDate && data.endDate && 
                                   data.startDate.toDate() <= now && data.endDate.toDate() >= now;
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><strong>${data.title || 'Sin t√≠tulo'}</strong></td>
                        <td>
                            ${data.startDate ? data.startDate.toDate().toLocaleDateString('es-AR') : ''}<br>
                            al ${data.endDate ? data.endDate.toDate().toLocaleDateString('es-AR') : ''}
                        </td>
                        <td>
                            ${active ? '<span class="badge badge-success">ACTIVO</span>' : '<span class="badge badge-danger">INACTIVO</span>'}
                        </td>
                        <td>
                            <button onclick="editBanner('${id}')" class="btn btn-sm">‚úèÔ∏è Editar</button>
                            <button onclick="deleteBanner('${id}')" class="btn btn-danger btn-sm">üóë Eliminar</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                hideLoader();
            } catch (error) {
                console.error("Error cargando banners:", error);
                hideLoader();
                showMessage('loginMessage', '‚ùå Error cargando banners', 'error');
            }
        }

        // ============================================
        // FUNCIONES DE BANNERS
        // ============================================
        window.showBannerForm = function(bannerId = null) {
            const form = document.getElementById('bannerForm');
            const title = document.getElementById('bannerFormTitle');
            
            if (bannerId) {
                title.textContent = 'Editar Banner';
                loadBannerData(bannerId);
            } else {
                title.textContent = 'Nuevo Banner';
                document.getElementById('bannerFormElement').reset();
                document.getElementById('bannerId').value = '';
                
                // Establecer fechas por defecto
                const today = new Date().toISOString().split('T')[0];
                const nextMonth = new Date();
                nextMonth.setMonth(nextMonth.getMonth() + 1);
                const nextMonthStr = nextMonth.toISOString().split('T')[0];
                
                document.getElementById('bannerStartDate').value = today;
                document.getElementById('bannerEndDate').value = nextMonthStr;
            }
            
            form.style.display = 'block';
        };

        window.hideBannerForm = function() {
            document.getElementById('bannerForm').style.display = 'none';
        };

        window.editBanner = function(bannerId) {
            showBannerForm(bannerId);
        };

        window.deleteBanner = function(bannerId) {
            if (confirm('¬øEliminar este banner?')) {
                db.collection('banners').doc(bannerId).delete()
                    .then(() => {
                        showMessage('loginMessage', '‚úÖ Banner eliminado', 'success');
                        loadBanners();
                    })
                    .catch(error => {
                        showMessage('loginMessage', '‚ùå Error eliminando banner', 'error');
                    });
            }
        };

        async function loadBannerData(bannerId) {
            try {
                const doc = await db.collection('banners').doc(bannerId).get();
                if (!doc.exists) return;
                
                const data = doc.data();
                document.getElementById('bannerId').value = bannerId;
                document.getElementById('bannerTitle').value = data.title || '';
                document.getElementById('bannerLink').value = data.link || '';
                document.getElementById('bannerImageUrl').value = data.imageUrl || '';
                
                if (data.startDate) {
                    document.getElementById('bannerStartDate').value = 
                        data.startDate.toDate().toISOString().split('T')[0];
                }
                
                if (data.endDate) {
                    document.getElementById('bannerEndDate').value = 
                        data.endDate.toDate().toISOString().split('T')[0];
                }
                
            } catch (error) {
                console.error('Error cargando banner:', error);
                showMessage('loginMessage', '‚ùå Error cargando banner', 'error');
            }
        }

        // ============================================
        // CONFIGURACI√ìN
        // ============================================
        async function loadConfig() {
            try {
                const doc = await db.collection('admin_config').doc('ranking').get();
                if (doc.exists) {
                    const data = doc.data();
                    rankingConfig.minScore = data.minScore || 30;
                    rankingConfig.autoFeaturedScore = data.autoFeaturedScore || 85;
                    rankingConfig.activeDays = data.activeDays || 30;
                    
                    document.getElementById('minRankingScore').value = rankingConfig.minScore;
                    document.getElementById('autoFeaturedScore').value = rankingConfig.autoFeaturedScore;
                }
            } catch (error) {
                console.error("Error cargando configuraci√≥n:", error);
            }
        }

        async function updateRankingConfig() {
            try {
                rankingConfig.minScore = parseInt(document.getElementById('minRankingScore').value) || 30;
                rankingConfig.autoFeaturedScore = parseInt(document.getElementById('autoFeaturedScore').value) || 85;
                
                await db.collection('admin_config').doc('ranking').set(rankingConfig, { merge: true });
                showMessage('loginMessage', '‚úÖ Configuraci√≥n actualizada', 'success');
            } catch (error) {
                showMessage('loginMessage', '‚ùå Error: ' + error.message, 'error');
            }
        }

        // ============================================
        // FUNCIONES DE GESTI√ìN
        // ============================================
        window.viewProfessionalDetail = async function(id) {
            const doc = await db.collection('professionals').doc(id).get();
            if (!doc.exists) return;
            
            const data = doc.data();
            const now = new Date();
            const featuredActive = data.isFeatured && data.featuredUntil && data.featuredUntil.toDate() > now;
            
            let html = `
                <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <img src="${data.photoUrl || getPlaceholderImage(100, 100)}" 
                             style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px;"
                             onerror="this.src='${getPlaceholderImage(100, 100)}'">
                    </div>
                    <div>
                        <h4>${data.name || 'Sin nombre'}</h4>
                        <p><strong>üìç Ubicaci√≥n:</strong> ${data.ciudad || ''}, ${data.provincia || ''}</p>
                        <p><strong>üìû Tel√©fono:</strong> ${data.phone || 'No especificado'}</p>
                        <p><strong>‚≠ê Rating:</strong> ${data.averageRating || '0'} (${data.totalRatings || 0} calificaciones)</p>
                        <p><strong>üèÜ Ranking:</strong> ${data.rankingScore || 0}/100</p>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <p><strong>Rubros:</strong> ${data.rubros ? data.rubros.join(', ') : ''}</p>
                    <p><strong>Descripci√≥n:</strong> ${data.bio || 'Sin descripci√≥n'}</p>
                    <p><strong>Experiencia:</strong> ${data.experienceYears || 0} a√±os</p>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h5>Estado</h5>
                    <p>${data.blocked ? 'üö´ BLOQUEADO' : '‚úÖ ACTIVO'}</p>
                    <p>${featuredActive ? '‚úÖ DESTACADO ACTIVO' : '‚ùå NO DESTACADO'}</p>
                </div>
                
                <div class="btn-group">
                    ${data.phone ? `<button onclick="contactProfessional('${data.phone}')" class="btn btn-success">üì± Contactar</button>` : ''}
                    <button onclick="closeModal()" class="btn">Cerrar</button>
                </div>
            `;
            
            document.getElementById('professionalDetailContent').innerHTML = html;
            document.getElementById('professionalDetailModal').style.display = 'block';
        };

        window.closeModal = function() {
            document.getElementById('professionalDetailModal').style.display = 'none';
        };

        window.contactProfessional = function(phone) {
            if (phone) {
                window.open(`https://wa.me/${phone}`, '_blank');
            }
        };

        window.blockProfessional = async function(id) {
            if (confirm('¬øBloquear a este profesional?')) {
                await db.collection('professionals').doc(id).update({ blocked: true });
                loadProfessionals();
                showMessage('loginMessage', '‚úÖ Profesional bloqueado', 'success');
            }
        };

        window.unblockProfessional = async function(id) {
            await db.collection('professionals').doc(id).update({ blocked: false });
            loadProfessionals();
            showMessage('loginMessage', '‚úÖ Profesional desbloqueado', 'success');
        };

        async function approveRating(ratingId) {
            if (confirm('¬øAprobar esta calificaci√≥n?')) {
                try {
                    await db.collection('ratings').doc(ratingId).update({
                        status: 'approved',
                        approvedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    loadRatings();
                    showMessage('loginMessage', '‚úÖ Calificaci√≥n aprobada', 'success');
                } catch (error) {
                    showMessage('loginMessage', '‚ùå Error aprobando calificaci√≥n', 'error');
                }
            }
        }

        async function rejectRating(ratingId) {
            if (confirm('¬øRechazar esta calificaci√≥n?')) {
                try {
                    await db.collection('ratings').doc(ratingId).update({
                        status: 'rejected',
                        rejectedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    loadRatings();
                    showMessage('loginMessage', '‚úÖ Calificaci√≥n rechazada', 'success');
                } catch (error) {
                    showMessage('loginMessage', '‚ùå Error rechazando calificaci√≥n', 'error');
                }
            }
        }

        async function deleteRating(ratingId) {
            if (confirm('¬øEliminar esta calificaci√≥n?')) {
                try {
                    await db.collection('ratings').doc(ratingId).delete();
                    loadRatings();
                    showMessage('loginMessage', '‚úÖ Calificaci√≥n eliminada', 'success');
                } catch (error) {
                    showMessage('loginMessage', '‚ùå Error eliminando calificaci√≥n', 'error');
                }
            }
        }

        window.deactivateExpiredFeatured = async function() {
            showLoader();
            
            const now = new Date();
            const snapshot = await db.collection('professionals')
                .where('isFeatured', '==', true)
                .get();
            
            const batch = db.batch();
            let count = 0;
            
            snapshot.forEach(doc => {
                const data = doc.data();
                if (data.featuredUntil && data.featuredUntil.toDate() < now) {
                    batch.update(doc.ref, { 
                        isFeatured: false,
                        featuredUntil: null 
                    });
                    count++;
                }
            });
            
            await batch.commit();
            hideLoader();
            showMessage('loginMessage', `‚úÖ ${count} destacados desactivados`, 'success');
            loadProfessionals();
        };

        // ============================================
        // FUNCIONES DE UTILIDAD
        // ============================================
        function getPlaceholderImage(width = 40, height = 40, text = 'NO+FOTO') {
            // Usar un placeholder simple
            return `data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="${width}" height="${height}" viewBox="0 0 ${width} ${height}"><rect width="${width}" height="${height}" fill="%230a4fd8"/><text x="50%" y="50%" font-family="Arial" font-size="10" fill="white" text-anchor="middle" dy=".3em">${text}</text></svg>`;
        }

        function showLoader() {
            document.getElementById('loader').style.display = 'block';
        }

        function hideLoader() {
            document.getElementById('loader').style.display = 'none';
        }

        function showMessage(elementId, text, type) {
            const el = document.getElementById(elementId);
            el.textContent = text;
            el.className = `message message-${type}`;
            el.style.display = 'block';
            
            setTimeout(() => {
                el.style.display = 'none';
            }, 3000);
        }

        function loadProvinciasSelect() {
            const selects = ['filterProvincia'];
            
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    const provinciasOrdenadas = Object.keys(provinciasCiudades).sort();
                    
                    provinciasOrdenadas.forEach(provincia => {
                        const option = document.createElement('option');
                        option.value = provincia;
                        option.textContent = provincia;
                        select.appendChild(option);
                    });
                }
            });
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            // Login
            document.getElementById('loginBtn').addEventListener('click', async () => {
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                
                try {
                    await auth.signInWithEmailAndPassword(email, password);
                } catch (error) {
                    showMessage('loginMessage', '‚ùå Error: ' + error.message, 'error');
                }
            });

            // Logout
            document.getElementById('logoutBtn').addEventListener('click', () => {
                auth.signOut();
            });

            // Tabs
            document.querySelectorAll('.tab:not(.tab-logout)').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
                    
                    tab.classList.add('active');
                    document.getElementById(`${tabId}Panel`).classList.add('active');
                    
                    if (tabId === 'dashboard') loadDashboard();
                    if (tabId === 'professionals') loadProfessionals();
                    if (tabId === 'ranking') loadRankingTable();
                    if (tabId === 'ratings') loadRatings();
                    if (tabId === 'banners') loadBanners();
                    if (tabId === 'config') loadConfig();
                });
            });

            // Filtros de profesionales
            document.getElementById('applyFilters').addEventListener('click', loadProfessionals);
            document.getElementById('resetFilters').addEventListener('click', () => {
                document.getElementById('filterProvincia').value = '';
                document.getElementById('filterRubro').value = '';
                loadProfessionals();
            });

            // Filtros de ranking
            document.getElementById('applyRankingFilters').addEventListener('click', loadRankingTable);

            // Filtros de calificaciones
            document.getElementById('applyRatingFilters').addEventListener('click', loadRatings);

            // Formulario de banner
            document.getElementById('bannerFormElement').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const bannerId = document.getElementById('bannerId').value;
                const bannerData = {
                    title: document.getElementById('bannerTitle').value,
                    link: document.getElementById('bannerLink').value,
                    imageUrl: document.getElementById('bannerImageUrl').value,
                    startDate: new Date(document.getElementById('bannerStartDate').value),
                    endDate: new Date(document.getElementById('bannerEndDate').value),
                    active: true
                };
                
                try {
                    if (bannerId) {
                        await db.collection('banners').doc(bannerId).update({
                            ...bannerData,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        showMessage('loginMessage', '‚úÖ Banner actualizado', 'success');
                    } else {
                        await db.collection('banners').add({
                            ...bannerData,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        showMessage('loginMessage', '‚úÖ Banner creado', 'success');
                    }
                    
                    hideBannerForm();
                    loadBanners();
                    
                } catch (error) {
                    showMessage('loginMessage', '‚ùå Error: ' + error.message, 'error');
                }
            });
        });
    </script>
</body>
</html>
